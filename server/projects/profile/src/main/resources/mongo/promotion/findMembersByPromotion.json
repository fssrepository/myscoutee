[
        {
            "$match": {
                "_id": "?0"
            }
        },
        {
            "$lookup": {
                "from": "events",
                "localField": "events.$id",
                "foreignField": "_id",
                "as": "events"
            }
        },
        {
            "$unwind": "$events"
        },
        {
            "$group": {
                "_id": "$events._id",
                "data": { "$first": "$events" }
            }
        },
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$gte": [ "$data.type", ":#{#offset[0]}" ] },
                        { "$gt": [ "$data.info.range.start", { "$toDate": ":#{#offset[1]}" } ] },
                        { "$gt": [ { "$ifNull": [ "$data.createdDate", "ISODate()" ] }, { "$toDate": ":#{#offset[2]}" } ] }
                    ]
                }
            }
        },
        {
            "$sort": {
                "data.info.range.start": 1,
                "data.type": 1,
                "data.createdDate": 1
            }
        },
        {
            "$lookup": {
                "from": "profiles",
                "let": { "p_id": "$data.info.members.profile.$id", "p_members": "$data.info.members" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$eq": [ "$$p_id", "$_id" ]
                            }
                        }
                    },
                    {
                        "$project": {
                            "_id": "$$p_members._id",
                            "profile": "$$ROOT",
                            "createdDate": "$$p_members.createdDate",
                            "status": "$$p_members.status"
                        }
                    }
                ],
                "as": "profiles"
            }
        },
        {
            "$unwind": "$profiles"
        },
        {
            "$group": {
                "_id": "$profiles._id",
                "data": {
                    "$first": "$profiles"
                }
            }
        },
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$gt": [ { "$ifNull": [ "$data.createdDate", "ISODate()" ] }, { "$toDate": ":#{#offset[1]}" } ] },
                        { "$in": [ "$data.status", ":#{#status}" ] },
                        { "$gte": [ "$data.status", ":#{#offset[0]}" ] }
                    ]
                }
            }
        },
        {
            "$sort": {
                "data.status": 1,
                "data.createdDate": -1
            }
        },
        {
            "$limit": "?1"
        },
        {
            "$replaceRoot": {
                "newRoot": {
                    "$mergeObjects": [ { "member": "$data" }, { "offset": ["$data.status", "$data.createdDate"] } ]
                }
            }
        }
    ]
    