[
        {
            "$match": {
                "_id": "?0"
            }
        },
        {
            "$lookup": {
                "from": "events",
                "localField": "events.$id",
                "foreignField": "_id",
                "as": "events"
            }
        },
        {
            "$unwind": "$events"
        },
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$eq": [ "$events.status", "P" ] },
                        { "$gt": [ "$events.cnt", 0 ] }
                    ]
                }
            }
        },
        {
            "$lookup": {
                "from": "likes",
                "let": { "p_id": "$events._id" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$and": [
                                    { "$eq": [ "$$p_id", "$ref" ] },
                                    { "$eq": [ "$from.$id", "?4" ] }
                                ]
                            }
                        }
                    }
                ],
                "as": "likes"
            }
        },
        {
            "$unwind": {
                "path": "$likes",
                "preserveNullAndEmptyArrays": true
            }
        },
        {
            "$group": {
                "_id": "$events._id",
                "data": { "$first": "$events" },
                "groupType": { "$first": "$groupType" },
                "promoType": { "$first": "$type" },
                "rate": { "$first": { "$ifNull": [ "$likes.rate", 0 ] } }
            }
        },
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$gt": [ "$data.info.range.start", { "$toDate": ":#{#offset[0]}" } ] },
                        { "$lte": [ "$rate", ":#{#offset[1]}" ] },
                        { "$gt": [ { "$ifNull": [ "$data.createdDate", "ISODate()" ] }, { "$toDate": ":#{#offset[2]}" } ] }
                    ]
                }
            }
        },
        {
            "$sort": {
                "data.info.range.start": 1,
                "rate": -1,
                "data.createdDate": 1
            }
        },
        { "$limit": "?1" },
        {
            "$addFields": {
                "groupKey": {
                    "$dateToString": {
                        "format": "?3",
                        "date": "$data.info.range.start"
                    }
                }
            }
        },
        {
            "$replaceRoot": {
                "newRoot": {
                    "$mergeObjects": [
                        { "event": "$data" },
                        { "groupKey": "$groupKey", "promoType": "$promoType", "rate": "$rate", "groupType": "$groupType", "offset": ["$data.info.range.start", "$rate", "$data.createdDate"] }
                    ]
                }
            }
        }
    ]
    