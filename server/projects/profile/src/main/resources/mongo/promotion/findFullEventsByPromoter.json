[
        {
            "$match": {
                "createdBy": "?0"
            }
        },
        {
            "$unwind": "$events"
        },
        {
            "$lookup": {
                "from": "events",
                "let": { "e_id": "$events.$id" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$and": [
                                    { "$eq": [ "$status", "P" ] },
                                    { "$eq": [ "$$e_id", "$ref.$id" ] }
                                ]
                            }
                        }
                    },
                    {
                        "$project": {
                            "_id": "$_id",
                            "cap": {
                                "$size": {
                                    "$filter": {
                                        "input": "$info.members",
                                        "as": "member",
                                        "cond": { "$eq": [ "$$member.status", "A" ] }
                                    }
                                }
                            },
                            "data": "$$ROOT"
                        }
                    },
                    {
                        "$match": {
                            "$expr": {
                                "$and": [
                                    { "$gte": [ "$cap", "$data.capacity.min" ] }
                                ]
                            }
                        }
                    },
                    {
                        "$replaceRoot": {
                            "newRoot": "$data"
                        }
                    }
                ],
                "as": "events"
            }
        },
        {
            "$unwind": "$events"
        },
        {
            "$replaceRoot": {
                "newRoot": "$events"
            }
        },
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$gte": [ "$info.range.start", { "$toDate": ":#{#offset[0]}" } ] },
                        { "$gt": [ "$createdDate", { "$toDate": ":#{#offset[1]}" } ] }
                    ]
                }
            }
        },
        {
            "$sort": {
                "info.range.start": 1,
                "createdDate": 1
            }
        },
        {
            "$limit": "?1"
        },
        {
            "$addFields": {
                "groupKey": {
                    "$dateToString": {
                        "format": "?3",
                        "date": "$info.range.start"
                    }
                }
            }
        },
        {
            "$replaceRoot": {
                "newRoot": {
                    "$mergeObjects": [
                        { "event": "$$ROOT" },
                        { "groupKey": "$groupKey", "sortKey": { "$toLong": "$info.range.start" }, "offset": ["$info.range.start", "$createdDate"] }
                    ]
                }
            }
        }
    ]
    