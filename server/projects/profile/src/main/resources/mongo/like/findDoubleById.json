[
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$eq": ["$createdBy.$id", "?0"] },
                        {
                            "$or": [
                                { "$eq": ["$from.$id", "?1"] },
                                { "$eq": ["$to.$id", "?1"] }
                            ]
                        },
                        { "$eq": ["$double", true] },
                        { "$eq": [{ "$ifNull": ["$ref", 0] }, 0] }
                    ]
                }
            }
        },
        {
            "$lookup": {
                "from": "profiles",
                "let": { "from_id": "$from.$id", "to_id": "$to.$id" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$or": [
                                    {
                                        "$and": [
                                            { "$eq": ["$$from_id", "$_id"] },
                                            { "$ne": ["$$from_id", "?1"] }
                                        ]
                                    },
                                    {
                                        "$and": [
                                            { "$eq": ["$$to_id", "$_id"] },
                                            { "$ne": ["$$to_id", "?1"] }
                                        ]
                                    }
                                ]
                            }
                        }
                    }
                ],
                "as": "profiles"
            }
        },
        {
            "$unwind": "$profiles"
        },
        {
            "$group": {
                "_id": "$profiles._id",
                "rate": { "$first": "$rate" },
                "data": {
                    "$first": "$profiles"
                }
            }
        },
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$gt": [{ "$ifNull": ["$data.createdDate", "ISODate()"] }, { "$toDate": ":#{#offset[0]}" }] },
                        { "$in": ["$data.status", ":#{#status}"] }
                    ]
                }
            }
        },
        {
            "$sort": {
                "data.createdDate": -1
            }
        },
        {
            "$limit": "?2"
        },
        {
            "$replaceRoot": {
                "newRoot": {
                    "$mergeObjects": [
                        { "profile": "$data" },
                        { "rate": { "$ifNull": ["$rate", 0] }, "offset": ["$data.createdDate"] }
                    ]
                }
            }
        }
    ]
    