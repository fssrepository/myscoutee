[
        {
            "$match": {
                "_id": "?0"
            }
        },
    
        {
            "$addFields": {
                "user": {
                    "$first": {
                        "$filter": {
                            "input": "$info.members",
                            "as": "member",
                            "cond": {
                                "$and": [
                                    { "$eq": ["$$member.profile.$id", "?3"] },
                                    { "$eq": ["$$member.status", "A"] }
                                ]
                            }
                        }
                    }
                }
            }
        },
    
        {
            "$unwind": "$info.members"
        },
    
        {
            "$lookup": {
                "from": "profiles",
                "let": { "p_id": "$info.members.profile.$id", "p_members": "$info.members" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$eq": ["$$p_id", "$_id"]
                            }
                        }
                    },
                    {
                        "$project": {
                            "_id": "$$p_members._id",
                            "profile": "$$ROOT",
                            "createdDate": "$$p_members.createdDate",
                            "status": "$$p_members.status"
                        }
                    }
                ],
                "as": "profiles"
            }
        },
    
        {
            "$unwind": "$profiles"
        },
    
        {
            "$group": {
                "_id": "$profiles._id",
                "data": {
                    "$first": "$profiles"
                },
                "user": {
                    "$first": "$user"
                }
            }
        },
    
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$gt": [{ "$ifNull": ["$data.createdDate", "ISODate()"] }, { "$toDate": ":#{#offset[1]}" }] },
                        { "$in": ["$data.status", ":#{#status}"] },
                        { "$gte": ["$data.status", ":#{#offset[0]}"] }
                    ]
                }
            }
        },
    
        {
            "$sort": {
                "data.status": 1,
                "data.createdDate": -1
            }
        },
    
        {
            "$limit": "?1"
        },
    
        {
            "$replaceRoot": {
                "newRoot": {
                    "$mergeObjects": [
                        { "member": "$data" },
                        { "role": { "$cond": [{ "$ifNull": ["$user", null] }, "$user.role", null] } },
                        { "offset": ["$data.status", "$data.createdDate"] }
                    ]
                }
            }
        }
    ]
    