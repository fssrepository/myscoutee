[
        {
            "$lookup": {
                "from": "likes",
                "let": { "p_id": "$_id" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$and": [
                                    { "$eq": [ "$from.$id", "?0" ] },
                                    { "$eq": [ "$$p_id", "$ref" ] }
                                ]
                            }
                        }
                    }
                ],
                "as": "likes"
            }
        },
    
        {
            "$unwind": { "path": "$likes" }
        },
    
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$gte": [ "$info.range.start", { "$toDate": ":#{#offset[0]}" } ] },
                        { "$lte": [ "$likes.rate", ":#{#offset[1]}" ] },
                        { "$gt": [ "$createdDate", { "$toDate": ":#{#offset[2]}" } ] }
                    ]
                }
            }
        },
    
        {
            "$sort": {
                "info.range.start": 1,
                "likes.rate": -1,
                "createdDate": 1
            }
        },
    
        { "$limit": "?1" },
    
        {
            "$addFields": {
                "groupKey": {
                    "$dateToString": {
                        "format": "?3",
                        "date": "$info.range.start"
                    }
                }
            }
        },
    
        {
            "$replaceRoot": {
                "newRoot": {
                    "$mergeObjects": [
                        { "event": "$$ROOT" },
                        { "groupKey": "$groupKey", "rate": "$likes.rate", "sortKey": { "$toLong": "$info.range.start" }, "offset": ["$info.range.start", "$likes.rate", "$createdDate"] }
                    ]
                }
            }
        }
    ]
    