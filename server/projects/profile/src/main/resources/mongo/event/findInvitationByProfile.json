[
        {
            "$geoNear": {
                "near": "?1",
                "spherical": true,
                "minDistance": ":#{#offset[0]}",
                "distanceField": "distance",
                "distanceMultiplier": 0.001,
                "query": {
                    "_id": { "$nin": ["?0"] },
                    "group": "?4"
                }
            }
        },
        {
            "$lookup": {
                "from": "likes",
                "let": { "p_id": "$_id" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$or": [
                                    {
                                        "$and": [
                                            { "$eq": ["$from.$id", "$$p_id"] },
                                            { "$eq": ["$to.$id", "?0"] },
                                            { "$eq": [{ "$ifNull": ["$ref", 0] }, 0] }
                                        ]
                                    },
                                    {
                                        "$and": [
                                            { "$eq": ["$to.$id", "$$p_id"] },
                                            { "$eq": ["$from.$id", "?0"] },
                                            { "$eq": [{ "$ifNull": ["$ref", 0] }, 0] }
                                        ]
                                    }
                                ]
                            }
                        }
                    },
                    {
                        "$group": {
                            "_id": "$$p_id",
                            "distance": { "$avg": "$distance" },
                            "type": {
                                "$avg": {
                                    "$switch": {
                                        "branches": [
                                            {
                                                "case": {
                                                    "$and": [
                                                        { "$eq": ["$to.$id", "?0"] },
                                                        { "$eq": ["$double", false] }
                                                    ]
                                                },
                                                "then": 2
                                            },
                                            {
                                                "case": {
                                                    "$and": [
                                                        { "$eq": ["$from.$id", "?0"] },
                                                        { "$eq": ["$double", false] }
                                                    ]
                                                },
                                                "then": 1
                                            }
                                        ],
                                        "default": 0
                                    }
                                }
                            },
                            "rate": {
                                "$sum": {
                                    "$switch": {
                                        "branches": [
                                            {
                                                "case": {
                                                    "$and": [
                                                        { "$eq": ["$createdBy.$id", "?0"] },
                                                        { "$eq": ["$double", true] }
                                                    ]
                                                },
                                                "then": "$rate"
                                            }
                                        ],
                                        "default": 0
                                    }
                                }
                            },
                            "createdDate": { "$max": "$createdDate" }
                        }
                    }
                ],
                "as": "likes"
            }
        },
        {
            "$unwind": {
                "path": "$likes",
                "preserveNullAndEmptyArrays": true
            }
        },
        {
            "$match": {
                "$expr": {
                    "$and": [
                        {
                            "$or": [
                                { "$eq": ["$status", "A"] },
                                { "$eq": ["$status", "F"] }
                            ]
                        },
                        { "$gte": [{ "$ifNull": ["$likes.distance", 0] }, ":#{#offset[1]}"] }
                    ]
                }
            }
        },
        {
            "$addFields": {
                "groupKey": { "$multiply": [{ "$floor": { "$divide": ["$distance", "?3"] } }, "?3"] }
            }
        },
        {
            "$addFields": {
                "likes.rate": { "$ifNull": ["$likes.rate", 0] }
            }
        },
        {
            "$lookup": {
                "from": "events",
                "let": { "p_id": "$_id" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$and": [
                                    { "$in": ["$$p_id", "$info.members.profile.$id"] },
                                    { "$gt": [{ "$ifNull": ["$info.range.start", "ISODate()"] }, { "$toDate": ":#{#offset[3]}" }] }
                                ]
                            }
                        }
                    },
                    {
                        "$match": {
                            "info.members": {
                                "$elemMatch": {
                                    "profile.$id": "?0",
                                    "status": "I"
                                }
                            }
                        }
                    }
                ],
                "as": "events"
            }
        },
        {
            "$unwind": { "path": "$events" }
        },
        {
            "$sort": {
                "groupKey": 1,
                "rate": -1,
                "distance": 1
            }
        },
        { "$limit": "?2" },
        {
            "$replaceRoot": {
                "newRoot": {
                    "$mergeObjects": [
                        { "event": "$events" },
                        { "groupKey": "$groupKey", "isPromotion": { "$cond": [{ "$ifNull": ["$ref", false] }, true, false] }, "offset": ["$groupKey", "$rate", "$distance", "$createdDate"] }
                    ]
                }
            }
        }
    ]
    