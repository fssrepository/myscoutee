[
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$in": [ "$_id", ":#{#eventIds}" ] }
                    ]
                }
            }
        },
        {
            "$unwind": "$info.members"
        },
        {
            "$match": {
                "$expr": { "$eq": [ "$info.members.status", "A"] }
            }
        },
        {
            "$lookup": {
                "from": "profiles",
                "let": { "p_id": "$info.members.profile.$id", "p_members": "$info.members" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$and": [
                                    { "$eq": [ "$$p_id", "$_id" ] },
                                    { "$eq": [ "$status", "A" ] }
                                ]
                            }
                        }
                    }
                ],
                "as": "profiles"
            }
        },
        {
            "$unwind": "$profiles"
        },
        {
            "$lookup": {
                "from": "users",
                "let": { "p_id": "$profiles._id" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$in": [ "$$p_id", "$profiles.$id" ]
                            }
                        }
                    }
                ],
                "as": "users"
            }
        },
        {
            "$unwind": "$users"
        },
        {
            "$lookup": {
                "from": "tokens",
                "let": { "u_id": "$users._id" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$eq": [ "$$u_id", "$uuid" ]
                            }
                        }
                    }
                ],
                "as": "tokens"
            }
        },
        {
            "$unwind": "$tokens"
        },
        {
            "$replaceRoot": {
                "newRoot": "$tokens"
            }
        }
    ]
    