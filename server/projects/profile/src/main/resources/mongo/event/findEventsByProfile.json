[
        {
            "$geoNear": {
                "near": "?1",
                "spherical": true,
                "minDistance": ":#{#offset[0]}",
                "distanceField": "distance",
                "distanceMultiplier": 0.001,
                "query": { "status": "R", "group": "?4" }
            }
        },
    
        {
            "$match": {
                "$expr": {
                    "$and": [
                        {"$gt": [{"$ifNull": ["$createdDate", "ISODate()"]}, {"$toDate": ":#{#offset[1]}"}]}
                    ]
                }
            }
        },
    
        {
            "$addFields": {
                "groupKey": {"$multiply": [{"$floor": [{"$divide": ["$distance", "?3"]}]}, "?3"]}
            }
        },
    
        {
            "$sort": {
                "groupKey": 1,
                "distance": 1,
                "createdDate": -1
            }
        },
    
        { "$limit": "?2" },
    
        {
            "$replaceRoot": {
                "newRoot": {
                    "$mergeObjects": [{"event": "$$ROOT"}, {"groupKey": "$groupKey", "offset": ["$distance", "$createdDate"]}]
                }
            }
        }
    ]
    