[
        {
            "$match": {
                "info.members": {
                    "$elemMatch": { "profile.$id": "?0", "status": ":#{#status}" }
                }
            }
        },
    
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$lt": [ "$info.range.start", { "$toDate": ":#{#offset[0]}" } ] },
                        { "$gt": [ "$createdDate", { "$toDate": ":#{#offset[1]}" } ] },
                        { "$in": [ "$status", ":#{#evtStatus}" ] }
                    ]
                }
            }
        },
    
        {
            "$sort": {
                "info.range.start": 1,
                "createdDate": -1
            }
        },
    
        { "$limit": "?1" },
    
        {
            "$addFields": {
                "groupKey": {
                    "$dateToString": {
                        "format": "?3",
                        "date": "$info.range.start"
                    }
                }
            }
        },
    
        {
            "$addFields": {
                "user": {
                    "$first": {
                        "$filter": {
                            "input": "$info.members",
                            "as": "member",
                            "cond": {
                                "$and": [
                                    { "$eq": [ "$$member.profile.$id", "?0" ] },
                                    { "$eq": [ "$$member.status", "A" ] }
                                ]
                            }
                        }
                    }
                }
            }
        },
    
        {
            "$replaceRoot": {
                "newRoot": {
                    "$mergeObjects": [
                        { "event": "$$ROOT" },
                        { "groupKey": "$groupKey", "role": { "$cond": [ { "$ifNull": [ "$user", null ] }, "$user.role", null ] }, "isPromotion": { "$cond": [ { "$ifNull": ["$ref", false] }, true, false ] }, "sortKey": { "$toLong": "$info.range.start" }, "offset": ["$info.range.start", "$createdDate"] }
                    ]
                }
            }
        }
    ]
    