[
        {
            "$match": {
                "$expr": { "$eq": ["$email", "?0"] }
            }
        },
        {
            "$unwind": "$profiles"
        },
        {
            "$lookup": {
                "from": "profiles",
                "let": { "p_id": "$profiles.$id" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$and": [
                                    { "$ne": ["$status", "D"] },
                                    { "$eq": ["$$p_id", "$_id"] }
                                ]
                            }
                        }
                    }
                ],
                "as": "profile"
            }
        },
        {
            "$unwind": "$profile"
        },
        {
            "$replaceRoot": { "newRoot": "$profile" }
        },
        {
            "$lookup": {
                "from": "roles",
                "let": { "p_id": "$_id" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": { "$eq": ["$$p_id", "$profileId"] }
                        }
                    }
                ],
                "as": "role"
            }
        },
        {
            "$unwind": "$role"
        },
        {
            "$lookup": {
                "from": "groups",
                "let": { "g_id": "$group" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": { "$eq": ["$$g_id", "$_id"] }
                        }
                    }
                ],
                "as": "group"
            }
        },
        {
            "$unwind": "$group"
        },
        {
            "$match": {
                "$expr": { "$eq": ["$role.role", "?1"] }
            }
        },
        {
            "$match": {
                "$expr": {
                    "$or": [
                        { "$eq": ["?2", true] },
                        {
                            "$and": [
                                { "$eq": ["?2", false] },
                                { "$eq": ["$group.createdBy", "?3"] }
                            ]
                        }
                    ]
                }
            }
        },
        {
            "$group": {
                "_id": "$group._id",
                "role": { "$first": "$role.role" },
                "data": { "$first": "$group" }
            }
        },
        {
            "$match": {
                "$expr": {
                    "$gt": [
                        { "$ifNull": ["$data.createdDate", "ISODate()"] },
                        { "$toDate": ":#{#offset[0]}" }
                    ]
                }
            }
        },
        {
            "$sort": {
                "data.createdDate": -1
            }
        },
        {
            "$limit": "?4"
        },
        {
            "$replaceRoot": {
                "newRoot": {
                    "$mergeObjects": [
                        { "group": "$data" },
                        { "offset": ["$data.createdDate"] }
                    ]
                }
            }
        }
    ]
    