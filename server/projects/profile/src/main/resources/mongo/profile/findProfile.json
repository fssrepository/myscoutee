[
    "{\n" +
            "        \$geoNear :\n" +
            "        {\n" +
            "            near :\n" +
            "            ?0,\n" +
            "            spherical     : true,\n" +
            "            minDistance   : :#{#offset[0]},\n" +
            "            distanceField : 'distance',\n" +
            "            distanceMultiplier: 0.001,\n" +
            "            query         : {'_id': { \$nin: [?4] }, 'gender': ?5, 'group': ?6 }\n" +
            "        }\n" +
            "}",

    "{ \n" +
            "                            \$lookup: \n" +
            "                            { \n" +
            "                                from: 'likes', \n" +
            "                                let: { p_id: '\$_id' }, \n" +
            "                                pipeline: [ \n" +
            "                                    { \n" +
            "                                        \$match: { \n" +
            "                                            \$expr:  \n" +
            "                                            { \n" +
            "                                                \$or: [ \n" +
            "                                                    { \n" +
            "                                                        \$and: [ \n" +
            "                                                            { \$eq: ['\$from.\$id', '\$\$p_id'] }, \n" +
            "                                                            { \$eq: ['\$to.\$id', ?4 ] },\n" +
            "                                                            {\n" +
            "                                                               \$eq: [{\$ifNull: [ '\$ref', 0]}, 0]\n" +
            "                                                            },\n" +
            "                                                        ] \n" +
            "                                                    }, \n" +
            "                                                    { \n" +
            "                                                        \$and: [ \n" +
            "                                                            { \$eq: ['\$to.\$id', '\$\$p_id'] }, \n" +
            "                                                            { \$eq: ['\$from.\$id', ?4 ] },\n" +
            "                                                            {\n" +
            "                                                               \$eq: [{\$ifNull: [ '\$ref', 0]}, 0]\n" +
            "                                                            },\n" +
            "                                                        ] \n" +
            "                                                    },\n" +
            "                                                ] \n" +
            "                                            }, \n" +
            "                                        } \n" +
            "                                    }, \n" +
            "                                    { \n" +
            "                                        \$group: {\n" +
            "                                            '_id': '\$\$p_id', \n" +
            "                                            'distance': { \n" +
            "                                                \$avg: '\$distance' \n" +
            "                                            },\n" +
            "                                            'ref' : {\n" +
            "                                                \$first: {\$ifNull: [ '\$ref', 0]}\n" +
            "                                            },\n" +
            "                                            'type': { \n" +
            "                                                \$avg: { \n" +
            "                                                    \$switch: { \n" +
            "                                                        branches: [ \n" +
            "                                                            {  \n" +
            "                                                                case: {  \n" +
            "                                                                    \$and: [ \n" +
            "                                                                        { \$eq: ['\$to.\$id', ?4 ] }, \n" +
            "                                                                        { \$eq: ['\$double', false] }, \n" +
            "                                                                    ] \n" +
            "                                                                }, \n" +
            "                                                                then: 2 \n" +
            "                                                            }, \n" +
            "                                                            {  \n" +
            "                                                                case: {  \n" +
            "                                                                    \$and: [ \n" +
            "                                                                        { \$eq: ['\$from.\$id', ?4 ] }, \n" +
            "                                                                        { \$eq: ['\$double', false] }, \n" +
            "                                                                    ] \n" +
            "                                                                }, \n" +
            "                                                                then: 1 \n" +
            "                                                            }, \n" +
            "                                                        ], \n" +
            "                                                        default: 0 \n" +
            "                                                    } \n" +
            "                                                } \n" +
            "                                            },\n" +
            "                                            'rate': { \n" +
            "                                                \$sum: { \n" +
            "                                                    \$switch: { \n" +
            "                                                        branches: [ \n" +
            "                                                            {  \n" +
            "                                                                case: {  \n" +
            "                                                                    \$and: [ \n" +
            "                                                                        { \$eq: ['\$createdBy.\$id', ?4 ] }, \n" +
            "                                                                        { \$eq: ['\$double', false] }, \n" +
            "                                                                    ] \n" +
            "                                                                }, \n" +
            "                                                                then: '\$rate' \n" +
            "                                                            } \n" +
            "                                                        ],\n" +
            "                                                        default: 0 \n" +
            "                                                    } \n" +
            "                                                } \n" +
            "                                            },\n" +
            "                                            'createdDate': { \n" +
            "                                                \$max: '\$createdDate' \n" +
            "                                            }, \n" +
            "                                        }, \n" +
            "                                    },\n" +
            "                                ], \n" +
            "                                as: 'likes', \n" +
            "                            } \n" +
            "                        }",

    "{\n" +
            "        \$unwind: { path: '\$likes', preserveNullAndEmptyArrays: true }\n" +
            "    }",
    "{\n" +
            "        \$match: {\n" +
            "            \$expr: \n" +
            "            {\n" +
            "                        \$and: [\n" +
            "                            {\$eq: [ '\$status', 'A' ] },\n" +
            "                            {\$eq: [ {\$ifNull: ['\$likes.type', 0]}, :#{#type} ]},\n" +
            "                            {\$gt: [{\$ifNull: [ '\$likes.createdDate', ISODate()]}, {\$toDate: :#{#offset[3]}}] },\n" +
            "                            {\$gte: [{\$ifNull: [ '\$likes.distance', { \$abs: {\$subtract: [\$score,?8] } } ]}, :#{#offset[1]}] },\n" +
            "                            {\$gte: [{\$ifNull: ['\$distance', 0]}, :#{#offset[2]}] },\n" +
            "                        ]\n" +
            "            },\n" +
            "        }\n" +
            "    }",


    "{\n" +
            "                \$addFields: {\n" +
            "                    'groupKey': {\$multiply: [{\$floor : [{\$divide : ['\$distance', 5]}]}, 5]},\n" +
            "                }\n" +
            "            }",

    "{\n" +
            "                \$addFields: {\n" +
            "                    'likes.rate': {\$ifNull: [ '\$likes.rate', 0]},\n" +
            "                }\n" +
            "            }",

    "{ \n" +
            "                            \$sort: { \n" +
            "                                'groupKey': 1, 'likes.rate': -1, 'likes.distance': 1\n" +
            "                            } \n" +
            "                        }",

    "{ \$limit : ?2 }",

    "{\n" +
            "        \$replaceRoot: { \n" +
            "            'newRoot': { \n" +
            "                \$mergeObjects: [{'profile': '\$\$ROOT'}, { rate: '\$likes.rate', groupKey: '\$groupKey', offset: ['\$groupKey', '\$likes.rate', '\$likes.distance', Date()] } ]\n" +
            "            }\n" +
            "        }\n" +
            "}"
]