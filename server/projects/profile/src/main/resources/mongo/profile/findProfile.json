[
        {
            "$geoNear": {
                "near": "?0",
                "spherical": true,
                "minDistance": ":#{#offset[0]}",
                "distanceField": "distance",
                "distanceMultiplier": 0.001,
                "query": {
                    "_id": { "$nin": ["?4"] },
                    "gender": "?5",
                    "group": "?6"
                }
            }
        },
        {
            "$lookup": {
                "from": "likes",
                "let": { "p_id": "$_id" },
                "pipeline": [
                    {
                        "$match": {
                            "$expr": {
                                "$or": [
                                    {
                                        "$and": [
                                            { "$eq": ["$from.$id", "$$p_id"] },
                                            { "$eq": ["$to.$id", "?4"] },
                                            {
                                                "$eq": [
                                                    { "$ifNull": ["$ref", 0] },
                                                    0
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        "$and": [
                                            { "$eq": ["$to.$id", "$$p_id"] },
                                            { "$eq": ["$from.$id", "?4"] },
                                            {
                                                "$eq": [
                                                    { "$ifNull": ["$ref", 0] },
                                                    0
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        }
                    },
                    {
                        "$group": {
                            "_id": "$$p_id",
                            "distance": { "$avg": "$distance" },
                            "ref": { "$first": { "$ifNull": ["$ref", 0] } },
                            "type": {
                                "$avg": {
                                    "$switch": {
                                        "branches": [
                                            {
                                                "case": {
                                                    "$and": [
                                                        { "$eq": ["$to.$id", "?4"] },
                                                        { "$eq": ["$double", false] }
                                                    ]
                                                },
                                                "then": 2
                                            },
                                            {
                                                "case": {
                                                    "$and": [
                                                        { "$eq": ["$from.$id", "?4"] },
                                                        { "$eq": ["$double", false] }
                                                    ]
                                                },
                                                "then": 1
                                            }
                                        ],
                                        "default": 0
                                    }
                                }
                            },
                            "rate": {
                                "$sum": {
                                    "$switch": {
                                        "branches": [
                                            {
                                                "case": {
                                                    "$and": [
                                                        { "$eq": ["$createdBy.$id", "?4"] },
                                                        { "$eq": ["$double", false] }
                                                    ]
                                                },
                                                "then": "$rate"
                                            }
                                        ],
                                        "default": 0
                                    }
                                }
                            },
                            "createdDate": { "$max": "$createdDate" }
                        }
                    }
                ],
                "as": "likes"
            }
        },
        {
            "$unwind": { "path": "$likes", "preserveNullAndEmptyArrays": true }
        },
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$eq": ["$status", "A"] },
                        { "$eq": [{ "$ifNull": ["$likes.type", 0] }, ":#{#type}"] },
                        { "$gt": [{ "$ifNull": ["$likes.createdDate", "ISODate()"] }, { "$toDate": ":#{#offset[3]}" }] },
                        { "$gte": [{ "$ifNull": ["$likes.distance", { "$abs": { "$subtract": ["$score", "?8"] } }] }, ":#{#offset[1]}"] },
                        { "$gte": [{ "$ifNull": ["$distance", 0] }, ":#{#offset[2]}"] }
                    ]
                }
            }
        },
        {
            "$addFields": {
                "groupKey": { "$multiply": [{ "$floor": { "$divide": ["$distance", 5] } }, 5] }
            }
        },
        {
            "$addFields": {
                "likes.rate": { "$ifNull": ["$likes.rate", 0] }
            }
        },
        {
            "$sort": { "groupKey": 1, "likes.rate": -1, "likes.distance": 1 }
        },
        { "$limit": "?2" },
        {
            "$replaceRoot": {
                "newRoot": {
                    "$mergeObjects": [
                        { "profile": "$$ROOT" },
                        { "rate": "$likes.rate", "groupKey": "$groupKey", "offset": ["$groupKey", "$likes.rate", "$likes.distance", { "$toDate": "Date()" }] }
                    ]
                }
            }
        }
    ]
    