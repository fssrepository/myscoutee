[
        {
            "$geoNear": {
                "near": ":#{#loc}",
                "spherical": true,
                "minDistance": ":#{#offset[0]}",
                "distanceField": "distance",
                "distanceMultiplier": 0.001,
                "query": {
                    "_id": { "$nin": [":#{#uuids}"] },
                    "type": ":#{#type}",
                    "system": false,
                    "visibility": "public"
                }
            }
        },
        {
            "$match": {
                "$expr": {
                    "$and": [
                        { "$gt": [{ "$ifNull": ["$createdDate", "ISODate()"] }, { "$toDate": ":#{#offset[1]}" }] },
                        { "$gte": ["$distance", ":#{#offset[2]}" ] }
                    ]
                }
            }
        },
        {
            "$addFields": {
                "groupKey": { "$multiply": [{ "$floor": [{ "$divide": ["$distance", ":#{#step}"] }] }, ":#{#step}"] }
            }
        },
        {
            "$sort": {
                "groupKey": 1,
                "distance": 1,
                "createdDate": -1
            }
        },
        {
            "$limit": ":#{#limit}"
        },
        {
            "$replaceRoot": {
                "newRoot": {
                    "$mergeObjects": [
                        { "group": "$$ROOT" },
                        { "groupKey": "$groupKey", "offset": ["$groupKey", "$distance", "$createdDate"] }
                    ]
                }
            }
        }
    ]
    