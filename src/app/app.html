<main class="main">
  <div class="content content-single">
    <button mat-icon-button class="user-selector-btn-global" [class.is-hidden]="showUserMenu" (click)="onUserSelect()" aria-label="Open user menu">
      <span class="user-initial" [class]="'user-color-' + activeUser.gender">{{ activeUser.initials }}</span>
      <span class="badge-dot" *ngIf="userBadgeCount > 0">{{ userBadgeCount }}</span>
    </button>

    <div class="user-menu-backdrop" [class.open]="showUserMenu" (click)="closeUserMenu()" *ngIf="showUserMenu"></div>

    <aside class="user-menu-panel" [class.open]="showUserMenu">
      <div
        class="user-menu-header"
        role="button"
        tabindex="0"
        (click)="onHeaderPanelClick($event)"
        (keydown.enter)="openProfileEditor()"
        (keydown.space)="openProfileEditor(); $event.preventDefault()"
      >
        <span class="header-open-cue" aria-hidden="true">
          <mat-icon>chevron_right</mat-icon>
        </span>

        <div class="user-header-main">
          <div class="avatar-stack">
            <span class="user-avatar user-avatar-large" [class]="'user-color-' + activeUser.gender">{{ activeUser.initials }}</span>
            <span class="avatar-activity-badge" *ngIf="userBadgeCount > 0">{{ userBadgeCount }}</span>
            <span class="avatar-bottom-pill">{{ activeUser.completion }}%</span>
          </div>

          <div class="user-meta user-meta-compact">
            <span class="user-name">{{ activeUser.name }}, {{ activeUser.age }}</span>
            <span class="user-city-line">
              <mat-icon>location_on</mat-icon>
              <span>{{ activeUser.city }}</span>
            </span>
            <span class="user-role user-role-status" [class]="profileStatusClass(activeUser.profileStatus)">
              <mat-icon>{{ getProfileStatusIcon(activeUser.profileStatus) }}</mat-icon>
              <span>{{ activeUser.profileStatus }}</span>
            </span>
            <span class="user-third-line">
              <span class="meta-chip-inline">
                <mat-icon [class]="getHostTierColorClass(activeUser.hostTier)">{{ getHostTierIcon(activeUser.hostTier) }}</mat-icon>
                <span>{{ activeUser.hostTier }}</span>
              </span>
              <span class="meta-separator">·</span>
              <span class="meta-chip-inline">
                <mat-icon [class]="getTraitColorClass(activeUser.traitLabel)">{{ getTraitIcon(activeUser.traitLabel) }}</mat-icon>
                <span>{{ activeUser.traitLabel }}</span>
              </span>
            </span>
          </div>
        </div>
      </div>

      <div class="user-menu-content">
        <button class="game-entry menu-tone-game is-active" type="button" (click)="goToGame()">
          <span class="entry-left">
            <mat-icon class="menu-item-icon">interests</mat-icon>
            <span>Game</span>
          </span>
          <span class="card-badge" *ngIf="gameBadge > 0">{{ gameBadge }}</span>
        </button>

        <section class="user-menu-card">
          <header class="card-header card-header-clickable menu-tone-chat" [class.is-active]="sectionsOpen.chat" (click)="toggleSection('chat')">
            <span class="entry-left">
              <mat-icon class="menu-item-icon">chat</mat-icon>
              <span class="card-title">Chat</span>
            </span>
            <span class="card-badge menu-header-badge" *ngIf="chatBadge > 0">{{ chatBadge }}</span>
          </header>

          <div class="card-body accordion-body" [class.open]="sectionsOpen.chat">
            <div class="accordion-inner">
              <button class="menu-context-row chat-context-row" type="button" *ngFor="let item of chatItems" (click)="openChatItem(item)">
                <span class="chat-room-avatar-wrap">
                  <span class="chat-room-avatar" [class]="'user-color-' + getChatLastSender(item).gender">{{ getChatLastSender(item).initials }}</span>
                </span>
                <span class="menu-row-content chat-row-content">
                  <span class="menu-row-name">{{ getChatLastSender(item).name }}</span>
                  <span class="menu-row-title">{{ item.title }}</span>
                  <span class="menu-row-sub">{{ item.lastMessage }}</span>
                </span>
                <span class="chat-members-inline-badge">{{ getChatMemberCount(item) }} members</span>
                <span class="row-badge" *ngIf="item.unread > 0">{{ item.unread }}</span>
              </button>
            </div>
          </div>
        </section>

        <section class="user-menu-card">
          <header
            class="card-header card-header-clickable menu-tone-invitations"
            [class.is-active]="sectionsOpen.invitations"
            (click)="toggleSection('invitations')"
          >
            <span class="entry-left">
              <mat-icon class="menu-item-icon">mail</mat-icon>
              <span class="card-title">Invitations</span>
            </span>
            <span class="card-badge menu-header-badge" *ngIf="invitationsBadge > 0">{{ invitationsBadge }}</span>
          </header>

          <div class="card-body accordion-body" [class.open]="sectionsOpen.invitations">
            <div class="accordion-inner">
              <button
                class="menu-context-row menu-context-row-event"
                type="button"
                *ngFor="let invitation of invitationItems"
                (click)="openInvitationItem(invitation)"
              >
                <span class="menu-avatar">{{ invitation.avatar }}</span>
                <span class="menu-row-content">
                  <span class="menu-row-title">{{ invitation.description }}</span>
                  <span class="menu-row-sub">{{ getInvitationActionSummary(invitation) }}</span>
                  <span class="menu-row-sub">{{ invitation.when }}</span>
                </span>
                <span class="row-badge" *ngIf="invitation.unread > 0">{{ invitation.unread }}</span>
              </button>
            </div>
          </div>
        </section>

        <section class="user-menu-card">
          <header class="card-header card-header-clickable menu-tone-events" [class.is-active]="sectionsOpen.events" (click)="toggleSection('events')">
            <span class="entry-left">
              <mat-icon class="menu-item-icon">event</mat-icon>
              <span class="card-title">Events</span>
            </span>
            <span class="menu-header-actions">
              <button class="header-icon-btn" type="button" aria-label="Explore events" (click)="$event.stopPropagation(); openEventExplore()">
                <span class="header-plus-glyph">+</span>
              </button>
              <span class="card-badge menu-header-badge" *ngIf="eventsBadge > 0">{{ eventsBadge }}</span>
            </span>
          </header>

          <div class="card-body accordion-body" [class.open]="sectionsOpen.events">
            <div class="accordion-inner">
              <button
                class="menu-context-row menu-context-row-event"
                type="button"
                *ngFor="let event of eventItems"
                (click)="openEventItem(event)"
              >
                <span class="menu-avatar">{{ event.avatar }}</span>
                <span class="menu-row-content">
                  <span class="menu-row-title">{{ event.title }}</span>
                  <span class="menu-row-sub">{{ event.shortDescription }}</span>
                  <span class="menu-row-sub">{{ event.timeframe }}</span>
                </span>
                <span class="row-badge" *ngIf="event.activity > 0">{{ event.activity }}</span>
              </button>
            </div>
          </div>
        </section>

        <section class="user-menu-card">
          <header class="card-header card-header-clickable menu-tone-hosting" [class.is-active]="sectionsOpen.hosting" (click)="toggleSection('hosting')">
            <span class="entry-left">
              <mat-icon class="menu-item-icon">stadium</mat-icon>
              <span class="card-title">Hosting</span>
            </span>
            <span class="card-badge menu-header-badge" *ngIf="hostingBadge > 0">{{ hostingBadge }}</span>
          </header>

          <div class="card-body accordion-body" [class.open]="sectionsOpen.hosting">
            <div class="accordion-inner">
              <button
                class="menu-context-row menu-context-row-event"
                type="button"
                *ngFor="let item of hostingItems"
                (click)="openHostingItem(item)"
              >
                <span class="menu-avatar">{{ item.avatar }}</span>
                <span class="menu-row-content">
                  <span class="menu-row-title">{{ item.title }}</span>
                  <span class="menu-row-sub">{{ item.shortDescription }}</span>
                  <span class="menu-row-sub">{{ item.timeframe }}</span>
                </span>
                <span class="row-badge" *ngIf="item.activity > 0">{{ item.activity }}</span>
              </button>
            </div>
          </div>
        </section>
      </div>
    </aside>

    <section class="content-area content-area-full">
      <router-outlet></router-outlet>
    </section>
  </div>
</main>

<section class="app-popup" *ngIf="activePopup && activePopup !== 'logoutConfirm'">
  <div class="app-popup-backdrop" (click)="closePopup()"></div>
  <div
    class="app-popup-panel"
    [class.popup-panel-members]="activePopup === 'chatMembers'"
    [class.popup-panel-image-editor]="activePopup === 'imageEditor'"
    (click)="$event.stopPropagation()"
  >
    <div class="popup-header" [class.popup-header-chat]="activePopup === 'chat' && selectedChat">
      <div class="popup-title popup-title-chat" *ngIf="activePopup === 'chat' && selectedChat; else defaultPopupTitle">
        <div class="popup-chat-title-block">
          <h2>{{ selectedChat.title }}</h2>
        </div>
        <button class="chat-members-stack chat-members-stack-large chat-header-members" type="button" (click)="openChatMembers(selectedChat, $event, true)">
          <span class="chat-stack-avatar" *ngFor="let member of getChatVisibleMembers(selectedChat); let i = index" [class]="'user-color-' + member.gender" [style.zIndex]="30 - i">{{ member.initials }}</span>
          <span class="chat-stack-more" *ngIf="getChatHiddenMemberCount(selectedChat) > 0">+{{ getChatHiddenMemberCount(selectedChat) }}</span>
        </button>
      </div>
      <ng-template #defaultPopupTitle>
        <div class="popup-title popup-title-members" *ngIf="activePopup === 'chatMembers'; else defaultPlainTitle">
          <div class="popup-chat-title-block">
            <h2>Chat Members</h2>
            <p>{{ selectedChatMembersItem?.title || 'Room' }}</p>
          </div>
        </div>
        <ng-template #defaultPlainTitle>
          <div class="popup-title">
            <h2>{{ getPopupTitle() }}</h2>
          </div>
        </ng-template>
      </ng-template>
      <span class="header-members-count" *ngIf="activePopup === 'chatMembers'">{{ selectedChatMembers.length }} members</span>
      <button
        type="button"
        class="popup-chat-event-btn"
        aria-label="Open event editor"
        *ngIf="activePopup === 'chat' && selectedChat"
        (click)="openEventEditor(true)"
      >
        <mat-icon>edit_calendar</mat-icon>
      </button>
      <button mat-icon-button class="popup-close" (click)="closePopup()" aria-label="Close">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div
      class="popup-body"
      [class.popup-body-chat]="activePopup === 'chat' && selectedChat"
      [class.popup-body-members]="activePopup === 'chatMembers'"
      [class.popup-body-image-editor]="activePopup === 'imageEditor'"
    >
      <div *ngIf="activePopup === 'chat' && selectedChat" class="chat-popup-wrap">
        <div class="chat-popup-box">
          <div class="chat-thread">
            <article class="chat-message" *ngFor="let message of chatPopupMessages" [class.mine]="message.mine">
              <div class="chat-bubble">
                <span class="chat-sender-avatar" [class]="'user-color-' + message.senderAvatar.gender">{{ message.senderAvatar.initials }}</span>
                <div class="chat-message-content">
                  <div class="chat-meta-row">
                    <span class="chat-sender-name">{{ message.sender }}</span>
                    <span class="chat-time-chip">{{ message.time }}</span>
                  </div>
                  <p class="chat-line">{{ message.text }}</p>
                </div>
                <div class="chat-readers" *ngIf="message.readBy.length > 0">
                  <span class="chat-reader" *ngFor="let reader of message.readBy" [class]="'user-color-' + reader.gender">{{ reader.initials }}</span>
                </div>
              </div>
            </article>
          </div>
          <div class="chat-compose-box">
            <textarea rows="3" placeholder="Write message"></textarea>
            <button type="button" class="chat-send-btn" aria-label="Send message">
              <mat-icon>send</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'chatMembers'">
        <div class="chat-members-popup-list">
          <div class="chat-members-popup-row" *ngFor="let member of selectedChatMembers">
            <span class="chat-members-popup-avatar" [class]="'user-color-' + member.gender">{{ member.initials }}</span>
            <div class="chat-members-popup-meta">
              <p>{{ member.name }}</p>
              <p>{{ member.city }} · {{ member.statusText }}</p>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'invitationActions' && selectedInvitation">
        <div class="editor-list-card">
          <h4>{{ selectedInvitation.description }}</h4>
          <p>{{ getInvitationActionSummary(selectedInvitation) }} · {{ selectedInvitation.when }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn">Accept</button>
          <button type="button" class="link-btn">Delete</button>
          <button type="button" class="link-btn" (click)="openEventEditor()">Open Related Event</button>
        </div>
      </div>

      <div *ngIf="activePopup === 'menuEvent' && selectedEvent">
        <div class="editor-list-card">
          <h4>{{ selectedEvent.title }}</h4>
          <p>{{ selectedEvent.shortDescription }}</p>
          <p>{{ selectedEvent.timeframe }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn" (click)="openEventEditor()" *ngIf="selectedEvent.isAdmin">Edit Event</button>
          <button type="button" class="link-btn" *ngIf="!selectedEvent.isAdmin">Exit Event</button>
          <button type="button" class="link-btn">Open Event Chat</button>
        </div>
      </div>

      <div *ngIf="activePopup === 'hostingEvent' && selectedHostingEvent">
        <div class="editor-list-card">
          <h4>{{ selectedHostingEvent.title }}</h4>
          <p>{{ selectedHostingEvent.shortDescription }}</p>
          <p>{{ selectedHostingEvent.timeframe }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn">Accept Join Requests</button>
          <button type="button" class="link-btn" (click)="openEventEditor()">Edit Hosted Event</button>
        </div>
      </div>

      <div *ngIf="activePopup === 'eventExplore'">
        <div class="editor-list-card">
          <h4>Event Explore Filters</h4>
          <p>Host name, friends-in-common recommendation, distance, calendar and own-event filter.</p>
        </div>
        <div class="editor-list-card">
          <h4>Suggested Events</h4>
          <p>Join request is one click and goes to admin approval.</p>
          <div class="popup-actions">
            <button type="button" class="link-btn">Join Selected Event</button>
            <button type="button" class="link-btn" (click)="openEventEditor()">Create New Event</button>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'eventEditor'">
        <div class="editor-list-card event-main-card">
          <h4>{{ eventEditor.mainEvent.title }}</h4>
          <p>
            Visibility: {{ eventEditor.mainEvent.visibility }} · Mode: {{ eventEditor.mainEvent.mode }} · Frequency:
            {{ eventEditor.mainEvent.frequency }}
          </p>
          <p>Capacity: {{ eventEditor.mainEvent.capacity }} · Ticket: {{ eventEditor.mainEvent.ticket }} · Expense: {{ eventEditor.mainEvent.expense }}</p>
          <p>{{ eventEditor.mainEvent.topics.join(', ') }}</p>
        </div>

        <div class="dynamic-supply-adder">
          <input type="text" [(ngModel)]="newSupplyType" placeholder="Add supply type (for event cards)" />
          <button type="button" class="link-btn" (click)="addSupplyType()">+ Add Type</button>
        </div>

        <div class="event-editor-card" *ngFor="let sub of eventEditor.subEvents">
          <div class="event-editor-head">
            <h4>{{ sub.title }}</h4>
            <p>{{ sub.when }}</p>
            <p>{{ sub.phase }}</p>
          </div>

          <div class="event-supply-buttons">
            <button
              class="supply-chip"
              type="button"
              *ngFor="let type of eventSupplyTypes"
              [class.warn]="isSupplyStatIncomplete(sub, type)"
              (click)="openSupplyDetail(sub.id, sub.title, type)"
            >
              <span class="chip-title">{{ type }}</span>
              <span class="chip-meta">{{ getSupplyStat(sub, type) }}</span>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'supplyDetail' && selectedSupplyContext">
        <div class="editor-list-card">
          <h4>{{ selectedSupplyContext.type }} · {{ selectedSupplyContext.subEventTitle }}</h4>
          <p>Dynamic supply list for this event card.</p>
        </div>
        <div class="editor-list-card" *ngFor="let item of selectedSupplyItems">
          <h4>{{ item.label }}</h4>
          <p>{{ item.detail }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn" (click)="alertService.open('Supply item flow is ready for backend wiring.')">+ Add supply offer</button>
          <button type="button" class="link-btn" (click)="openEventEditor()">Back to Event Editor</button>
        </div>
      </div>

      <div *ngIf="activePopup === 'profileEditor'" class="profile-editor-wrap">
        <div class="profile-identity-card profile-identity-card-large">
          <div class="avatar-stack avatar-stack-editor">
            <span class="user-avatar user-avatar-large" [class]="'user-color-' + activeUser.gender">{{ activeUser.initials }}</span>
            <button type="button" class="avatar-edit-btn" aria-label="Open image editor" (click)="openImageEditor()">
              <mat-icon>edit</mat-icon>
            </button>
            <span class="avatar-bottom-pill">{{ activeUser.completion }}%</span>
          </div>

          <div class="profile-header-text">
            <h3 class="profile-name-line">
              <span>{{ (profileForm.fullName || activeUser.name) + ', ' + profileEditorAge }}</span>
            </h3>
            <span class="profile-city-line">
              <mat-icon>location_on</mat-icon>
              <span>{{ profileForm.city || activeUser.city }}</span>
            </span>
            <div class="profile-status-select-wrap" [class]="profileStatusClass(profileForm.profileStatus)">
              <mat-select [(ngModel)]="profileForm.profileStatus" disableOptionCentering panelClass="selector-options-panel status-options-panel">
                <mat-select-trigger>
                  <span class="status-option-content">
                    <mat-icon [class]="profileStatusClass(profileForm.profileStatus)">{{ getProfileStatusIcon(profileForm.profileStatus) }}</mat-icon>
                    <span>{{ profileForm.profileStatus }}</span>
                  </span>
                </mat-select-trigger>
                <mat-option
                  *ngFor="let status of profileStatusOptions"
                  [value]="status.value"
                  [class]="'status-option ' + profileStatusClass(status.value)"
                  [class.hide-selected-option]="status.value === profileForm.profileStatus"
                >
                  <span class="status-option-content">
                    <mat-icon [class]="profileStatusClass(status.value)">{{ status.icon }}</mat-icon>
                    <span>{{ status.value }}</span>
                  </span>
                </mat-option>
              </mat-select>
            </div>
            <p class="profile-chip-line">
              <span class="meta-chip-inline">
                <mat-icon [class]="getHostTierColorClass(profileForm.hostTier || activeUser.hostTier)">{{ getHostTierIcon(profileForm.hostTier || activeUser.hostTier) }}</mat-icon>
                <span>{{ profileForm.hostTier || activeUser.hostTier }}</span>
              </span>
              <span class="meta-separator">·</span>
              <span class="meta-chip-inline">
                <mat-icon [class]="getTraitColorClass(profileForm.traitLabel || activeUser.traitLabel)">{{ getTraitIcon(profileForm.traitLabel || activeUser.traitLabel) }}</mat-icon>
                <span>{{ profileForm.traitLabel || activeUser.traitLabel }}</span>
              </span>
            </p>
          </div>
        </div>

        <label class="profile-about-field">
          <div class="profile-about-head">
            <span>About me</span>
            <small>{{ profileForm.about.length }}/160</small>
          </div>
          <textarea rows="3" maxlength="160" [(ngModel)]="profileForm.about"></textarea>
        </label>

        <mat-accordion class="popup-accordion profile-editor-accordion">
          <mat-expansion-panel class="editor-panel editor-panel-impressions">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="editor-accordion-title">
                  <mat-icon>psychology</mat-icon>
                  <span>Impressions</span>
                </span>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="accordion-content">
              <div class="social-proof-grid">
                <div class="editor-list-card social-proof-card social-proof-card-modern social-proof-card-host">
                  <h4 class="social-proof-identity-pill social-proof-identity-pill-host">
                    <mat-icon [class]="getHostTierColorClass(activeHostTier)">{{ getHostTierIcon(activeHostTier) }}</mat-icon>
                    <span>{{ activeHostTier }}</span>
                  </h4>

                  <div class="social-proof-metric-strip">
                    <span class="sp-metric-cell sp-metric-cell-rate">
                      <span class="label">Rate</span>
                      <span class="value">{{ hostAverageRating }}</span>
                    </span>
                    <span class="sp-metric-cell sp-metric-cell-people">
                      <span class="label">People / Events</span>
                      <span class="value">{{ hostPeopleMet }} / {{ hostTotalEvents }}</span>
                    </span>
                    <span class="sp-metric-cell sp-metric-cell-return">
                      <span class="label">Returnees / NoShow</span>
                      <span class="value">{{ hostRepeatSummary }} / {{ hostAttendanceNoShowSummary }}</span>
                    </span>
                  </div>

                  <div class="social-proof-section-block">
                    <div class="social-proof-section-head section-vibe">
                      <span class="section-tag">Vibe</span>
                      <span class="section-line"></span>
                    </div>
                    <div class="social-proof-chip-list">
                      <span class="social-proof-chip chip-vibe" *ngFor="let item of hostVibeBadgeItems">{{ item }}</span>
                    </div>
                  </div>

                  <div class="social-proof-section-block">
                    <div class="social-proof-section-head section-category">
                      <span class="section-tag">Category</span>
                      <span class="section-line"></span>
                    </div>
                    <div class="social-proof-chip-list">
                      <span class="social-proof-chip chip-category" *ngFor="let item of hostCategoryBadgeItems">{{ item }}</span>
                    </div>
                  </div>
                </div>

                <div class="editor-list-card social-proof-card social-proof-card-modern social-proof-card-member">
                  <h4 class="social-proof-identity-pill social-proof-identity-pill-member">
                    <mat-icon [class]="getTraitColorClass(activeMemberTrait)">{{ getTraitIcon(activeMemberTrait) }}</mat-icon>
                    <span>{{ activeMemberTrait }}</span>
                  </h4>

                  <div class="social-proof-metric-strip">
                    <span class="sp-metric-cell sp-metric-cell-rate">
                      <span class="label">Rate</span>
                      <span class="value">{{ hostAverageRating }}</span>
                    </span>
                    <span class="sp-metric-cell sp-metric-cell-people">
                      <span class="label">People / Events</span>
                      <span class="value">{{ memberPeopleMet }} / {{ memberTotalEvents }}</span>
                    </span>
                    <span class="sp-metric-cell sp-metric-cell-return">
                      <span class="label">Returnees / NoShow</span>
                      <span class="value">{{ memberReturneesSummary }} / {{ memberNoShowCount }}</span>
                    </span>
                  </div>

                  <div class="social-proof-section-block">
                    <div class="social-proof-section-head section-personality">
                      <span class="section-tag">Personality</span>
                      <span class="section-line"></span>
                    </div>
                    <div class="social-proof-chip-list">
                      <span class="social-proof-chip chip-personality" *ngFor="let item of memberPersonalityBadgeItems">{{ item }}</span>
                    </div>
                  </div>

                  <div class="social-proof-section-block">
                    <div class="social-proof-section-head section-vibe">
                      <span class="section-tag">Vibe</span>
                      <span class="section-line"></span>
                    </div>
                    <div class="social-proof-chip-list">
                      <span class="social-proof-chip chip-vibe" *ngFor="let item of memberVibeBadgeItems">{{ item }}</span>
                    </div>
                  </div>

                  <div class="social-proof-section-block">
                    <div class="social-proof-section-head section-category">
                      <span class="section-tag">Category</span>
                      <span class="section-line"></span>
                    </div>
                    <div class="social-proof-chip-list">
                      <span class="social-proof-chip chip-category" *ngFor="let item of memberCategoryBadgeItems">{{ item }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </mat-expansion-panel>

          <mat-expansion-panel class="editor-panel editor-panel-details">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="editor-accordion-title">
                  <mat-icon>badge</mat-icon>
                  <span>Personal Details</span>
                </span>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="accordion-content">
              <div class="profile-details-structured">
                <section class="profile-details-group" *ngFor="let group of profileDetailsForm; let groupIndex = index">
                  <h4>{{ group.title }}</h4>
                  <div class="profile-form-grid profile-details-form-grid basics-moved-grid" *ngIf="group.title === 'Basics'; else nonBasicsGroup">
                    <label class="name-field">
                      <span>Name</span>
                      <input type="text" [(ngModel)]="profileForm.fullName" />
                    </label>
                    <label class="city-field">
                      <span>City</span>
                      <input type="text" [(ngModel)]="profileForm.city" />
                    </label>
                    <label class="birthday-field">
                      <span>Birthday</span>
                      <div class="date-input-wrap">
                        <input [matDatepicker]="birthdayPicker" [(ngModel)]="profileForm.birthday" (ngModelChange)="onBirthdayChange($event)" />
                        <button type="button" class="date-picker-btn" (click)="birthdayPicker.open()" aria-label="Open birthday picker">
                          <mat-icon>calendar_month</mat-icon>
                        </button>
                        <mat-datepicker #birthdayPicker></mat-datepicker>
                      </div>
                    </label>
                    <label class="horoscope-field">
                      <span>Horoscope</span>
                      <div class="profile-status-select-wrap selector-like readonly-select" [class]="getHoroscopeClass(profileForm.horoscope)">
                        <span class="zodiac-symbol">{{ getHoroscopeSymbol(profileForm.horoscope) }}</span>
                        <span class="zodiac-label">{{ profileForm.horoscope }}</span>
                      </div>
                    </label>
                    <label class="height-field">
                      <span>Height (cm)</span>
                      <input type="number" min="0" step="1" [(ngModel)]="profileForm.heightCm" />
                    </label>
                    <label class="physique-field">
                      <span>Physique</span>
                      <div class="profile-status-select-wrap selector-like physique-select-wrap" [class]="getPhysiqueClass(profileForm.physique)">
                        <mat-select [(ngModel)]="profileForm.physique" disableOptionCentering panelClass="selector-options-panel physique-options-panel">
                          <mat-select-trigger>
                            <span class="status-option-content">
                              <mat-icon [class]="getPhysiqueClass(profileForm.physique)">{{ getPhysiqueIcon(profileForm.physique) }}</mat-icon>
                              <span>{{ profileForm.physique }}</span>
                            </span>
                          </mat-select-trigger>
                          <mat-option
                            *ngFor="let item of physiqueOptions"
                            [value]="item"
                            [class]="'status-option ' + getPhysiqueClass(item)"
                            [class.hide-selected-option]="item === profileForm.physique"
                          >
                            <span class="status-option-content">
                              <mat-icon [class]="getPhysiqueClass(item)">{{ getPhysiqueIcon(item) }}</mat-icon>
                              <span>{{ item }}</span>
                            </span>
                          </mat-option>
                        </mat-select>
                      </div>
                    </label>
                    <label class="languages-field">
                      <span>Languages</span>
                      <div class="language-filter" (click)="onLanguagePanelClick($event)">
                        <button type="button" mat-stroked-button class="language-select-btn" [class.active]="showLanguagePanel" (click)="toggleLanguagePanel()">
                          <span class="label">{{ languageTriggerLabel() }}</span>
                          <mat-icon class="arrow" [class.open]="showLanguagePanel">expand_more</mat-icon>
                        </button>

                        <div class="language-panel" [class.open]="showLanguagePanel" *ngIf="showLanguagePanel">
                          <div class="language-chip-input" (click)="onLanguageInputContainerClick($event)">
                            <mat-chip-set class="language-chip-set-inline" *ngIf="profileForm.languages.length > 0">
                              <mat-chip *ngFor="let item of profileForm.languages" [removable]="true" (removed)="removeLanguage(item)">
                                <span>{{ item }}</span>
                                <button matChipRemove aria-label="Remove language">
                                  <mat-icon>cancel</mat-icon>
                                </button>
                              </mat-chip>
                            </mat-chip-set>

                            <input
                              type="text"
                              [(ngModel)]="languageInput"
                              [matAutocomplete]="languageAuto"
                              #languageTrigger="matAutocompleteTrigger"
                              (focus)="onLanguageInputFocus(); languageTrigger.openPanel()"
                              (click)="languageTrigger.openPanel()"
                              (keydown)="onLanguageInputKeydown($event)"
                              (blur)="onLanguageInputBlur()"
                              placeholder="Language search"
                            />
                            <mat-icon class="language-dropdown-icon">search</mat-icon>

                            <mat-autocomplete #languageAuto="matAutocomplete" (optionSelected)="selectLanguage($event.option.value)">
                              <mat-option *ngFor="let item of availableLanguageDisplaySuggestions" [value]="item">
                                {{ item }}
                              </mat-option>
                            </mat-autocomplete>
                          </div>
                        </div>
                      </div>
                    </label>
                  </div>
                  <ng-template #nonBasicsGroup>
                    <div class="profile-form-grid profile-details-form-grid">
                    <label class="profile-details-field" *ngFor="let row of group.rows; let rowIndex = index">
                      <span>{{ row.label }}</span>
                      <div class="profile-details-control-row">
                        <button
                          type="button"
                          class="profile-status-select-wrap selector-like profile-details-values-btn"
                          [ngClass]="row.label === 'Values' ? valuesDominantToneClass(row.value) : interestDominantToneClass(row.value)"
                          *ngIf="row.label === 'Values' || row.label === 'Interest'; else detailsSelect"
                          (click)="row.label === 'Values' ? openValuesSelector(groupIndex, rowIndex) : openInterestSelector(groupIndex, rowIndex)"
                        >
                          <span class="status-option-content">
                            <span>{{ row.label === 'Values' ? valuesRowSummary(row.value) : interestRowSummary(row.value) }}</span>
                          </span>
                          <mat-icon>chevron_right</mat-icon>
                        </button>
                        <ng-template #detailsSelect>
                        <div class="profile-status-select-wrap selector-like profile-details-select" [ngClass]="detailSelectedClass(row.label, row.value, row.options)">
                          <mat-select [(ngModel)]="row.value" disableOptionCentering panelClass="selector-options-panel">
                            <mat-select-trigger>
                              <span class="status-option-content">
                                <span>{{ row.value }}</span>
                              </span>
                            </mat-select-trigger>
                            <mat-option
                              *ngFor="let item of row.options"
                              [value]="item"
                              class="status-option"
                              [ngClass]="detailOptionClass(row.label, item, row.options)"
                              [class.hide-selected-option]="item === row.value"
                            >
                              <span class="status-option-content">
                                <span>{{ item }}</span>
                              </span>
                            </mat-option>
                          </mat-select>
                        </div>
                        </ng-template>
                        <div
                          class="profile-details-privacy-fab"
                          [class.open]="isDetailPrivacyFabOpen(groupIndex, rowIndex)"
                          [class.is-just-selected]="isDetailPrivacyJustSelected(groupIndex, rowIndex)"
                        >
                          <button
                            type="button"
                            class="profile-details-privacy-btn profile-details-privacy-trigger"
                            [class]="privacyStatusClass(row.privacy)"
                            (click)="toggleDetailPrivacyFab(groupIndex, rowIndex, $event)"
                            aria-label="Change visibility"
                          >
                            <mat-icon>{{ privacyStatusIcon(row.privacy) }}</mat-icon>
                          </button>
                          <div class="privacy-fab-actions">
                            <button
                              type="button"
                              class="profile-details-privacy-btn status-public"
                              (click)="selectDetailPrivacy(groupIndex, rowIndex, 'Public', $event)"
                              aria-label="Public"
                            >
                              <mat-icon>public</mat-icon>
                            </button>
                            <button
                              type="button"
                              class="profile-details-privacy-btn status-friends"
                              (click)="selectDetailPrivacy(groupIndex, rowIndex, 'Friends', $event)"
                              aria-label="Friends"
                            >
                              <mat-icon>groups</mat-icon>
                            </button>
                            <button
                              type="button"
                              class="profile-details-privacy-btn status-host"
                              (click)="selectDetailPrivacy(groupIndex, rowIndex, 'Hosts', $event)"
                              aria-label="Hosts"
                            >
                              <mat-icon>stadium</mat-icon>
                            </button>
                            <button
                              type="button"
                              class="profile-details-privacy-btn status-inactive"
                              (click)="selectDetailPrivacy(groupIndex, rowIndex, 'Private', $event)"
                              aria-label="Private"
                            >
                              <mat-icon>visibility_off</mat-icon>
                            </button>
                          </div>
                        </div>
                      </div>
                    </label>
                    </div>
                  </ng-template>
                </section>
              </div>
            </div>
          </mat-expansion-panel>

          <mat-expansion-panel class="editor-panel editor-panel-experience">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="editor-accordion-title">
                  <mat-icon>work_history</mat-icon>
                  <span>Experience</span>
                </span>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="accordion-content">
              <div class="editor-list-card" *ngFor="let item of profileExperience">
                <h4>{{ item.place }}</h4>
                <p>{{ item.role }} · {{ item.years }} · {{ item.city }}</p>
                <p *ngIf="item.socialProof">{{ item.socialProof }}</p>
              </div>
            </div>
          </mat-expansion-panel>

          <mat-expansion-panel class="editor-panel editor-panel-assets">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span class="editor-accordion-title">
                  <mat-icon>inventory_2</mat-icon>
                  <span>Assets</span>
                </span>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="accordion-content">
              <div class="assets-actions-row">
                <button type="button" class="link-btn">Car</button>
                <button type="button" class="link-btn">Accommodation</button>
                <button type="button" class="link-btn">Supplies</button>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>

      </div>

      <div *ngIf="activePopup === 'imageEditor'" class="image-editor-wrap">
        <div class="image-stack-indicators" *ngIf="imageStackSlots.length > 0">
          <button
            type="button"
            class="image-stack-line"
            *ngFor="let slotIndex of imageStackSlots"
            [class.active]="slotIndex === selectedImageIndex"
            (click)="selectImageFromStack(slotIndex)"
            aria-label="Select image"
          ></button>
        </div>
        <div class="image-editor-main" [style.backgroundImage]="selectedImagePreview ? 'url(' + selectedImagePreview + ')' : 'none'">
          <div class="image-stack-hit-area" *ngIf="imageStackSlots.length > 0">
            <button
              type="button"
              class="image-stack-hit-segment"
              *ngFor="let slotIndex of imageStackSlots"
              (click)="selectImageFromStack(slotIndex)"
              aria-label="Select image"
            ></button>
          </div>
          <span *ngIf="!selectedImagePreview">Select a slot to upload image</span>
        </div>
        <p class="image-editor-hint">Click a thumbnail to upload or replace image.</p>
        <input #slotImageInput class="image-file-input-hidden" type="file" accept="image/*" (change)="onSlotImageFileChange($event)" />

        <div class="image-editor-grid">
          <button
            type="button"
            *ngFor="let slot of imageSlots; let i = index"
            [class.slot-selected]="selectedImageIndex === i"
            [style.backgroundImage]="slot ? 'url(' + slot + ')' : 'none'"
            (click)="selectImageSlot(i)"
          >
            <span class="slot-index">{{ i + 1 }}</span>
            <span *ngIf="!slot" class="slot-add">+</span>
            <span *ngIf="slot" class="remove-slot" (click)="$event.stopPropagation(); removeImage(i)">×</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="app-popup app-popup-stacked" *ngIf="stackedPopup">
  <div class="app-popup-backdrop" (click)="closeStackedPopup()"></div>
  <div class="app-popup-panel" [class.popup-panel-members]="stackedPopup === 'chatMembers'" (click)="$event.stopPropagation()">
    <div class="popup-header" *ngIf="stackedPopup === 'valuesSelector' || stackedPopup === 'interestSelector'; else defaultStackedHeader">
      <button mat-icon-button class="popup-back-btn" (click)="closeStackedPopup()" aria-label="Back">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="popup-title popup-title-values">
        <h2>{{ getStackedPopupTitle() }}</h2>
      </div>
      <div class="values-header-chips" *ngIf="(stackedPopup === 'valuesSelector' ? valuesSelectorSelected : interestSelectorSelected).length > 0">
        <button
          type="button"
          class="values-selected-chip"
          [class]="stackedPopup === 'valuesSelector' ? valuesOptionToneClass(item) : interestOptionToneClass(item)"
          *ngFor="let item of (stackedPopup === 'valuesSelector' ? valuesSelectorSelected : interestSelectorSelected)"
          (click)="stackedPopup === 'valuesSelector' ? removeValuesOption(item) : removeInterestOption(item)"
        >
          <span>{{ item }}</span>
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    <ng-template #defaultStackedHeader>
      <div class="popup-header">
        <div class="popup-title popup-title-members" *ngIf="stackedPopup === 'chatMembers'; else defaultStackedTitle">
          <div class="popup-chat-title-block">
            <h2>Chat Members</h2>
            <p>{{ selectedChatMembersItem?.title || 'Room' }}</p>
          </div>
        </div>
        <ng-template #defaultStackedTitle>
          <div class="popup-title">
            <h2>{{ getStackedPopupTitle() }}</h2>
          </div>
        </ng-template>
        <span class="header-members-count" *ngIf="stackedPopup === 'chatMembers'">{{ selectedChatMembers.length }} members</span>
        <button mat-icon-button class="popup-close" (click)="closeStackedPopup()" aria-label="Close">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </ng-template>

    <div class="popup-body" [class.popup-body-members]="stackedPopup === 'chatMembers'">
      <div *ngIf="stackedPopup === 'chatMembers'">
        <div class="chat-members-popup-list">
          <div class="chat-members-popup-row" *ngFor="let member of selectedChatMembers">
            <span class="chat-members-popup-avatar" [class]="'user-color-' + member.gender">{{ member.initials }}</span>
            <div class="chat-members-popup-meta">
              <p>{{ member.name }}</p>
              <p>{{ member.city }} · {{ member.statusText }}</p>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'eventEditor'">
        <div class="editor-list-card event-main-card">
          <h4>{{ eventEditor.mainEvent.title }}</h4>
          <p>
            Visibility: {{ eventEditor.mainEvent.visibility }} · Mode: {{ eventEditor.mainEvent.mode }} · Frequency:
            {{ eventEditor.mainEvent.frequency }}
          </p>
          <p>Capacity: {{ eventEditor.mainEvent.capacity }} · Ticket: {{ eventEditor.mainEvent.ticket }} · Expense: {{ eventEditor.mainEvent.expense }}</p>
          <p>{{ eventEditor.mainEvent.topics.join(', ') }}</p>
        </div>

        <div class="dynamic-supply-adder">
          <input type="text" [(ngModel)]="newSupplyType" placeholder="Add supply type (for event cards)" />
          <button type="button" class="link-btn" (click)="addSupplyType()">+ Add Type</button>
        </div>

        <div class="event-editor-card" *ngFor="let sub of eventEditor.subEvents">
          <div class="event-editor-head">
            <h4>{{ sub.title }}</h4>
            <p>{{ sub.when }}</p>
            <p>{{ sub.phase }}</p>
          </div>

          <div class="event-supply-buttons">
            <button
              class="supply-chip"
              type="button"
              *ngFor="let type of eventSupplyTypes"
              [class.warn]="isSupplyStatIncomplete(sub, type)"
              (click)="openSupplyDetail(sub.id, sub.title, type)"
            >
              <span class="chip-title">{{ type }}</span>
              <span class="chip-meta">{{ getSupplyStat(sub, type) }}</span>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'supplyDetail' && selectedSupplyContext">
        <div class="editor-list-card">
          <h4>{{ selectedSupplyContext.type }} · {{ selectedSupplyContext.subEventTitle }}</h4>
          <p>Dynamic supply list for this event card.</p>
        </div>
        <div class="editor-list-card" *ngFor="let item of selectedSupplyItems">
          <h4>{{ item.label }}</h4>
          <p>{{ item.detail }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn" (click)="alertService.open('Supply item flow is ready for backend wiring.')">+ Add supply offer</button>
          <button type="button" class="link-btn" (click)="openEventEditor()">Back to Event Editor</button>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'valuesSelector'" class="values-selector-popup">
        <div class="values-selector-group" *ngFor="let group of beliefsValuesOptionGroups">
          <div class="social-proof-section-head" [class]="group.toneClass">
            <span class="section-tag">{{ group.icon }} {{ group.shortTitle }}</span>
            <span class="section-line"></span>
          </div>
          <div class="social-proof-chip-list">
            <button
              type="button"
              class="social-proof-chip values-option-chip"
              [class.active]="isValuesOptionSelected(option)"
              *ngFor="let option of group.options"
              (click)="toggleValuesOption(option)"
            >
              {{ option }}
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'interestSelector'" class="values-selector-popup">
        <div class="values-selector-group" *ngFor="let group of interestOptionGroups">
          <div class="social-proof-section-head" [class]="group.toneClass">
            <span class="section-tag">{{ group.icon }} {{ group.shortTitle }}</span>
            <span class="section-line"></span>
          </div>
          <div class="social-proof-chip-list">
            <button
              type="button"
              class="social-proof-chip values-option-chip"
              [class.active]="isInterestOptionSelected(option)"
              *ngFor="let option of group.options"
              (click)="toggleInterestOption(option)"
            >
              {{ option }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="logout-confirm" *ngIf="activePopup === 'logoutConfirm'">
  <div class="logout-confirm-backdrop" (click)="closePopup()"></div>
  <div class="logout-confirm-panel" (click)="$event.stopPropagation()">
    <h3>Biztosan kilép?</h3>
    <p>{{ activeUser.name }}</p>
    <div class="logout-confirm-actions">
      <button mat-stroked-button type="button" (click)="closePopup()">Mégsem</button>
      <button mat-raised-button color="warn" class="logout-btn" type="button" (click)="confirmLogout()">Kilépés</button>
    </div>
  </div>
</section>

<section class="demo-login-overlay" *ngIf="showUserSelector">
  <div class="demo-login-panel" (click)="$event.stopPropagation()">
    <h2>Select demo user</h2>
    <p>Login disabled mode. Choose one of the 12 users to open perspective-based data.</p>
    <div class="demo-user-grid">
      <button type="button" class="demo-user-item" *ngFor="let user of users" (click)="selectLoginUser(user.id)">
        <span class="user-avatar" [class]="'user-color-' + user.gender">{{ user.initials }}</span>
        <span class="demo-user-name">{{ user.name }}</span>
        <span class="demo-user-meta">{{ user.gender }} · {{ user.city }}</span>
      </button>
    </div>
  </div>
</section>

<section class="alert-popup" *ngIf="alertService.message() as message">
  <div class="alert-popup-backdrop" (click)="alertService.close()"></div>
  <div class="alert-popup-panel" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <div class="popup-title">
        <h2>Értesítés</h2>
      </div>
      <button mat-icon-button class="popup-close" (click)="alertService.close()" aria-label="Bezárás">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="popup-body">
      <p>{{ message }}</p>
    </div>
    <div class="alert-actions">
      <button mat-stroked-button type="button" (click)="alertService.close()">Rendben</button>
    </div>
  </div>
</section>
