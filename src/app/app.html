<main class="main">
  <div class="content content-single">
    <button mat-icon-button class="user-selector-btn-global" [class.is-hidden]="showUserMenu" (click)="onUserSelect()" aria-label="Open user menu">
      <span
        class="user-initial"
        [ngClass]="['user-color-' + activeUser.gender, featuredImagePreview ? 'has-photo' : '']"
        [style.backgroundImage]="featuredImagePreview ? 'url(' + featuredImagePreview + ')' : null"
      >
        <ng-container *ngIf="!featuredImagePreview">{{ activeUser.initials }}</ng-container>
      </span>
      <span class="badge-dot" *ngIf="userBadgeCount > 0">{{ userBadgeCount }}</span>
    </button>

    <div class="user-menu-backdrop" [class.open]="showUserMenu" (click)="closeUserMenu()" *ngIf="showUserMenu"></div>

    <aside class="user-menu-panel" [class.open]="showUserMenu">
      <div
        class="user-menu-header"
        role="button"
        tabindex="0"
        (click)="onHeaderPanelClick($event)"
        (keydown.enter)="openProfileEditor()"
        (keydown.space)="openProfileEditor(); $event.preventDefault()"
      >
        <button
          type="button"
          class="user-menu-close-btn"
          aria-label="Close menu"
          (click)="$event.stopPropagation(); closeUserMenu()"
        >
          <mat-icon>close</mat-icon>
        </button>

        <div class="user-header-main">
          <div class="avatar-stack">
            <span
              class="user-avatar user-avatar-large"
              [ngClass]="['user-color-' + activeUser.gender, featuredImagePreview ? 'has-photo' : '']"
              [style.backgroundImage]="featuredImagePreview ? 'url(' + featuredImagePreview + ')' : null"
            >
              <ng-container *ngIf="!featuredImagePreview">{{ activeUser.initials }}</ng-container>
            </span>
            <span class="avatar-activity-badge" *ngIf="userBadgeCount > 0">{{ userBadgeCount }}</span>
            <span class="avatar-bottom-pill avatar-bottom-pill-header" [class]="profileStatusClass(activeUser.profileStatus)">
              <mat-icon>{{ getProfileStatusIcon(activeUser.profileStatus) }}</mat-icon>
              <span>{{ activeUser.completion }}%</span>
            </span>
          </div>

          <div class="user-meta user-meta-compact">
            <span class="user-name">{{ activeUser.name }}, {{ activeUser.age }}</span>
            <span class="user-city-line">
              <mat-icon>location_on</mat-icon>
              <span>{{ activeUser.city }}</span>
            </span>
          </div>
        </div>
        <span class="header-open-cue" aria-hidden="true">
          <mat-icon>edit</mat-icon>
        </span>
      </div>

      <div class="user-menu-content">
        <div class="social-proof-section-head section-personality activities-header impressions-menu-header">
          <span class="section-tag">
            <mat-icon>psychology</mat-icon>
            <span>Impressions</span>
          </span>
          <span class="section-line"></span>
        </div>

        <div class="impressions-shortcuts">
          <button
            class="impression-shortcut-btn"
            [ngClass]="getHostTierToneClass(activeHostTier)"
            type="button"
            (click)="openHostImpressions()"
            aria-label="Open host impressions"
            [title]="activeHostTier"
          >
            <mat-icon [class]="getHostTierColorClass(activeHostTier)">{{ getHostTierIcon(activeHostTier) }}</mat-icon>
            <span class="impression-shortcut-label">{{ activeHostTier }}</span>
          </button>

          <button
            class="impression-shortcut-btn"
            [ngClass]="getTraitToneClass(activeMemberTrait)"
            type="button"
            (click)="openMemberImpressions()"
            aria-label="Open member impressions"
            [title]="memberImpressionTitle"
          >
            <mat-icon [class]="getTraitColorClass(activeMemberTrait)">{{ getTraitIcon(activeMemberTrait) }}</mat-icon>
            <span class="impression-shortcut-label">{{ memberImpressionTitle }}</span>
          </button>
        </div>

        <div class="social-proof-section-head section-social activities-header">
          <span class="section-tag">
            <mat-icon>local_activity</mat-icon>
            <span>Activities</span>
          </span>
          <span class="section-line"></span>
        </div>

        <div class="menu-shortcuts">
          <button
            class="menu-shortcut-btn menu-shortcut-rates"
            type="button"
            (click)="openRatesShortcut()"
            aria-label="Open rates"
            title="Rates"
          >
            <mat-icon>star</mat-icon>
            <span class="menu-shortcut-label">Rates</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="gameBadge > 0">{{ gameBadge }}</span>
          </button>

          <button
            class="menu-shortcut-btn menu-shortcut-chat"
            type="button"
            (click)="openChatShortcut()"
            aria-label="Open chat"
            title="Chats"
          >
            <mat-icon>chat</mat-icon>
            <span class="menu-shortcut-label">Chats</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="chatBadge > 0">{{ chatBadge }}</span>
          </button>

          <button
            class="menu-shortcut-btn menu-shortcut-invitations"
            type="button"
            (click)="openInvitationShortcut()"
            aria-label="Open invitations"
            title="Invitations"
          >
            <mat-icon>mail</mat-icon>
            <span class="menu-shortcut-label">Invitations</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="invitationsBadge > 0">{{ invitationsBadge }}</span>
          </button>

          <button
            class="menu-shortcut-btn menu-shortcut-events"
            type="button"
            (click)="openEventShortcut()"
            aria-label="Open events"
            title="Events"
          >
            <mat-icon>event</mat-icon>
            <span class="menu-shortcut-label">Events</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="eventsBadge > 0">{{ eventsBadge }}</span>
          </button>

          <button
            class="menu-shortcut-btn menu-shortcut-hosting"
            type="button"
            (click)="openHostingShortcut()"
            aria-label="Open hosting"
            title="Hosting"
          >
            <mat-icon>stadium</mat-icon>
            <span class="menu-shortcut-label">Hosting</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="hostingBadge > 0">{{ hostingBadge }}</span>
          </button>
        </div>

        <div class="social-proof-section-head section-arts activities-header impressions-menu-header">
          <span class="section-tag">
            <mat-icon>inventory_2</mat-icon>
            <span>Assets</span>
          </span>
          <span class="section-line"></span>
        </div>

        <div class="assets-shortcuts">
          <button class="asset-shortcut-btn asset-shortcut-car" type="button" (click)="openAssetCarPopup()" aria-label="Car">
            <mat-icon>directions_car</mat-icon>
            <span class="asset-shortcut-label">Car</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="assetCarsBadge > 0">{{ assetCarsBadge }}</span>
          </button>
          <button
            class="asset-shortcut-btn asset-shortcut-accommodation"
            type="button"
            (click)="openAssetAccommodationPopup()"
            aria-label="Accommodation"
          >
            <mat-icon>apartment</mat-icon>
            <span class="asset-shortcut-label">Accommodation</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="assetAccommodationBadge > 0">{{ assetAccommodationBadge }}</span>
          </button>
          <button class="asset-shortcut-btn asset-shortcut-supplies" type="button" (click)="openAssetSuppliesPopup()" aria-label="Supplies">
            <mat-icon>inventory_2</mat-icon>
            <span class="asset-shortcut-label">Supplies</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="assetSuppliesBadge > 0">{{ assetSuppliesBadge }}</span>
          </button>
        </div>
      </div>
    </aside>

    <section class="content-area content-area-full">
      <router-outlet></router-outlet>
    </section>
  </div>
</main>

<section class="app-popup" *ngIf="activePopup && activePopup !== 'logoutConfirm'">
  <div class="app-popup-backdrop" (click)="closePopup()"></div>
  <div
    class="app-popup-panel"
    [class.popup-panel-members]="activePopup === 'chatMembers'"
    [class.popup-panel-image-editor]="activePopup === 'imageEditor'"
    [class.popup-panel-profile-editor]="activePopup === 'profileEditor'"
    [class.popup-panel-assets]="isAssetPopup"
    [class.popup-panel-activities]="activePopup === 'activities'"
    (click)="$event.stopPropagation()"
  >
    <div class="popup-header" [class.popup-header-chat]="activePopup === 'chat' && selectedChat">
      <div class="popup-title popup-title-chat" *ngIf="activePopup === 'chat' && selectedChat; else defaultPopupTitle">
        <div class="popup-chat-title-block">
          <h2>{{ selectedChat.title }}</h2>
        </div>
        <button class="chat-members-stack chat-members-stack-large chat-header-members" type="button" (click)="openChatMembers(selectedChat, $event, true)">
          <span class="chat-stack-avatar" *ngFor="let member of getChatVisibleMembers(selectedChat); let i = index" [class]="'user-color-' + member.gender" [style.zIndex]="30 - i">{{ member.initials }}</span>
          <span class="chat-stack-more" *ngIf="getChatHiddenMemberCount(selectedChat) > 0">+{{ getChatHiddenMemberCount(selectedChat) }}</span>
        </button>
      </div>
      <ng-template #defaultPopupTitle>
        <div class="popup-title popup-title-members" *ngIf="activePopup === 'chatMembers'; else defaultPlainTitle">
          <div class="popup-chat-title-block">
            <h2>Chat Members</h2>
            <p>{{ selectedChatMembersItem?.title || 'Room' }}</p>
          </div>
        </div>
        <ng-template #defaultPlainTitle>
          <div class="popup-title popup-title-impressions" *ngIf="activePopup === 'impressionsHost'; else plainPopupTitle">
            <div class="popup-chat-title-block">
              <h2>Impressions</h2>
            </div>
          </div>
          <ng-template #plainPopupTitle>
            <div class="popup-title">
              <h2>{{ getPopupTitle() }}</h2>
              <p class="popup-subtitle-activities" *ngIf="activePopup === 'activities'">{{ activitiesHeaderLineOne() }}</p>
              <p class="popup-subtitle-activities popup-subtitle-activities-secondary" *ngIf="activePopup === 'activities' && activitiesHeaderLineTwo()">
                {{ activitiesHeaderLineTwo() }}
              </p>
            </div>
          </ng-template>
        </ng-template>
      </ng-template>
      <span class="header-members-count" *ngIf="activePopup === 'chatMembers'">{{ selectedChatMembers.length }} members</span>
      <button
        type="button"
        class="popup-chat-event-btn"
        aria-label="Open event editor"
        *ngIf="activePopup === 'chat' && selectedChat"
        (click)="openEventEditor(true)"
      >
        <mat-icon>edit_calendar</mat-icon>
      </button>
      <button
        type="button"
        class="popup-chat-event-btn popup-invitation-approve-btn"
        aria-label="Approve invitation"
        *ngIf="activePopup === 'invitationActions' && selectedInvitation && !selectedInvitationIsAccepted()"
        (click)="approveSelectedInvitation($event)"
      >
        <mat-icon>done</mat-icon>
      </button>
      <div class="activities-view-picker" *ngIf="activePopup === 'activities'">
        <div class="activities-secondary-picker" *ngIf="!isCalendarLayoutView()">
          <button type="button" class="popup-view-fab" (click)="toggleActivitiesSecondaryPicker($event)" [attr.aria-label]="'Open secondary filter: ' + activitiesSecondaryFilterLabel()">
            <mat-icon>{{ activitiesSecondaryFilterIcon() }}</mat-icon>
            <span>{{ activitiesSecondaryFilterLabel() }}</span>
          </button>
          <div class="activities-view-picker-panel" *ngIf="showActivitiesSecondaryPicker">
            <button type="button" class="activities-view-option" *ngFor="let option of activitiesSecondaryFilters" (click)="selectActivitiesSecondaryFilter(option.key)">
              <mat-icon>{{ option.icon }}</mat-icon>
              <span>{{ option.label }}</span>
            </button>
          </div>
        </div>

        <button type="button" class="popup-view-fab" (click)="toggleActivitiesViewPicker($event)" [attr.aria-label]="'Open view selector: ' + activityViewLabel()">
          <mat-icon>view_agenda</mat-icon>
          <span>{{ activityViewLabel() }}</span>
        </button>
        <div class="activities-view-picker-panel" *ngIf="showActivitiesViewPicker">
          <button type="button" class="activities-view-option" *ngFor="let option of activitiesViewOptions" (click)="setActivitiesView(option.key, $event)">
            <mat-icon>{{ option.icon }}</mat-icon>
            <span>{{ option.label }}</span>
          </button>
        </div>
      </div>
      <button mat-icon-button class="popup-close" (click)="closePopup()" aria-label="Close">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div
      class="popup-body"
      [class.popup-body-chat]="activePopup === 'chat' && selectedChat"
      [class.popup-body-members]="activePopup === 'chatMembers'"
      [class.popup-body-impressions]="activePopup === 'impressionsHost'"
      [class.popup-body-image-editor]="activePopup === 'imageEditor'"
    >
      <div *ngIf="activePopup === 'activities'" class="activities-popup" (click)="onActivitiesPopupSurfaceClick($event)">
        <div class="experience-toolbar assets-toolbar">
          <ng-container *ngIf="!isMobileView; else mobileActivitiesPrimaryFilterButton">
            <div class="profile-status-select-wrap selector-like experience-filter-select activities-compact-select activities-primary-filter-select" [ngClass]="activitiesPrimaryFilterClass(activitiesPrimaryFilter)">
              <mat-select
                [(ngModel)]="activitiesPrimaryFilter"
                (ngModelChange)="selectActivitiesPrimaryFilter($event)"
                [panelWidth]="activitiesPrimaryPanelWidth()"
                disableOptionCentering
                panelClass="selector-options-panel profile-bottom-sheet-panel activities-primary-options-panel"
              >
                <mat-select-trigger>
                  <span class="status-option-content">
                    <mat-icon [class]="activitiesPrimaryFilterClass(activitiesPrimaryFilter)">{{ activitiesPrimaryFilterIcon() }}</mat-icon>
                    <span>{{ activitiesPrimaryFilterLabel() }}</span>
                  </span>
                </mat-select-trigger>
                <mat-option *ngFor="let option of activitiesPrimaryFilters" [value]="option.key" class="status-option" [ngClass]="activitiesPrimaryFilterClass(option.key)">
                  <span class="status-option-content">
                    <mat-icon [class]="activitiesPrimaryFilterClass(option.key)">{{ option.icon }}</mat-icon>
                    <span>{{ option.label }}</span>
                    <span class="rate-filter-count-badge" *ngIf="activitiesPrimaryFilterCount(option.key) > 0">{{ activitiesPrimaryFilterCount(option.key) }}</span>
                  </span>
                </mat-option>
              </mat-select>
              <span class="rate-filter-count-badge rate-filter-trigger-badge" *ngIf="activitiesPrimaryFilterCount(activitiesPrimaryFilter) > 0">{{ activitiesPrimaryFilterCount(activitiesPrimaryFilter) }}</span>
            </div>
          </ng-container>
          <ng-template #mobileActivitiesPrimaryFilterButton>
            <button
              type="button"
              class="profile-status-select-wrap selector-like experience-filter-select activities-compact-select activities-primary-filter-select"
              [ngClass]="activitiesPrimaryFilterClass(activitiesPrimaryFilter)"
              (click)="openMobileActivitiesPrimaryFilterSelector($event)"
            >
              <span class="status-option-content">
                <mat-icon [class]="activitiesPrimaryFilterClass(activitiesPrimaryFilter)">{{ activitiesPrimaryFilterIcon() }}</mat-icon>
                <span>{{ activitiesPrimaryFilterLabel() }}</span>
              </span>
              <mat-icon>expand_more</mat-icon>
              <span class="rate-filter-count-badge rate-filter-trigger-badge" *ngIf="activitiesPrimaryFilterCount(activitiesPrimaryFilter) > 0">{{ activitiesPrimaryFilterCount(activitiesPrimaryFilter) }}</span>
            </button>
          </ng-template>

          <ng-container *ngIf="isRateFilterVisible()">
            <ng-container *ngIf="!isMobileView; else mobileActivitiesRateFilterButton">
              <div
                class="profile-status-select-wrap selector-like experience-filter-select activities-compact-select activities-rate-filter-select"
                [ngClass]="[activitiesRateFilterClass(activitiesRateFilter), rateFilterOptionClass(activitiesRateFilter)]"
              >
                <mat-select
                  [(ngModel)]="activitiesRateFilter"
                  (ngModelChange)="selectActivitiesRateFilter($event)"
                  [panelWidth]="activitiesRatePanelWidth()"
                  disableOptionCentering
                  panelClass="selector-options-panel profile-bottom-sheet-panel activities-rate-options-panel"
                >
                  <mat-select-trigger>
                    <span class="status-option-content">
                      <mat-icon [class]="[activitiesRateFilterClass(activitiesRateFilter), rateFilterOptionClass(activitiesRateFilter)]">{{ activitiesRateFilterIcon(activitiesRateFilter) }}</mat-icon>
                      <span>{{ activitiesRateFilterLabel() }}</span>
                    </span>
                  </mat-select-trigger>
                  <ng-container *ngFor="let option of rateFilterEntries">
                    <mat-option *ngIf="option.kind === 'group'" class="status-option rate-filter-group-option" [class.is-group-separator]="isRateGroupSeparator(option.label)" disabled>
                      <span class="status-option-content rate-filter-group-label">
                        <span>{{ option.label }}</span>
                      </span>
                    </mat-option>
                    <mat-option
                      *ngIf="option.kind === 'item'"
                      [value]="option.key"
                      class="status-option"
                      [ngClass]="[activitiesRateFilterClass(option.key), rateFilterOptionClass(option.key)]"
                    >
                      <span class="status-option-content">
                        <mat-icon [class]="[activitiesRateFilterClass(option.key), rateFilterOptionClass(option.key)]">{{ activitiesRateFilterIcon(option.key) }}</mat-icon>
                        <span>{{ option.label }}</span>
                        <span class="rate-filter-count-badge" *ngIf="rateFilterCount(option.key) > 0">{{ rateFilterCount(option.key) }}</span>
                      </span>
                    </mat-option>
                  </ng-container>
                </mat-select>
                <span class="rate-filter-count-badge rate-filter-trigger-badge" *ngIf="totalRateFilterCount() > 0">{{ totalRateFilterCount() }}</span>
              </div>
            </ng-container>
            <ng-template #mobileActivitiesRateFilterButton>
              <button
                type="button"
                class="profile-status-select-wrap selector-like experience-filter-select activities-compact-select activities-rate-filter-select"
                [ngClass]="[activitiesRateFilterClass(activitiesRateFilter), rateFilterOptionClass(activitiesRateFilter)]"
                (click)="openMobileActivitiesRateFilterSelector($event)"
              >
                <span class="status-option-content">
                  <mat-icon [class]="[activitiesRateFilterClass(activitiesRateFilter), rateFilterOptionClass(activitiesRateFilter)]">{{ activitiesRateFilterIcon(activitiesRateFilter) }}</mat-icon>
                  <span>{{ activitiesRateFilterLabel() }}</span>
                </span>
                <mat-icon>expand_more</mat-icon>
                <span class="rate-filter-count-badge rate-filter-trigger-badge" *ngIf="totalRateFilterCount() > 0">{{ totalRateFilterCount() }}</span>
              </button>
            </ng-template>
          </ng-container>
        </div>

        <ng-container *ngIf="!isCalendarLayoutView(); else activitiesCalendarLayout">
          <div class="experience-card-list assets-card-list activities-scroll-list" [class.activities-scroll-list-with-rate-editor]="isActivityRateEditorOpen()" #activitiesScroll (scroll)="onActivitiesScroll($event)">
            <div class="activities-sticky-header">{{ activitiesStickyHeader }}</div>

            <ng-container *ngFor="let group of groupedActivityRows; let groupIndex = index">
              <div class="activities-group-marker" *ngIf="groupIndex > 0" [attr.data-group-label]="group.label">{{ group.label }}</div>

              <ng-container *ngFor="let row of group.rows">
                <article class="experience-item-card asset-item-card activities-row-item" [attr.data-group-label]="group.label" *ngIf="isEventStyleActivity(row); else nonEventActivityRow">
                  <div class="asset-card-image" [style.backgroundImage]="'url(' + activityImageUrl(row) + ')'">
                    <a
                      class="asset-source-icon activities-source-avatar"
                      *ngIf="showActivitySourceIcon(row)"
                      [href]="activitySourceLink(row)"
                      target="_blank"
                      rel="noopener"
                      (click)="$event.stopPropagation()"
                      aria-label="Open source link"
                      [ngClass]="activitySourceAvatarClass(row)"
                    >
                      <span>{{ activitySourceAvatarLabel(row) }}</span>
                    </a>
                    <button
                      type="button"
                      class="asset-occupancy-badge"
                      (click)="openActivityMembers(row, $event)"
                      aria-label="Open members"
                    >
                      <span>{{ activityCapacityLabel(row) }}</span>
                      <ng-container *ngIf="activityPendingMemberCount(row) as pendingMemberCount">
                        <span class="card-badge asset-request-badge" *ngIf="pendingMemberCount > 0">{{ pendingMemberCount }}</span>
                      </ng-container>
                    </button>
                  </div>
                  <div class="experience-item-head">
                    <span class="experience-item-icon">
                      <mat-icon>{{ activityTypeIcon(row) }}</mat-icon>
                    </span>
                    <div class="experience-item-meta">
                      <h4>{{ row.title }}</h4>
                      <p>{{ activityMetaLine(row) }}</p>
                    </div>
                    <div class="experience-item-actions" *ngIf="canManageActivityRow(row)">
                      <button
                        type="button"
                        class="experience-action-btn experience-action-edit"
                        (click)="$event.stopPropagation(); openActivityPrimaryAction(row)"
                        [attr.aria-label]="activityPrimaryActionLabel(row)"
                      >
                        <mat-icon>{{ activityPrimaryActionIcon(row) }}</mat-icon>
                      </button>
                      <button
                        type="button"
                        class="experience-action-btn experience-action-delete"
                        [class.experience-action-exit]="isExitActivityRow(row)"
                        (click)="$event.stopPropagation(); triggerActivitySecondaryAction(row)"
                        [attr.aria-label]="activitySecondaryActionLabel(row)"
                      >
                        <mat-icon>{{ activitySecondaryActionIcon(row) }}</mat-icon>
                      </button>
                    </div>
                  </div>
                  <p class="experience-item-description">{{ row.subtitle }}</p>
                </article>

                <ng-template #nonEventActivityRow>
                  <button
                    type="button"
                    class="activities-card activities-card-btn activities-row-item"
                    [attr.data-group-label]="group.label"
                    [class.activities-card-chat]="isActivityChatRow(row)"
                    [class.activities-card-rate]="isRateStyleActivity(row)"
                    [class.activities-card-rates]="row.type === 'rates'"
                    (pointerup)="onActivityRowPointerUp(row, $event)"
                    (click)="onActivityRowClick(row, $event)"
                  >
                    <span class="activities-card-avatar" [class]="activityRowAvatarClass(row)">
                      {{ activityRowAvatarInitials(row) }}
                    </span>

                    <div class="activities-card-main" *ngIf="isActivityChatRow(row)">
                      <p class="activities-card-title">{{ row.title }}</p>
                      <p class="activities-card-subtitle">{{ row.subtitle }}</p>
                      <p class="activities-card-detail">{{ row.detail }}</p>
                    </div>
                    <span class="activities-chat-members-badge" *ngIf="isActivityChatRow(row)">
                      <span>{{ activityChatMemberCount(row) }} members</span>
                      <span class="card-badge asset-request-badge activities-chat-unread-badge" *ngIf="row.unread > 0">{{ row.unread }}</span>
                    </span>

                    <div class="activities-rate-card-body" *ngIf="row.type === 'rates'">
                      <p class="activities-event-title">{{ row.title }}</p>
                      <div class="activities-rate-card-head">
                        <button
                          type="button"
                          class="activities-rate-score-badge"
                          [class.is-pending]="isActivityRatePending(row)"
                          [class.is-disabled]="isPairReceivedRateRow(row)"
                          (pointerup)="$event.stopPropagation()"
                          (click)="isPairReceivedRateRow(row) ? $event.stopPropagation() : openActivityRateEditor(row, $event)"
                          [attr.aria-label]="isPairReceivedRateRow(row) ? 'Received pair rating' : (isActivityRatePending(row) ? 'Add your rating' : 'Edit your rating')"
                        >
                          <span class="activities-rate-score-star">★</span>
                          <span *ngIf="activityOwnRatingLabel(row) as ownRatingLabel">{{ ownRatingLabel }}</span>
                        </button>
                      </div>
                    </div>
                  </button>
                </ng-template>
              </ng-container>
            </ng-container>

            <div class="editor-list-card" *ngIf="filteredActivityRows.length === 0">
              <h4>No items</h4>
              <p>{{ activitiesEmptyLabel }}</p>
            </div>
          </div>
        </ng-container>

        <ng-template #activitiesCalendarLayout>
          <div
            class="activities-calendar-scroll"
            [class.activities-calendar-scroll-month]="activitiesView === 'month'"
            [class.activities-calendar-scroll-week]="activitiesView === 'week'"
            #activitiesCalendarScroll
            (scroll)="onActivitiesCalendarScroll($event)"
          >
            <ng-container *ngIf="activitiesView === 'month'; else activitiesWeekPages">
              <section
                class="activities-calendar-page activities-calendar-page-month"
                *ngFor="let page of calendarMonthPages; let pageIndex = index"
                [style.--month-week-count]="page.weeks.length"
              >
                <header class="activities-calendar-page-head">
                  <span class="activities-calendar-page-head-label">{{ page.label }}</span>
                  <span class="activities-calendar-page-head-nav" *ngIf="!isMobileView">
                    <button
                      type="button"
                      class="activities-calendar-nav-btn"
                      (click)="navigateActivitiesCalendarTo(pageIndex - 1, $event)"
                      [disabled]="pageIndex === 0"
                      aria-label="Previous period"
                    >
                      <mat-icon>chevron_left</mat-icon>
                    </button>
                    <button
                      type="button"
                      class="activities-calendar-nav-btn"
                      (click)="navigateActivitiesCalendarTo(pageIndex + 1, $event)"
                      [disabled]="pageIndex >= calendarMonthPages.length - 1"
                      aria-label="Next period"
                    >
                      <mat-icon>chevron_right</mat-icon>
                    </button>
                  </span>
                </header>
                <div class="activities-calendar-weekdays">
                  <span *ngFor="let dayLabel of calendarWeekdayLabels">{{ dayLabel }}</span>
                </div>
                <div class="activities-month-grid">
                  <div class="activities-month-week" *ngFor="let week of page.weeks">
                    <div
                      class="activities-month-cell"
                      *ngFor="let day of week.days"
                      [class.outside]="!day.inCurrentMonth"
                      [class.today]="day.isToday"
                      [class.activities-month-cell-rates]="activitiesPrimaryFilter === 'rates'"
                    >
                      <div class="activities-month-day-num">{{ day.dayNumber }}</div>
                      <div
                        class="activities-month-rate-count"
                        *ngIf="activitiesPrimaryFilter === 'rates' && monthRateCount(day) as rateCount"
                        [ngClass]="monthRateHeatClass(day)"
                      >
                        {{ rateCountLabel(rateCount) }}
                      </div>
                    </div>
                    <div class="activities-month-week-spans" *ngIf="activitiesPrimaryFilter !== 'rates' && week.spans.length > 0">
                      <button
                        type="button"
                        class="activities-calendar-badge activities-month-span-badge"
                        [ngClass]="calendarBadgeToneClass(span.row)"
                        *ngFor="let span of week.spans"
                        [style.left.%]="(span.startCol * 100) / 7"
                        [style.width.%]="((span.endCol - span.startCol + 1) * 100) / 7"
                        [style.top.px]="18 + (span.lane * 20)"
                        (click)="onActivityRowClick(span.row, $event)"
                      >
                        <span>{{ span.row.title }}</span>
                      </button>
                    </div>
                  </div>
                </div>
              </section>
            </ng-container>

            <ng-template #activitiesWeekPages>
              <section class="activities-calendar-page activities-calendar-page-week" *ngFor="let page of calendarWeekPages; let pageIndex = index">
                <header class="activities-calendar-page-head">
                  <span class="activities-calendar-page-head-label">{{ page.label }}</span>
                  <span class="activities-calendar-page-head-nav" *ngIf="!isMobileView">
                    <button
                      type="button"
                      class="activities-calendar-nav-btn"
                      (click)="navigateActivitiesCalendarTo(pageIndex - 1, $event)"
                      [disabled]="pageIndex === 0"
                      aria-label="Previous period"
                    >
                      <mat-icon>chevron_left</mat-icon>
                    </button>
                    <button
                      type="button"
                      class="activities-calendar-nav-btn"
                      (click)="navigateActivitiesCalendarTo(pageIndex + 1, $event)"
                      [disabled]="pageIndex >= calendarWeekPages.length - 1"
                      aria-label="Next period"
                    >
                      <mat-icon>chevron_right</mat-icon>
                    </button>
                  </span>
                </header>
                <div class="activities-week-board">
                  <div class="activities-week-board-corner"></div>
                  <div class="activities-week-board-day-head" *ngFor="let day of page.days; let dayIndex = index" [class.today]="day.isToday">
                    <span>{{ calendarWeekdayLabels[dayIndex] }}</span>
                    <strong>{{ day.dayNumber }}</strong>
                    <div
                      class="activities-week-rate-count"
                      *ngIf="activitiesPrimaryFilter === 'rates' && weekRateDayCount(day) as rateCount"
                      [ngClass]="weekRateDayHeatClass(day)"
                    >
                      {{ rateCountLabel(rateCount) }}
                    </div>
                  </div>

                  <div class="activities-week-hours-col">
                    <div class="activities-week-hour-label" *ngFor="let hour of calendarWeekHours">
                      {{ weekHourLabel(hour) }}
                    </div>
                  </div>

                  <div class="activities-week-day-col" *ngFor="let day of page.days" [class.today]="day.isToday" [class.activities-week-day-col-rates]="activitiesPrimaryFilter === 'rates'">
                    <ng-container *ngIf="activitiesPrimaryFilter === 'rates'; else weekEventBadges">
                      <div
                        class="activities-week-hour-slot activities-week-rate-slot"
                        *ngFor="let hour of calendarWeekHours"
                      >
                        <div
                          class="activities-week-rate-badge"
                          *ngIf="weekRateHourCount(day, hour) as hourCount"
                          [ngClass]="rateHeatClassByCount(hourCount)"
                        >
                          {{ rateCountLabel(hourCount) }}
                        </div>
                      </div>
                    </ng-container>
                    <ng-template #weekEventBadges>
                      <div class="activities-week-hour-slot" *ngFor="let hour of calendarWeekHours"></div>
                      <button
                        type="button"
                        class="activities-calendar-badge activities-week-timed-badge"
                        [ngClass]="calendarBadgeToneClass(badge.row)"
                        *ngFor="let badge of weekDayTimedBadges(day)"
                        [style.top.%]="badge.topPct"
                        [style.height.%]="badge.heightPct"
                        (click)="onActivityRowClick(badge.row, $event)"
                      >
                        <span>{{ badge.row.title }}</span>
                      </button>
                    </ng-template>
                  </div>
                </div>
              </section>
            </ng-template>

            <div class="editor-list-card" *ngIf="filteredActivityRows.length === 0">
              <h4>No items</h4>
              <p>{{ activitiesEmptyLabel }}</p>
            </div>
          </div>
        </ng-template>

        <div class="activities-rate-editor-dock" *ngIf="isActivityRateEditorOpen() && !isCalendarLayoutView()">
          <div class="activities-rate-editor-head">
            <span>Rate · {{ selectedActivityRateModeLabel() }} · {{ selectedActivityRateTitle() }}</span>
          </div>
          <div class="activities-rate-editor-stars">
            <button
              type="button"
              class="activities-rate-star-btn"
              *ngFor="let score of activityRatingScale"
              [class.filled]="isSelectedActivityRateScore(score)"
              (click)="setSelectedActivityOwnRating(score)"
              [attr.aria-label]="'Set rating ' + score"
            >
              ★
            </button>
          </div>
        </div>

        <section class="experience-delete-confirm" *ngIf="pendingActivityDeleteRow">
          <div class="experience-delete-confirm-backdrop" (click)="cancelActivityDelete()"></div>
          <div class="experience-delete-confirm-panel">
            <h4>{{ pendingActivityConfirmTitle() }}</h4>
            <p>{{ pendingActivityDeleteLabel() }}</p>
            <div class="popup-actions">
              <button type="button" class="link-btn neutral-btn" (click)="cancelActivityDelete()">Cancel</button>
              <button type="button" class="link-btn experience-delete-btn" (click)="confirmActivityDelete()">{{ pendingActivityConfirmActionLabel() }}</button>
            </div>
          </div>
        </section>
      </div>

      <div *ngIf="activePopup === 'chat' && selectedChat" class="chat-popup-wrap">
        <div class="chat-popup-box">
          <div class="chat-thread">
            <article class="chat-message" *ngFor="let message of chatPopupMessages" [class.mine]="message.mine">
              <div class="chat-bubble">
                <span class="chat-sender-avatar" [class]="'user-color-' + message.senderAvatar.gender">{{ message.senderAvatar.initials }}</span>
                <div class="chat-message-content">
                  <div class="chat-meta-row">
                    <span class="chat-sender-name">{{ message.sender }}</span>
                    <span class="chat-time-chip">{{ message.time }}</span>
                  </div>
                  <p class="chat-line">{{ message.text }}</p>
                </div>
                <div class="chat-readers" *ngIf="message.readBy.length > 0">
                  <span class="chat-reader" *ngFor="let reader of message.readBy" [class]="'user-color-' + reader.gender">{{ reader.initials }}</span>
                </div>
              </div>
            </article>
          </div>
          <div class="chat-compose-box">
            <textarea rows="3" placeholder="Write message"></textarea>
            <button type="button" class="chat-send-btn" aria-label="Send message">
              <mat-icon>send</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'chatMembers'">
        <div class="chat-members-popup-list">
          <div class="chat-members-popup-row" *ngFor="let member of selectedChatMembers">
            <span class="chat-members-popup-avatar" [class]="'user-color-' + member.gender">{{ member.initials }}</span>
            <div class="chat-members-popup-meta">
              <p class="member-name">{{ member.name }}, {{ member.age }}</p>
              <p class="member-city">{{ member.city }}</p>
              <p class="member-action">{{ chatMemberActionDate(member) }}</p>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'invitationActions' && selectedInvitation">
        <div class="editor-list-card">
          <h4>{{ selectedInvitation.description }}</h4>
          <p>{{ getInvitationActionSummary(selectedInvitation) }} · {{ selectedInvitation.when }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn" (click)="deleteSelectedInvitation($event)">Delete</button>
          <button type="button" class="link-btn" (click)="openEventEditor()">Open Related Event</button>
        </div>
      </div>

      <div *ngIf="activePopup === 'menuEvent' && selectedEvent">
        <div class="editor-list-card">
          <h4>{{ selectedEvent.title }}</h4>
          <p>{{ selectedEvent.shortDescription }}</p>
          <p>{{ selectedEvent.timeframe }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn" (click)="openEventEditor()" *ngIf="selectedEvent.isAdmin">Edit Event</button>
          <button type="button" class="link-btn" *ngIf="!selectedEvent.isAdmin">Exit Event</button>
          <button type="button" class="link-btn">Open Event Chat</button>
        </div>
      </div>

      <div *ngIf="activePopup === 'hostingEvent' && selectedHostingEvent">
        <div class="editor-list-card">
          <h4>{{ selectedHostingEvent.title }}</h4>
          <p>{{ selectedHostingEvent.shortDescription }}</p>
          <p>{{ selectedHostingEvent.timeframe }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn">Accept Join Requests</button>
          <button type="button" class="link-btn" (click)="openEventEditor()">Edit Hosted Event</button>
        </div>
      </div>

      <ng-container *ngIf="activePopup === 'impressionsHost'">
        <ng-container *ngTemplateOutlet="impressionsHostTemplate"></ng-container>
      </ng-container>

      <ng-template #impressionsHostTemplate>
        <div class="social-proof-grid">
          <div class="editor-list-card social-proof-card social-proof-card-modern social-proof-card-host">
            <div class="social-proof-identity-pill social-proof-identity-pill-host">
              <mat-icon [class]="getHostTierColorClass(activeHostTier)">{{ getHostTierIcon(activeHostTier) }}</mat-icon>
              <span>{{ activeHostTier }}</span>
            </div>
            <div class="popup-impressions-badge popup-impressions-badge-host">
              <span class="popup-impressions-badge-segment popup-impressions-rate-rate">
                <span class="popup-impressions-badge-label">Rate</span>
                <span class="popup-impressions-badge-value">{{ hostAverageRating }}</span>
              </span>
              <span class="popup-impressions-badge-segment popup-impressions-rate-people">
                <span class="popup-impressions-badge-label">People / Events</span>
                <span class="popup-impressions-badge-value">{{ hostPeopleMet + ' / ' + hostTotalEvents }}</span>
              </span>
              <span class="popup-impressions-badge-segment popup-impressions-rate-return">
                <span class="popup-impressions-badge-label">Returnees / NoShow</span>
                <span class="popup-impressions-badge-value">{{ hostRepeatSummary + ' / ' + hostAttendanceNoShowSummary }}</span>
              </span>
            </div>

            <div class="social-proof-section-block">
              <div class="social-proof-section-head section-vibe">
                <span class="section-tag">Vibe</span>
                <span class="section-line"></span>
              </div>
              <div class="social-proof-chip-list">
                <span class="social-proof-chip chip-vibe" *ngFor="let item of hostVibeBadgeItems">{{ item }}</span>
              </div>
            </div>

            <div class="social-proof-section-block">
              <div class="social-proof-section-head section-category">
                <span class="section-tag">Category</span>
                <span class="section-line"></span>
              </div>
              <div class="social-proof-chip-list">
                <span class="social-proof-chip chip-category" *ngFor="let item of hostCategoryBadgeItems">{{ item }}</span>
              </div>
            </div>
          </div>

          <div class="editor-list-card social-proof-card social-proof-card-modern social-proof-card-member">
            <div class="social-proof-identity-pill social-proof-identity-pill-member">
              <mat-icon [class]="getTraitColorClass(activeMemberTrait)">{{ getTraitIcon(activeMemberTrait) }}</mat-icon>
              <span>{{ memberImpressionTitle }}</span>
            </div>
            <div class="popup-impressions-badge popup-impressions-badge-member">
              <span class="popup-impressions-badge-segment popup-impressions-rate-people">
                <span class="popup-impressions-badge-label">People / Events</span>
                <span class="popup-impressions-badge-value">{{ memberPeopleMet + ' / ' + memberTotalEvents }}</span>
              </span>
              <span class="popup-impressions-badge-segment popup-impressions-rate-return">
                <span class="popup-impressions-badge-label">Returnees / NoShow</span>
                <span class="popup-impressions-badge-value">{{ memberReturneesSummary + ' / ' + memberNoShowCount }}</span>
              </span>
            </div>

            <div class="social-proof-section-block">
              <div class="social-proof-section-head section-personality">
                <span class="section-tag">Personality</span>
                <span class="section-line"></span>
              </div>
              <div class="social-proof-chip-list">
                <span class="social-proof-chip chip-personality" *ngFor="let item of memberPersonalityBadgeItems">{{ item }}</span>
              </div>
            </div>

            <div class="social-proof-section-block">
              <div class="social-proof-section-head section-vibe">
                <span class="section-tag">Vibe</span>
                <span class="section-line"></span>
              </div>
              <div class="social-proof-chip-list">
                <span class="social-proof-chip chip-vibe" *ngFor="let item of memberVibeBadgeItems">{{ item }}</span>
              </div>
            </div>

            <div class="social-proof-section-block">
              <div class="social-proof-section-head section-category">
                <span class="section-tag">Category</span>
                <span class="section-line"></span>
              </div>
              <div class="social-proof-chip-list">
                <span class="social-proof-chip chip-category" *ngFor="let item of memberCategoryBadgeItems">{{ item }}</span>
              </div>
            </div>
          </div>
        </div>
      </ng-template>

      <div *ngIf="isAssetPopup" class="experience-popup assets-popup">
        <div class="experience-toolbar assets-toolbar">
          <ng-container *ngIf="!isMobileView; else mobileAssetFilterButton">
            <div class="profile-status-select-wrap selector-like experience-filter-select assets-compact-select" [ngClass]="assetTypeClass(assetFilter)">
              <mat-select
                [(ngModel)]="assetFilter"
                (ngModelChange)="selectAssetFilter($event)"
                [panelWidth]="assetFilterPanelWidth()"
                disableOptionCentering
                panelClass="selector-options-panel profile-bottom-sheet-panel assets-filter-options-panel"
              >
                <mat-select-trigger>
                  <span class="status-option-content">
                    <mat-icon [class]="assetTypeClass(assetFilter)">{{ assetTypeIcon(assetFilter) }}</mat-icon>
                    <span>{{ assetFilter }}</span>
                  </span>
                </mat-select-trigger>
                <mat-option *ngFor="let option of assetFilterOptions" [value]="option" class="status-option" [ngClass]="assetTypeClass(option)">
                  <span class="status-option-content">
                    <mat-icon [class]="assetTypeClass(option)">{{ assetTypeIcon(option) }}</mat-icon>
                    <span>{{ option }}</span>
                    <span class="rate-filter-count-badge" *ngIf="assetFilterCount(option) > 0">{{ assetFilterCount(option) }}</span>
                  </span>
                </mat-option>
              </mat-select>
              <span class="rate-filter-count-badge rate-filter-trigger-badge" *ngIf="assetFilterCount(assetFilter) > 0">{{ assetFilterCount(assetFilter) }}</span>
            </div>
          </ng-container>
          <ng-template #mobileAssetFilterButton>
            <button
              type="button"
              class="profile-status-select-wrap selector-like experience-filter-select assets-compact-select"
              [ngClass]="assetTypeClass(assetFilter)"
              (click)="openMobileAssetFilterSelector($event)"
            >
              <span class="status-option-content">
                <mat-icon [class]="assetTypeClass(assetFilter)">{{ assetTypeIcon(assetFilter) }}</mat-icon>
                <span>{{ assetFilter }}</span>
              </span>
              <mat-icon>expand_more</mat-icon>
              <span class="rate-filter-count-badge rate-filter-trigger-badge" *ngIf="assetFilterCount(assetFilter) > 0">{{ assetFilterCount(assetFilter) }}</span>
            </button>
          </ng-template>
          <button type="button" class="popup-header-add-btn assets-add-btn" (click)="openAssetForm()" aria-label="Add asset">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <div class="experience-card-list assets-card-list">
          <article class="experience-item-card asset-item-card" [ngClass]="assetTypeClass(card.type)" *ngFor="let card of filteredAssetCards">
            <div class="asset-card-image" [style.backgroundImage]="'url(' + card.imageUrl + ')'">
              <a class="asset-source-icon" [href]="card.sourceLink" target="_blank" rel="noopener" (click)="$event.stopPropagation()" aria-label="Open source link">
                <mat-icon>link</mat-icon>
              </a>
                <button
                  type="button"
                  class="asset-occupancy-badge"
                  *ngIf="canManageAssetMembers(card)"
                  (click)="openAssetMembers(card, $event)"
                  aria-label="Open member requests"
                >
                  <span>{{ assetOccupancyLabel(card) }}</span>
                  <span class="card-badge asset-request-badge" *ngIf="assetPendingCount(card) > 0">{{ assetPendingCount(card) }}</span>
                </button>
              </div>
            <div class="experience-item-head">
              <span class="experience-item-icon">
                <mat-icon>{{ assetTypeIcon(card.type) }}</mat-icon>
              </span>
              <div class="experience-item-meta">
                <h4>{{ card.title }}</h4>
                <p>{{ card.type }} · {{ card.subtitle }} · {{ card.city }}</p>
              </div>
              <div class="experience-item-actions">
                <button type="button" class="experience-action-btn experience-action-edit" (click)="$event.stopPropagation(); openAssetForm(card)" aria-label="Edit asset">
                  <mat-icon>edit</mat-icon>
                </button>
                <button type="button" class="experience-action-btn experience-action-delete" (click)="$event.stopPropagation(); requestAssetDelete(card.id)" aria-label="Delete asset">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
            <p class="experience-item-description">{{ card.details }}</p>
          </article>
        </div>

        <section class="experience-form-overlay asset-form-overlay" *ngIf="showAssetForm">
          <div class="experience-form-overlay-backdrop" (click)="closeAssetForm()"></div>
          <div class="experience-form-popup asset-form-popup">
            <div class="experience-form-header">
              <h3>{{ assetFormTitle }}</h3>
              <button type="button" class="experience-form-close-btn" (click)="closeAssetForm()" aria-label="Close asset form">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <section class="experience-form-panel">
              <div class="experience-form-grid">
                <label>
                  <span>Type</span>
                  <div class="profile-status-select-wrap selector-like experience-type-select" [ngClass]="assetTypeClass(assetForm.type)">
                    <mat-select [(ngModel)]="assetForm.type" disableOptionCentering panelClass="selector-options-panel profile-bottom-sheet-panel">
                      <mat-select-trigger>
                        <span class="status-option-content">
                          <mat-icon [class]="assetTypeClass(assetForm.type)">{{ assetTypeIcon(assetForm.type) }}</mat-icon>
                          <span>{{ assetForm.type }}</span>
                        </span>
                      </mat-select-trigger>
                      <mat-option *ngFor="let option of assetFilterOptions" [value]="option" class="status-option" [ngClass]="assetTypeClass(option)">
                        <span class="status-option-content">
                          <mat-icon [class]="assetTypeClass(option)">{{ assetTypeIcon(option) }}</mat-icon>
                          <span>{{ option }}</span>
                        </span>
                      </mat-option>
                    </mat-select>
                  </div>
                </label>
                <label>
                  <span>Title</span>
                  <input type="text" [(ngModel)]="assetForm.title" />
                </label>
                <label>
                  <span>Subtitle</span>
                  <input type="text" [(ngModel)]="assetForm.subtitle" />
                </label>
                <label>
                  <span>City</span>
                  <input type="text" [(ngModel)]="assetForm.city" />
                </label>
                <label>
                  <span>Total capacity</span>
                  <input type="number" min="1" step="1" [(ngModel)]="assetForm.capacityTotal" />
                </label>
                <label class="experience-description-field">
                  <span>Details</span>
                  <textarea rows="3" [(ngModel)]="assetForm.details"></textarea>
                </label>
                <label class="experience-description-field">
                  <span>Source link</span>
                  <div class="asset-source-row">
                    <input type="text" [(ngModel)]="assetForm.sourceLink" placeholder="https://..." />
                    <button type="button" class="asset-source-refresh-btn" (click)="refreshAssetFromSourceLink()" aria-label="Refresh from source">
                      <mat-icon>refresh</mat-icon>
                    </button>
                  </div>
                </label>
                <label class="experience-description-field">
                  <span>Image</span>
                  <input #assetImageInput type="file" accept="image/*" hidden (change)="onAssetImageFileChange($event)" />
                  <button type="button" class="asset-image-dropzone" (click)="triggerAssetImageUpload($event)">
                    <div class="asset-image-preview" [style.backgroundImage]="assetForm.imageUrl ? 'url(' + assetForm.imageUrl + ')' : null">
                      <span class="asset-image-plus">+</span>
                    </div>
                  </button>
                </label>
              </div>
              <div class="popup-actions experience-form-actions">
                <button type="button" class="link-btn neutral-btn" (click)="closeAssetForm()">Cancel</button>
                <button type="button" class="link-btn primary-btn" (click)="saveAssetCard()">Save</button>
              </div>
            </section>
          </div>
        </section>

        <section class="experience-delete-confirm" *ngIf="pendingAssetDeleteCardId">
          <div class="experience-delete-confirm-backdrop" (click)="cancelAssetDelete()"></div>
          <div class="experience-delete-confirm-panel">
            <h4>Delete asset</h4>
            <p>{{ pendingAssetDeleteLabel() }}</p>
            <div class="popup-actions">
              <button type="button" class="link-btn neutral-btn" (click)="cancelAssetDelete()">Cancel</button>
              <button type="button" class="link-btn experience-delete-btn" (click)="confirmAssetDelete()">Delete</button>
            </div>
          </div>
        </section>
      </div>

      <div *ngIf="activePopup === 'eventExplore'">
        <div class="editor-list-card">
          <h4>Event Explore Filters</h4>
          <p>Host name, friends-in-common recommendation, distance, calendar and own-event filter.</p>
        </div>
        <div class="editor-list-card">
          <h4>Suggested Events</h4>
          <p>Join request is one click and goes to admin approval.</p>
          <div class="popup-actions">
            <button type="button" class="link-btn">Join Selected Event</button>
            <button type="button" class="link-btn" (click)="openEventEditor()">Create New Event</button>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'eventEditor'">
        <div class="editor-list-card event-main-card">
          <h4>{{ eventEditor.mainEvent.title }}</h4>
          <p>
            Visibility: {{ eventEditor.mainEvent.visibility }} · Mode: {{ eventEditor.mainEvent.mode }} · Frequency:
            {{ eventEditor.mainEvent.frequency }}
          </p>
          <p>Capacity: {{ eventEditor.mainEvent.capacity }} · Ticket: {{ eventEditor.mainEvent.ticket }} · Expense: {{ eventEditor.mainEvent.expense }}</p>
          <p>{{ eventEditor.mainEvent.topics.join(', ') }}</p>
        </div>

        <div class="dynamic-supply-adder">
          <input type="text" [(ngModel)]="newSupplyType" placeholder="Add supply type (for event cards)" />
          <button type="button" class="link-btn" (click)="addSupplyType()">+ Add Type</button>
        </div>

        <div class="event-editor-card" *ngFor="let sub of eventEditor.subEvents">
          <div class="event-editor-head">
            <h4>{{ sub.title }}</h4>
            <p>{{ sub.when }}</p>
            <p>{{ sub.phase }}</p>
          </div>

          <div class="event-supply-buttons">
            <button
              class="supply-chip"
              type="button"
              *ngFor="let type of eventSupplyTypes"
              [class.warn]="isSupplyStatIncomplete(sub, type)"
              (click)="openSupplyDetail(sub.id, sub.title, type)"
            >
              <span class="chip-title">{{ type }}</span>
              <span class="chip-meta">{{ getSupplyStat(sub, type) }}</span>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'supplyDetail' && selectedSupplyContext">
        <div class="editor-list-card">
          <h4>{{ selectedSupplyContext.type }} · {{ selectedSupplyContext.subEventTitle }}</h4>
          <p>Dynamic supply list for this event card.</p>
        </div>
        <div class="editor-list-card" *ngFor="let item of selectedSupplyItems">
          <h4>{{ item.label }}</h4>
          <p>{{ item.detail }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn" (click)="alertService.open('Supply item flow is ready for backend wiring.')">+ Add supply offer</button>
          <button type="button" class="link-btn" (click)="openEventEditor()">Back to Event Editor</button>
        </div>
      </div>

      <div *ngIf="activePopup === 'profileEditor'" class="profile-editor-wrap">
        <div class="profile-identity-card profile-identity-card-large">
          <div class="avatar-stack avatar-stack-editor">
            <span
              class="user-avatar user-avatar-large"
              [ngClass]="['user-color-' + activeUser.gender, featuredImagePreview ? 'has-photo' : '']"
              [style.backgroundImage]="featuredImagePreview ? 'url(' + featuredImagePreview + ')' : null"
            >
              <ng-container *ngIf="!featuredImagePreview">{{ activeUser.initials }}</ng-container>
            </span>
            <button type="button" class="avatar-edit-btn" aria-label="Open image editor" (click)="openImageEditor()">
              <mat-icon>edit</mat-icon>
            </button>
            <span class="avatar-bottom-pill avatar-bottom-pill-header" [class]="profileStatusClass(profileForm.profileStatus)">
              <mat-icon>{{ getProfileStatusIcon(profileForm.profileStatus) }}</mat-icon>
              <span>{{ activeUser.completion }}%</span>
            </span>
          </div>

          <div class="profile-header-text">
            <h3 class="profile-name-line">
              <span>{{ (profileForm.fullName || activeUser.name) + ', ' + profileEditorAge }}</span>
            </h3>
            <span class="profile-city-line">
              <mat-icon>location_on</mat-icon>
              <span>{{ profileForm.city || activeUser.city }}</span>
            </span>
          </div>
        </div>

        <div class="profile-editor-scroll-area">
        <div class="profile-details-structured">
          <label class="profile-about-field profile-status-field">
          <div class="profile-about-head">
            <span>Profile Status</span>
          </div>
          <ng-container *ngIf="!isMobileView; else mobileProfileStatusButton">
            <div class="profile-status-select-wrap selector-like" [class]="profileStatusClass(profileForm.profileStatus)">
              <mat-select [(ngModel)]="profileForm.profileStatus" (ngModelChange)="onProfileStatusChange($event)" disableOptionCentering panelClass="status-options-panel">
                <mat-select-trigger>
                  <span class="status-option-content">
                    <mat-icon [class]="profileStatusClass(profileForm.profileStatus)">{{ getProfileStatusIcon(profileForm.profileStatus) }}</mat-icon>
                    <span>{{ profileForm.profileStatus }}</span>
                  </span>
                </mat-select-trigger>
                <mat-option
                  *ngFor="let option of profileStatusOptions"
                  [value]="option.value"
                  class="status-option"
                  [ngClass]="profileStatusClass(option.value)"
                  [class.hide-selected-option]="option.value === profileForm.profileStatus"
                >
                  <span class="status-option-content">
                    <mat-icon [class]="profileStatusClass(option.value)">{{ option.icon }}</mat-icon>
                    <span>{{ option.value }}</span>
                  </span>
                </mat-option>
              </mat-select>
            </div>
          </ng-container>
          <ng-template #mobileProfileStatusButton>
            <button
              type="button"
              class="profile-status-select-wrap profile-status-trigger"
              [class]="'profile-status-select-wrap profile-status-trigger ' + profileStatusClass(profileForm.profileStatus)"
              (click)="openProfileStatusSelector($event)"
            >
              <span class="status-option-content">
                <mat-icon [class]="profileStatusClass(profileForm.profileStatus)">{{ getProfileStatusIcon(profileForm.profileStatus) }}</mat-icon>
                <span>{{ profileForm.profileStatus }}</span>
              </span>
              <mat-icon>expand_more</mat-icon>
            </button>
          </ng-template>
        </label>
          <label class="profile-about-field">
            <div class="profile-about-head">
              <span>About me</span>
              <small>{{ profileForm.about.length }}/160</small>
            </div>
            <textarea rows="3" maxlength="160" [(ngModel)]="profileForm.about"></textarea>
          </label>
          <section class="profile-details-group" *ngFor="let group of profileDetailsForm; let groupIndex = index">
                  <h4>{{ group.title }}</h4>
                  <div class="profile-form-grid profile-details-form-grid basics-moved-grid" *ngIf="group.title === 'Basics'; else nonBasicsGroup">
                    <label class="name-field">
                      <span>Name</span>
                      <input type="text" [(ngModel)]="profileForm.fullName" />
                    </label>
                    <label class="city-field">
                      <span>City</span>
                      <input type="text" [(ngModel)]="profileForm.city" />
                    </label>
                    <label class="birthday-field">
                      <span>Birthday</span>
                      <div class="date-input-wrap">
                        <input [matDatepicker]="birthdayPicker" [(ngModel)]="profileForm.birthday" (ngModelChange)="onBirthdayChange($event)" />
                        <button type="button" class="date-picker-btn" (click)="birthdayPicker.open()" aria-label="Open birthday picker">
                          <mat-icon>calendar_month</mat-icon>
                        </button>
                        <mat-datepicker #birthdayPicker></mat-datepicker>
                      </div>
                    </label>
                    <label class="horoscope-field">
                      <span>Horoscope</span>
                      <div class="profile-status-select-wrap selector-like readonly-select" [class]="getHoroscopeClass(profileForm.horoscope)">
                        <span class="zodiac-symbol">{{ getHoroscopeSymbol(profileForm.horoscope) }}</span>
                        <span class="zodiac-label">{{ profileForm.horoscope }}</span>
                      </div>
                    </label>
                    <label class="height-field">
                      <span>Height (cm)</span>
                      <input type="number" min="0" step="1" [(ngModel)]="profileForm.heightCm" />
                    </label>
                    <label class="physique-field">
                      <span>Physique</span>
                      <ng-container *ngIf="!isMobileView; else mobilePhysiqueSelectorButton">
                        <div class="profile-status-select-wrap selector-like physique-select-wrap" [class]="getPhysiqueClass(profileForm.physique)">
                          <mat-select [(ngModel)]="profileForm.physique" disableOptionCentering panelClass="selector-options-panel physique-options-panel profile-bottom-sheet-panel">
                            <mat-select-trigger>
                              <span class="status-option-content">
                                <mat-icon [class]="getPhysiqueClass(profileForm.physique)">{{ getPhysiqueIcon(profileForm.physique) }}</mat-icon>
                                <span>{{ profileForm.physique }}</span>
                              </span>
                            </mat-select-trigger>
                            <mat-option
                              *ngFor="let item of physiqueOptions"
                              [value]="item"
                              [class]="'status-option ' + getPhysiqueClass(item)"
                              [class.hide-selected-option]="item === profileForm.physique"
                            >
                              <span class="status-option-content">
                                <mat-icon [class]="getPhysiqueClass(item)">{{ getPhysiqueIcon(item) }}</mat-icon>
                                <span>{{ item }}</span>
                              </span>
                            </mat-option>
                          </mat-select>
                        </div>
                      </ng-container>
                      <ng-template #mobilePhysiqueSelectorButton>
                        <button
                          type="button"
                          class="profile-status-select-wrap selector-like physique-select-wrap"
                          [ngClass]="getPhysiqueClass(profileForm.physique)"
                          (click)="openMobilePhysiqueSelector($event)"
                        >
                          <span class="status-option-content">
                            <mat-icon [class]="getPhysiqueClass(profileForm.physique)">{{ getPhysiqueIcon(profileForm.physique) }}</mat-icon>
                            <span>{{ profileForm.physique }}</span>
                          </span>
                          <mat-icon>expand_more</mat-icon>
                        </button>
                      </ng-template>
                    </label>
                    <label class="languages-field">
                      <span>Languages</span>
                      <ng-container *ngIf="!isMobileView; else mobileLanguageSelectorButton">
                        <div class="language-filter">
                          <button type="button" mat-stroked-button class="language-select-btn" (click)="openMobileLanguageSelector($event)">
                            <span class="label">{{ languageTriggerLabel() }}</span>
                            <mat-icon class="arrow">expand_more</mat-icon>
                          </button>
                        </div>
                      </ng-container>
                      <ng-template #mobileLanguageSelectorButton>
                        <button
                          type="button"
                          class="profile-status-select-wrap selector-like language-mobile-trigger"
                          (click)="openMobileLanguageSelector($event)"
                        >
                          <span class="status-option-content">
                            <mat-icon>language</mat-icon>
                            <span>{{ languageTriggerLabel() || 'Select languages' }}</span>
                          </span>
                          <mat-icon>expand_more</mat-icon>
                        </button>
                      </ng-template>
                    </label>
                  </div>
                  <ng-template #nonBasicsGroup>
                    <div class="profile-form-grid profile-details-form-grid">
                    <div class="profile-details-field" *ngFor="let row of group.rows; let rowIndex = index">
                      <span>{{ row.label }}</span>
                      <div class="profile-details-control-row">
                        <button
                          type="button"
                          class="profile-status-select-wrap selector-like profile-details-values-btn"
                          [ngClass]="row.label === 'Values' ? valuesDominantToneClass(row.value) : interestDominantToneClass(row.value)"
                          *ngIf="row.label === 'Values' || row.label === 'Interest'; else detailsSelect"
                          (click)="row.label === 'Values' ? openValuesSelector(groupIndex, rowIndex) : openInterestSelector(groupIndex, rowIndex)"
                        >
                          <span class="status-option-content">
                            <span>{{ row.label === 'Values' ? valuesRowSummary(row.value) : interestRowSummary(row.value) }}</span>
                          </span>
                          <mat-icon>chevron_right</mat-icon>
                        </button>
                        <ng-template #detailsSelect>
                        <ng-container *ngIf="!isMobileView; else mobileDetailSelectButton">
                          <div class="profile-status-select-wrap selector-like profile-details-select" [ngClass]="detailSelectedClass(row.label, row.value, row.options)">
                            <mat-select [(ngModel)]="row.value" disableOptionCentering panelClass="selector-options-panel profile-bottom-sheet-panel">
                              <mat-select-trigger>
                                <span class="status-option-content">
                                  <mat-icon>{{ detailOptionIcon(row.label, row.value) }}</mat-icon>
                                  <span>{{ row.value }}</span>
                                </span>
                              </mat-select-trigger>
                              <mat-option
                                *ngFor="let item of row.options"
                                [value]="item"
                                class="status-option"
                                [ngClass]="detailOptionClass(row.label, item, row.options)"
                                [class.hide-selected-option]="item === row.value"
                              >
                                <span class="status-option-content">
                                  <mat-icon>{{ detailOptionIcon(row.label, item) }}</mat-icon>
                                  <span>{{ item }}</span>
                                </span>
                              </mat-option>
                            </mat-select>
                          </div>
                        </ng-container>
                        <ng-template #mobileDetailSelectButton>
                          <button
                            type="button"
                            class="profile-status-select-wrap selector-like profile-details-select"
                            [ngClass]="detailSelectedClass(row.label, row.value, row.options)"
                            (click)="openMobileDetailValueSelector(groupIndex, rowIndex, $event)"
                          >
                            <span class="status-option-content">
                              <mat-icon>{{ detailOptionIcon(row.label, row.value) }}</mat-icon>
                              <span>{{ row.value }}</span>
                            </span>
                            <mat-icon>expand_more</mat-icon>
                          </button>
                        </ng-template>
                        </ng-template>
                        <div
                          class="profile-details-privacy-fab"
                        >
                          <button
                            type="button"
                            class="profile-details-privacy-btn profile-details-privacy-trigger"
                            [class]="privacyStatusClass(row.privacy)"
                            (click)="openDetailPrivacySelector(groupIndex, rowIndex, $event)"
                            aria-label="Change visibility"
                          >
                            <mat-icon>{{ privacyStatusIcon(row.privacy) }}</mat-icon>
                          </button>
                        </div>
                      </div>
                    </div>
                    </div>
                  </ng-template>
          </section>
          <section class="profile-details-group experience-selector-card">
            <h4>Experience</h4>
            <div class="experience-selector-grid">
              <div class="experience-selector-row">
                <span>Workspace</span>
                <div class="profile-details-control-row">
                  <button
                    type="button"
                    class="profile-status-select-wrap selector-like profile-details-values-btn section-social"
                    (click)="openWorkspaceSelector()"
                  >
                    <span class="status-option-content">
                      <mat-icon>apartment</mat-icon>
                      <span>{{ workspaceExperienceSummary }}</span>
                    </span>
                    <mat-icon>chevron_right</mat-icon>
                  </button>
                  <div class="profile-details-privacy-fab">
                    <button
                      type="button"
                      class="profile-details-privacy-btn profile-details-privacy-trigger"
                      [class]="privacyStatusClass(experienceVisibilityValue('workspace'))"
                      (click)="openExperiencePrivacySelector('workspace', $event)"
                      aria-label="Change workspace visibility"
                    >
                      <mat-icon>{{ privacyStatusIcon(experienceVisibilityValue('workspace')) }}</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
              <div class="experience-selector-row">
                <span>School</span>
                <div class="profile-details-control-row">
                  <button
                    type="button"
                    class="profile-status-select-wrap selector-like profile-details-values-btn section-arts"
                    (click)="openSchoolSelector()"
                  >
                    <span class="status-option-content">
                      <mat-icon>school</mat-icon>
                      <span>{{ schoolExperienceSummary }}</span>
                    </span>
                    <mat-icon>chevron_right</mat-icon>
                  </button>
                  <div class="profile-details-privacy-fab">
                    <button
                      type="button"
                      class="profile-details-privacy-btn profile-details-privacy-trigger"
                      [class]="privacyStatusClass(experienceVisibilityValue('school'))"
                      (click)="openExperiencePrivacySelector('school', $event)"
                      aria-label="Change school visibility"
                    >
                      <mat-icon>{{ privacyStatusIcon(experienceVisibilityValue('school')) }}</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
        </div>

      </div>

      <div *ngIf="activePopup === 'imageEditor'" class="image-editor-wrap">
        <div class="image-stack-indicators" *ngIf="imageStackSlots.length > 0">
          <button
            type="button"
            class="image-stack-line"
            *ngFor="let slotIndex of imageStackSlots"
            [class.active]="slotIndex === selectedImageIndex"
            (click)="selectImageFromStack(slotIndex)"
            aria-label="Select image"
          ></button>
        </div>
        <div class="image-editor-main" [style.backgroundImage]="selectedImagePreview ? 'url(' + selectedImagePreview + ')' : 'none'">
          <div class="image-stack-hit-area" *ngIf="imageStackSlots.length > 0">
            <button
              type="button"
              class="image-stack-hit-segment"
              *ngFor="let slotIndex of imageStackSlots"
              (click)="selectImageFromStack(slotIndex)"
              aria-label="Select image"
            ></button>
          </div>
          <span *ngIf="!selectedImagePreview">Select a slot to upload image</span>
        </div>
        <p class="image-editor-hint">Click a thumbnail to upload or replace image.</p>
        <input #slotImageInput class="image-file-input-hidden" type="file" accept="image/*" (change)="onSlotImageFileChange($event)" />

        <div class="image-editor-grid">
          <button
            type="button"
            *ngFor="let slot of imageSlots; let i = index"
            [class.slot-selected]="selectedImageIndex === i"
            [class.slot-featured]="i === 0"
            [style.backgroundImage]="slot ? 'url(' + slot + ')' : 'none'"
            (click)="selectImageSlot(i)"
          >
            <span class="slot-index">{{ i + 1 }}</span>
            <span *ngIf="!slot" class="slot-add">+</span>
            <span *ngIf="slot" class="remove-slot" (click)="$event.stopPropagation(); removeImage(i)">×</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="mobile-profile-selector-sheet-wrap" *ngIf="mobileProfileSelectorSheet" (click)="$event.stopPropagation()">
  <div class="mobile-profile-selector-backdrop" (click)="$event.stopPropagation(); closeMobileProfileSelectorSheet()"></div>
  <div
    class="mobile-profile-selector-sheet"
    [class.mobile-profile-selector-sheet-language]="mobileProfileSelectorSheet.context.kind === 'language'"
    (click)="$event.stopPropagation()"
  >
    <div class="mobile-profile-selector-handle" aria-hidden="true"></div>
    <div class="mobile-profile-selector-title">
      <mat-icon>list</mat-icon>
      <span>{{ mobileProfileSelectorSheet.title }}</span>
      <button
        *ngIf="mobileProfileSelectorSheet.context.kind === 'language'"
        type="button"
        class="mobile-profile-selector-close-btn"
        (click)="closeMobileProfileSelectorSheet(); $event.stopPropagation()"
        aria-label="Close language popup"
      >
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="mobile-profile-selector-options" *ngIf="mobileProfileSelectorSheet.context.kind !== 'language'; else mobileLanguageSelectorSheet">
      <button
        type="button"
        class="mobile-profile-selector-option"
        *ngFor="let option of mobileProfileSelectorSheet.options"
        [class.active]="isMobileSelectorOptionActive(option.value)"
        [class.mobile-profile-selector-option-group]="option.disabled"
        [ngClass]="option.toneClass"
        [disabled]="option.disabled"
        (click)="selectMobileProfileSelectorOption(option.value)"
      >
        <span class="mobile-profile-selector-option-main">
          <mat-icon *ngIf="option.icon">{{ option.icon }}</mat-icon>
          <span>{{ option.label }}</span>
        </span>
        <span class="rate-filter-count-badge" *ngIf="!option.disabled && option.badge !== undefined && option.badge > 0">{{ option.badge }}</span>
        <mat-icon *ngIf="!option.disabled && option.badge === undefined && isMobileSelectorOptionActive(option.value)">check</mat-icon>
      </button>
    </div>
    <ng-template #mobileLanguageSelectorSheet>
      <div class="mobile-profile-language-entry" (click)="$event.stopPropagation()">
        <div class="mobile-profile-language-chips" *ngIf="profileForm.languages.length > 0">
          <button
            type="button"
            class="mobile-profile-language-chip"
            [ngClass]="languageToneClass(item)"
            *ngFor="let item of profileForm.languages"
            (click)="removeLanguage(item)"
          >
            <span>{{ item }}</span>
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <label class="mobile-profile-language-input-wrap">
          <input
            type="text"
            [(ngModel)]="languageInput"
            (keydown)="onLanguageInputKeydown($event)"
            (blur)="onLanguageInputBlur()"
            placeholder="Type language"
          />
          <button
            type="button"
            class="mobile-profile-language-submit-btn"
            (click)="submitMobileLanguageAndClose($event)"
            aria-label="Save language search and close"
          >
            <mat-icon>search</mat-icon>
          </button>
        </label>
      </div>
      <div class="mobile-profile-selector-options">
        <button
          type="button"
          class="mobile-profile-selector-option"
          *ngFor="let item of availableLanguageDisplaySuggestions"
          [class.active]="isMobileSelectorOptionActive(item)"
          [ngClass]="languageToneClass(item)"
          (click)="selectMobileProfileSelectorOption(item)"
        >
          <span class="mobile-profile-selector-option-main">
            <mat-icon>language</mat-icon>
            <span>{{ item }}</span>
          </span>
          <mat-icon *ngIf="isMobileSelectorOptionActive(item)">check</mat-icon>
        </button>
      </div>
    </ng-template>
  </div>
</section>

<section
  class="app-popup app-popup-stacked"
  *ngIf="stackedPopup"
>
  <div class="app-popup-backdrop" (click)="closeStackedPopup()"></div>
  <div
    class="app-popup-panel"
    [class.popup-panel-members]="stackedPopup === 'chatMembers' || stackedPopup === 'activityMembers'"
    [class.popup-panel-profile-editor]="stackedPopup === 'experienceSelector'"
    [class.popup-panel-asset-members]="stackedPopup === 'assetMembers'"
    (click)="$event.stopPropagation()"
  >
    <div
      class="popup-header"
      [class.popup-header-selector]="stackedPopup === 'valuesSelector' || stackedPopup === 'interestSelector' || stackedPopup === 'experienceSelector'"
      *ngIf="
        stackedPopup === 'valuesSelector' ||
        stackedPopup === 'interestSelector' ||
        stackedPopup === 'experienceSelector';
        else defaultStackedHeader
      "
    >
      <button
        mat-icon-button
        class="popup-back-btn"
        (click)="showExperienceForm ? closeExperienceForm() : closeStackedPopup()"
        aria-label="Back"
      >
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="popup-title popup-title-values">
        <h2>{{ getStackedPopupTitle() }}</h2>
      </div>
      <button
        *ngIf="stackedPopup === 'experienceSelector'"
        type="button"
        class="popup-header-add-btn"
        (click)="openExperienceForm()"
        aria-label="Add experience"
      >
        <mat-icon>add</mat-icon>
      </button>
      <div
        class="values-header-chips"
        *ngIf="
          (stackedPopup === 'valuesSelector' || stackedPopup === 'interestSelector') &&
          (stackedPopup === 'valuesSelector' ? valuesSelectorSelected : interestSelectorSelected).length > 0
        "
      >
        <button
          type="button"
          class="values-selected-chip"
          [class]="stackedPopup === 'valuesSelector' ? valuesOptionToneClass(item) : interestOptionToneClass(item)"
          *ngFor="let item of (stackedPopup === 'valuesSelector' ? valuesSelectorSelected : interestSelectorSelected)"
          (click)="stackedPopup === 'valuesSelector' ? removeValuesOption(item) : removeInterestOption(item)"
        >
          <span>{{ item }}</span>
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    <ng-template #defaultStackedHeader>
      <div class="popup-header" [class.popup-header-chat]="stackedPopup === 'chat' && selectedChat">
        <div class="popup-title popup-title-chat" *ngIf="stackedPopup === 'chat' && selectedChat; else stackedHeaderDefaultTitle">
          <div class="popup-chat-title-block">
            <h2>{{ selectedChat.title }}</h2>
          </div>
          <button class="chat-members-stack chat-members-stack-large chat-header-members" type="button" (click)="openChatMembers(selectedChat, $event, true)">
            <span class="chat-stack-avatar" *ngFor="let member of getChatVisibleMembers(selectedChat); let i = index" [class]="'user-color-' + member.gender" [style.zIndex]="30 - i">{{ member.initials }}</span>
            <span class="chat-stack-more" *ngIf="getChatHiddenMemberCount(selectedChat) > 0">+{{ getChatHiddenMemberCount(selectedChat) }}</span>
          </button>
        </div>
        <ng-template #stackedHeaderDefaultTitle>
        <div class="popup-title popup-title-members" *ngIf="stackedPopup === 'chatMembers' || stackedPopup === 'activityMembers'; else defaultStackedTitle">
          <div class="popup-chat-title-block">
            <h2>{{ stackedPopup === 'activityMembers' ? 'Members' : 'Chat Members' }}</h2>
            <p>{{ stackedPopup === 'activityMembers' ? (selectedActivityMembersTitle || 'Event') : (selectedChatMembersItem?.title || 'Room') }}</p>
          </div>
        </div>
        <ng-template #defaultStackedTitle>
          <div class="popup-title">
            <h2>{{ getStackedPopupTitle() }}</h2>
          </div>
        </ng-template>
        </ng-template>
        <span class="header-members-count" *ngIf="stackedPopup === 'chatMembers' || stackedPopup === 'activityMembers'">
          {{ stackedPopup === 'activityMembers' ? activityMembersHeaderSummary() : (selectedChatMembers.length + ' members') }}
        </span>
        <button
          type="button"
          class="popup-chat-event-btn"
          aria-label="Open event editor"
          *ngIf="stackedPopup === 'chat' && selectedChat"
          (click)="openEventEditor(true)"
        >
          <mat-icon>edit_calendar</mat-icon>
        </button>
        <button
          type="button"
          class="popup-chat-event-btn popup-invitation-approve-btn"
          aria-label="Approve invitation"
          *ngIf="stackedPopup === 'invitationActions' && selectedInvitation && !selectedInvitationIsAccepted()"
          (click)="approveSelectedInvitation($event)"
        >
          <mat-icon>done</mat-icon>
        </button>
        <button mat-icon-button class="popup-close" (click)="closeStackedPopup()" aria-label="Close">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </ng-template>

    <div
      class="popup-body"
      [class.popup-body-chat]="stackedPopup === 'chat'"
      [class.popup-body-members]="stackedPopup === 'chatMembers' || stackedPopup === 'activityMembers' || stackedPopup === 'assetMembers'"
      [class.popup-body-experience]="stackedPopup === 'experienceSelector'"
      [class.popup-body-impressions]="stackedPopup === 'impressionsHost'"
    >
      <div *ngIf="stackedPopup === 'chat' && selectedChat" class="chat-popup-wrap">
        <div class="chat-popup-box">
          <div class="chat-thread">
            <article class="chat-message" *ngFor="let message of chatPopupMessages" [class.mine]="message.mine">
              <div class="chat-bubble">
                <span class="chat-sender-avatar" [class]="'user-color-' + message.senderAvatar.gender">{{ message.senderAvatar.initials }}</span>
                <div class="chat-message-content">
                  <div class="chat-meta-row">
                    <span class="chat-sender-name">{{ message.sender }}</span>
                    <span class="chat-time-chip">{{ message.time }}</span>
                  </div>
                  <p class="chat-line">{{ message.text }}</p>
                </div>
                <div class="chat-readers" *ngIf="message.readBy.length > 0">
                  <span class="chat-reader" *ngFor="let reader of message.readBy" [class]="'user-color-' + reader.gender">{{ reader.initials }}</span>
                </div>
              </div>
            </article>
          </div>
          <div class="chat-compose-box">
            <textarea rows="3" placeholder="Write message"></textarea>
            <button type="button" class="chat-send-btn" aria-label="Send message">
              <mat-icon>send</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'chatMembers'">
        <div class="chat-members-popup-list">
          <div class="chat-members-popup-row" *ngFor="let member of selectedChatMembers">
            <span class="chat-members-popup-avatar" [class]="'user-color-' + member.gender">{{ member.initials }}</span>
            <div class="chat-members-popup-meta">
              <p class="member-name">{{ member.name }}, {{ member.age }}</p>
              <p class="member-city">{{ member.city }}</p>
              <p class="member-action">{{ chatMemberActionDate(member) }}</p>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'activityMembers'" class="activity-members-popup-wrap">
        <div class="chat-members-popup-list activity-members-popup-list">
          <article class="chat-members-popup-row activity-members-popup-row" [ngClass]="activityMemberStatusClass(member)" *ngFor="let member of activityMembersOrdered">
            <span class="chat-members-popup-avatar" [class]="'user-color-' + member.gender">{{ member.initials }}</span>
            <div class="chat-members-popup-meta">
              <p class="member-name">{{ member.name }}, {{ activityMemberAge(member) }}</p>
              <p class="member-city">{{ member.city }}</p>
              <p class="member-action">{{ activityMemberActionDate(member) }}</p>
            </div>
            <div class="activity-members-side">
              <ng-container *ngIf="canApproveActivityMember(member) || canDeleteActivityMember(member); else activityMemberActionsSpacer">
                <div class="experience-item-actions">
                  <button
                    type="button"
                    class="experience-action-btn asset-accept-btn"
                    *ngIf="canApproveActivityMember(member)"
                    (click)="approveActivityMember(member, $event)"
                    aria-label="Approve invitation"
                  >
                    <mat-icon>check</mat-icon>
                  </button>
                  <button
                    type="button"
                    class="experience-action-btn experience-action-delete"
                    (click)="removeActivityMember(member, $event)"
                    aria-label="Delete invitation"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </ng-container>
              <ng-template #activityMemberActionsSpacer>
                <span class="activity-member-actions-spacer" aria-hidden="true"></span>
              </ng-template>
              <span class="chat-members-inline-badge activity-member-status-badge">{{ activityMemberStatusLabel(member) }}</span>
            </div>
          </article>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'impressionsHost'" class="social-proof-grid">
        <div class="editor-list-card social-proof-card social-proof-card-modern social-proof-card-host">
          <div class="social-proof-identity-pill social-proof-identity-pill-host">
            <mat-icon [class]="getHostTierColorClass(activeHostTier)">{{ getHostTierIcon(activeHostTier) }}</mat-icon>
            <span>{{ activeHostTier }}</span>
          </div>
          <div class="popup-impressions-badge popup-impressions-badge-host">
            <span class="popup-impressions-badge-segment popup-impressions-rate-rate">
              <span class="popup-impressions-badge-label">Rate</span>
              <span class="popup-impressions-badge-value">{{ hostAverageRating }}</span>
            </span>
            <span class="popup-impressions-badge-segment popup-impressions-rate-people">
              <span class="popup-impressions-badge-label">People / Events</span>
              <span class="popup-impressions-badge-value">{{ hostPeopleMet + ' / ' + hostTotalEvents }}</span>
            </span>
            <span class="popup-impressions-badge-segment popup-impressions-rate-return">
              <span class="popup-impressions-badge-label">Returnees / NoShow</span>
              <span class="popup-impressions-badge-value">{{ hostRepeatSummary + ' / ' + hostAttendanceNoShowSummary }}</span>
            </span>
          </div>

          <div class="social-proof-section-block">
            <div class="social-proof-section-head section-vibe">
              <span class="section-tag">Vibe</span>
              <span class="section-line"></span>
            </div>
            <div class="social-proof-chip-list">
              <span class="social-proof-chip chip-vibe" *ngFor="let item of hostVibeBadgeItems">{{ item }}</span>
            </div>
          </div>

          <div class="social-proof-section-block">
            <div class="social-proof-section-head section-category">
              <span class="section-tag">Category</span>
              <span class="section-line"></span>
            </div>
            <div class="social-proof-chip-list">
              <span class="social-proof-chip chip-category" *ngFor="let item of hostCategoryBadgeItems">{{ item }}</span>
            </div>
          </div>
        </div>

        <div class="editor-list-card social-proof-card social-proof-card-modern social-proof-card-member">
          <div class="social-proof-identity-pill social-proof-identity-pill-member">
            <mat-icon [class]="getTraitColorClass(activeMemberTrait)">{{ getTraitIcon(activeMemberTrait) }}</mat-icon>
            <span>{{ memberImpressionTitle }}</span>
          </div>
          <div class="popup-impressions-badge popup-impressions-badge-member">
            <span class="popup-impressions-badge-segment popup-impressions-rate-people">
              <span class="popup-impressions-badge-label">People / Events</span>
              <span class="popup-impressions-badge-value">{{ memberPeopleMet + ' / ' + memberTotalEvents }}</span>
            </span>
            <span class="popup-impressions-badge-segment popup-impressions-rate-return">
              <span class="popup-impressions-badge-label">Returnees / NoShow</span>
              <span class="popup-impressions-badge-value">{{ memberReturneesSummary + ' / ' + memberNoShowCount }}</span>
            </span>
          </div>

          <div class="social-proof-section-block">
            <div class="social-proof-section-head section-personality">
              <span class="section-tag">Personality</span>
              <span class="section-line"></span>
            </div>
            <div class="social-proof-chip-list">
              <span class="social-proof-chip chip-personality" *ngFor="let item of memberPersonalityBadgeItems">{{ item }}</span>
            </div>
          </div>

          <div class="social-proof-section-block">
            <div class="social-proof-section-head section-vibe">
              <span class="section-tag">Vibe</span>
              <span class="section-line"></span>
            </div>
            <div class="social-proof-chip-list">
              <span class="social-proof-chip chip-vibe" *ngFor="let item of memberVibeBadgeItems">{{ item }}</span>
            </div>
          </div>

          <div class="social-proof-section-block">
            <div class="social-proof-section-head section-category">
              <span class="section-tag">Category</span>
              <span class="section-line"></span>
            </div>
            <div class="social-proof-chip-list">
              <span class="social-proof-chip chip-category" *ngFor="let item of memberCategoryBadgeItems">{{ item }}</span>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'assetMembers' && selectedAssetCard" class="assets-member-popup">
        <div class="experience-card-list assets-card-list">
          <article class="experience-item-card asset-member-card" [ngClass]="assetMemberStatusClass(member)" *ngFor="let member of selectedAssetCard.requests">
            <div class="experience-item-head">
              <span class="chat-members-popup-avatar" [class]="'user-color-' + member.gender">{{ member.initials }}</span>
              <div class="experience-item-meta">
                <h4>{{ member.name }}</h4>
                <p>{{ member.note }}</p>
              </div>
              <div class="experience-item-actions">
                <button
                  type="button"
                  class="experience-action-btn asset-accept-btn"
                  *ngIf="member.status === 'pending'"
                  [class.active]="isAssetMemberActionPending(selectedAssetCard.id, member.id, 'accept')"
                  (click)="queueAssetMemberAction(selectedAssetCard.id, member.id, 'accept', $event)"
                >
                  <mat-icon>check</mat-icon>
                </button>
                <button
                  type="button"
                  class="experience-action-btn experience-action-delete"
                  [class.active]="isAssetMemberActionPending(selectedAssetCard.id, member.id, 'remove')"
                  (click)="queueAssetMemberAction(selectedAssetCard.id, member.id, 'remove', $event)"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </article>
        </div>

        <section class="experience-delete-confirm" *ngIf="pendingAssetMemberAction">
          <div class="experience-delete-confirm-backdrop" (click)="cancelAssetMemberAction()"></div>
          <div class="experience-delete-confirm-panel">
            <h4>Confirm member action</h4>
            <p>{{ pendingAssetMemberActionLabel() }}</p>
            <div class="popup-actions">
              <button type="button" class="link-btn neutral-btn" (click)="cancelAssetMemberAction()">Cancel</button>
              <button type="button" class="link-btn primary-btn" (click)="confirmAssetMemberAction()">Confirm</button>
            </div>
          </div>
        </section>
      </div>

      <div *ngIf="stackedPopup === 'invitationActions' && selectedInvitation">
        <div class="editor-list-card">
          <h4>{{ selectedInvitation.description }}</h4>
          <p>{{ getInvitationActionSummary(selectedInvitation) }} · {{ selectedInvitation.when }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn" (click)="deleteSelectedInvitation($event)">Delete</button>
          <button type="button" class="link-btn" (click)="openEventEditor(true)">Open Related Event</button>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'menuEvent' && selectedEvent">
        <div class="editor-list-card">
          <h4>{{ selectedEvent.title }}</h4>
          <p>{{ selectedEvent.shortDescription }}</p>
          <p>{{ selectedEvent.timeframe }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn" (click)="openEventEditor(true)" *ngIf="selectedEvent.isAdmin">Edit Event</button>
          <button type="button" class="link-btn" *ngIf="!selectedEvent.isAdmin">Exit Event</button>
          <button type="button" class="link-btn">Open Event Chat</button>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'hostingEvent' && selectedHostingEvent">
        <div class="editor-list-card">
          <h4>{{ selectedHostingEvent.title }}</h4>
          <p>{{ selectedHostingEvent.shortDescription }}</p>
          <p>{{ selectedHostingEvent.timeframe }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn">Accept Join Requests</button>
          <button type="button" class="link-btn" (click)="openEventEditor(true)">Edit Hosted Event</button>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'eventEditor'">
        <div class="editor-list-card event-main-card">
          <h4>{{ eventEditor.mainEvent.title }}</h4>
          <p>
            Visibility: {{ eventEditor.mainEvent.visibility }} · Mode: {{ eventEditor.mainEvent.mode }} · Frequency:
            {{ eventEditor.mainEvent.frequency }}
          </p>
          <p>Capacity: {{ eventEditor.mainEvent.capacity }} · Ticket: {{ eventEditor.mainEvent.ticket }} · Expense: {{ eventEditor.mainEvent.expense }}</p>
          <p>{{ eventEditor.mainEvent.topics.join(', ') }}</p>
        </div>

        <div class="dynamic-supply-adder">
          <input type="text" [(ngModel)]="newSupplyType" placeholder="Add supply type (for event cards)" />
          <button type="button" class="link-btn" (click)="addSupplyType()">+ Add Type</button>
        </div>

        <div class="event-editor-card" *ngFor="let sub of eventEditor.subEvents">
          <div class="event-editor-head">
            <h4>{{ sub.title }}</h4>
            <p>{{ sub.when }}</p>
            <p>{{ sub.phase }}</p>
          </div>

          <div class="event-supply-buttons">
            <button
              class="supply-chip"
              type="button"
              *ngFor="let type of eventSupplyTypes"
              [class.warn]="isSupplyStatIncomplete(sub, type)"
              (click)="openSupplyDetail(sub.id, sub.title, type)"
            >
              <span class="chip-title">{{ type }}</span>
              <span class="chip-meta">{{ getSupplyStat(sub, type) }}</span>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'supplyDetail' && selectedSupplyContext">
        <div class="editor-list-card">
          <h4>{{ selectedSupplyContext.type }} · {{ selectedSupplyContext.subEventTitle }}</h4>
          <p>Dynamic supply list for this event card.</p>
        </div>
        <div class="editor-list-card" *ngFor="let item of selectedSupplyItems">
          <h4>{{ item.label }}</h4>
          <p>{{ item.detail }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn" (click)="alertService.open('Supply item flow is ready for backend wiring.')">+ Add supply offer</button>
          <button type="button" class="link-btn" (click)="openEventEditor()">Back to Event Editor</button>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'valuesSelector'" class="values-selector-popup">
        <div class="values-selector-group" *ngFor="let group of beliefsValuesOptionGroups">
          <div class="social-proof-section-head" [class]="group.toneClass">
            <span class="section-tag">{{ group.icon }} {{ group.shortTitle }}</span>
            <span class="section-line"></span>
          </div>
          <div class="social-proof-chip-list">
            <button
              type="button"
              class="social-proof-chip values-option-chip"
              [class.active]="isValuesOptionSelected(option)"
              *ngFor="let option of group.options"
              (click)="toggleValuesOption(option)"
            >
              {{ option }}
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'interestSelector'" class="values-selector-popup">
        <div class="values-selector-group" *ngFor="let group of interestOptionGroups">
          <div class="social-proof-section-head" [class]="group.toneClass">
            <span class="section-tag">{{ group.icon }} {{ group.shortTitle }}</span>
            <span class="section-line"></span>
          </div>
          <div class="social-proof-chip-list">
            <button
              type="button"
              class="social-proof-chip values-option-chip"
              [class.active]="isInterestOptionSelected(option)"
              *ngFor="let option of group.options"
              (click)="toggleInterestOption(option)"
            >
              {{ option }}
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'experienceSelector'" class="experience-popup">
        <div class="experience-toolbar">
          <div
            class="profile-status-select-wrap selector-like experience-filter-select"
            [ngClass]="experienceFilterClass(experienceFilter)"
          >
            <mat-select
              [(ngModel)]="experienceFilter"
              disableOptionCentering
              panelClass="selector-options-panel profile-bottom-sheet-panel"
            >
              <mat-select-trigger>
                <span class="status-option-content">
                  <mat-icon [class]="experienceFilterClass(experienceFilter)">{{ experienceFilterIcon(experienceFilter) }}</mat-icon>
                  <span>{{ experienceFilter }}</span>
                </span>
              </mat-select-trigger>
              <mat-option
                *ngFor="let option of experienceFilterOptions"
                [value]="option"
                class="status-option"
                [ngClass]="experienceFilterClass(option)"
              >
                <span class="status-option-content">
                  <mat-icon [class]="experienceFilterClass(option)">{{ experienceFilterIcon(option) }}</mat-icon>
                  <span>{{ option }}</span>
                </span>
              </mat-option>
            </mat-select>
          </div>
        </div>

        <div class="experience-card-list">
          <article class="experience-item-card" [ngClass]="experienceTypeClass(item.type)" *ngFor="let item of filteredExperienceEntries">
            <div class="experience-item-head">
              <span class="experience-item-icon">
                <mat-icon>{{ experienceTypeIcon(item.type) }}</mat-icon>
              </span>
              <div class="experience-item-meta">
                <h4>{{ item.title }}</h4>
                <p>{{ item.org }} · {{ item.city }}</p>
              </div>
              <div class="experience-item-actions">
                <button type="button" class="experience-action-btn experience-action-edit" (click)="openExperienceForm(item)" aria-label="Edit experience">
                  <mat-icon>edit</mat-icon>
                </button>
                <button type="button" class="experience-action-btn experience-action-delete" (click)="requestExperienceDelete(item.id)" aria-label="Delete experience">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
            <p class="experience-item-description">{{ item.description }}</p>
            <p class="experience-item-dates">{{ item.dateFrom }} - {{ item.dateTo }}</p>
          </article>
        </div>

        <section class="experience-delete-confirm" *ngIf="pendingExperienceDeleteId">
          <div class="experience-delete-confirm-backdrop" (click)="cancelExperienceDelete()"></div>
          <div class="experience-delete-confirm-panel">
            <h4>Delete experience?</h4>
            <p>This entry will be removed from your profile.</p>
            <div class="popup-actions">
              <button type="button" class="link-btn neutral-btn" (click)="cancelExperienceDelete()">Cancel</button>
              <button type="button" class="link-btn experience-delete-btn" (click)="confirmExperienceDelete()">Delete</button>
            </div>
          </div>
        </section>

        <section class="experience-form-overlay" *ngIf="showExperienceForm">
          <div class="experience-form-overlay-backdrop" (click)="closeExperienceForm()"></div>
          <div class="experience-form-popup">
            <div class="experience-form-header">
              <h3>{{ editingExperienceId ? 'Edit Experience' : 'Add Experience' }}</h3>
              <button type="button" class="experience-form-close-btn" (click)="closeExperienceForm()" aria-label="Close add experience">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <section class="experience-form-panel">
              <div class="experience-form-grid">
                <label class="experience-type-field">
                  <span>Type</span>
                  <ng-container *ngIf="!isMobileView; else mobileExperienceTypeButton">
                    <div class="profile-status-select-wrap selector-like experience-type-select" [ngClass]="experienceTypeToneClass(experienceForm.type)">
                      <mat-select [(ngModel)]="experienceForm.type" disableOptionCentering panelClass="selector-options-panel profile-bottom-sheet-panel">
                        <mat-select-trigger>
                          <span class="status-option-content">
                            <mat-icon [class]="experienceTypeToneClass(experienceForm.type)">{{ experienceTypeIcon(experienceForm.type) }}</mat-icon>
                            <span>{{ experienceForm.type }}</span>
                          </span>
                        </mat-select-trigger>
                        <mat-option *ngFor="let option of experienceTypeOptions" [value]="option" class="status-option" [ngClass]="experienceTypeToneClass(option)">
                          <span class="status-option-content">
                            <mat-icon [class]="experienceTypeToneClass(option)">{{ experienceTypeIcon(option) }}</mat-icon>
                            <span>{{ option }}</span>
                          </span>
                        </mat-option>
                      </mat-select>
                    </div>
                  </ng-container>
                  <ng-template #mobileExperienceTypeButton>
                    <button
                      type="button"
                      class="profile-status-select-wrap selector-like experience-type-select"
                      [ngClass]="experienceTypeToneClass(experienceForm.type)"
                      (click)="openMobileExperienceTypeSelector($event)"
                    >
                      <span class="status-option-content">
                        <mat-icon [class]="experienceTypeToneClass(experienceForm.type)">{{ experienceTypeIcon(experienceForm.type) }}</mat-icon>
                        <span>{{ experienceForm.type }}</span>
                      </span>
                      <mat-icon>expand_more</mat-icon>
                    </button>
                  </ng-template>
                </label>
                <label class="experience-title-field">
                  <span>Title</span>
                  <input type="text" [(ngModel)]="experienceForm.title" />
                </label>
                <label class="experience-org-field">
                  <span>Organization</span>
                  <input type="text" [(ngModel)]="experienceForm.org" />
                </label>
                <label class="experience-city-field">
                  <span>City</span>
                  <input type="text" [(ngModel)]="experienceForm.city" />
                </label>
                <label class="experience-date-range-label">
                  <span>Date range</span>
                  <mat-form-field appearance="fill" class="experience-date-range-field" subscriptSizing="dynamic">
                    <mat-label>Enter a date range</mat-label>
                    <mat-date-range-input [rangePicker]="experienceDateRangePicker">
                      <input matStartDate [(ngModel)]="experienceRangeStart" name="experienceRangeStart" placeholder="YYYY/MM/DD" />
                      <input matEndDate [(ngModel)]="experienceRangeEnd" name="experienceRangeEnd" placeholder="YYYY/MM/DD" />
                    </mat-date-range-input>
                    <mat-datepicker-toggle matSuffix [for]="experienceDateRangePicker"></mat-datepicker-toggle>
                    <mat-hint>YYYY/MM - YYYY/MM</mat-hint>
                    <mat-date-range-picker #experienceDateRangePicker></mat-date-range-picker>
                  </mat-form-field>
                </label>
                <label class="experience-description-field">
                  <span>Description</span>
                  <textarea rows="4" [(ngModel)]="experienceForm.description"></textarea>
                </label>
              </div>
              <div class="popup-actions experience-form-actions">
                <button type="button" class="link-btn neutral-btn" (click)="closeExperienceForm()">Cancel</button>
                <button type="button" class="link-btn primary-btn" (click)="saveExperienceEntry()">Save</button>
              </div>
            </section>
          </div>
        </section>
      </div>
      <div *ngIf="stackedPopup === 'experienceSelector' && filteredExperienceEntries.length === 0" class="editor-list-card">
        <h4>No entries in this filter</h4>
        <p>Try switching the type dropdown to All.</p>
      </div>
    </div>
    <button
      type="button"
      class="activity-members-add-fab"
      *ngIf="stackedPopup === 'activityMembers'"
      (click)="openActivityInviteFriends($event)"
      aria-label="Invite friends"
    >
      <mat-icon>add</mat-icon>
    </button>
  </div>
</section>

<section class="app-popup app-popup-stacked app-popup-super-stacked" *ngIf="superStackedPopup === 'activityInviteFriends'">
  <div class="app-popup-backdrop" (click)="closeActivityInviteFriends(true)"></div>
  <div class="app-popup-panel popup-panel-friends-picker" (click)="$event.stopPropagation()">
    <div class="popup-header popup-header-friends-picker">
      <div class="popup-title">
        <h2>Invite Friends</h2>
      </div>
      <div class="popup-header-inline-controls">
        <div class="friends-picker-sort">
          <button type="button" class="popup-view-fab" (click)="toggleActivityInviteSortPicker($event)" aria-label="Open invite sort">
            <mat-icon>{{ activityInviteSort === 'recent' ? 'schedule' : 'auto_awesome' }}</mat-icon>
            <span>{{ activityInviteSort === 'recent' ? 'Recent' : 'Relevant' }}</span>
          </button>
          <div class="activities-view-picker-panel" *ngIf="showActivityInviteSortPicker">
            <button type="button" class="activities-view-option" (click)="selectActivityInviteSort('recent')">
              <mat-icon>schedule</mat-icon>
              <span>Recent</span>
            </button>
            <button type="button" class="activities-view-option" (click)="selectActivityInviteSort('relevant')">
              <mat-icon>auto_awesome</mat-icon>
              <span>Relevant</span>
            </button>
          </div>
        </div>
        <button mat-icon-button class="popup-close" (click)="closeActivityInviteFriends(true)" aria-label="Close">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <div class="popup-body popup-body-friends-picker">
      <div class="friends-picker-chip-row" *ngIf="selectedActivityInviteChips.length > 0">
        <button type="button" class="values-selected-chip friends-picker-chip" *ngFor="let chip of selectedActivityInviteChips" (click)="toggleActivityInviteFriend(chip.userId, $event)">
          <span class="friends-picker-chip-avatar" [class]="'user-color-' + chip.gender">{{ chip.initials }}</span>
          <span>{{ chip.name }}</span>
          <mat-icon class="friends-picker-chip-remove">close</mat-icon>
        </button>
      </div>
      <div class="friends-picker-grid">
        <article class="friends-picker-card" *ngFor="let candidate of activityInviteCandidates" [style.backgroundImage]="'url(' + candidate.avatarUrl + ')'">
          <button
            type="button"
            class="friends-picker-card-add-btn"
            [class.active]="isActivityInviteFriendSelected(candidate.userId)"
            (click)="toggleActivityInviteFriend(candidate.userId, $event)"
            aria-label="Select friend"
          >
            <mat-icon>{{ isActivityInviteFriendSelected(candidate.userId) ? 'check' : 'add' }}</mat-icon>
          </button>
          <div class="friends-picker-card-meta">
            <h4>{{ candidate.name }}</h4>
            <p>{{ activityInviteMetLabel(candidate) }}</p>
          </div>
        </article>
      </div>
    </div>
  </div>
</section>

<section class="logout-confirm" *ngIf="activePopup === 'logoutConfirm'">
  <div class="logout-confirm-backdrop" (click)="closePopup()"></div>
  <div class="logout-confirm-panel" (click)="$event.stopPropagation()">
    <h3>Biztosan kilép?</h3>
    <p>{{ activeUser.name }}</p>
    <div class="logout-confirm-actions">
      <button mat-stroked-button type="button" (click)="closePopup()">Mégsem</button>
      <button mat-raised-button color="warn" class="logout-btn" type="button" (click)="confirmLogout()">Kilépés</button>
    </div>
  </div>
</section>

<section class="demo-login-overlay" *ngIf="showUserSelector">
  <div class="demo-login-panel" (click)="$event.stopPropagation()">
    <h2>Select demo user</h2>
    <p>Login disabled mode. Choose one of the 12 users to open perspective-based data.</p>
    <div class="demo-user-grid">
      <button type="button" class="demo-user-item" *ngFor="let user of users" (click)="selectLoginUser(user.id)">
        <span class="user-avatar" [class]="'user-color-' + user.gender">{{ user.initials }}</span>
        <span class="demo-user-name">{{ user.name }}</span>
        <span class="demo-user-meta">{{ user.gender }} · {{ user.city }}</span>
      </button>
    </div>
  </div>
</section>

<section class="alert-popup" *ngIf="alertService.message() as message">
  <div class="alert-popup-backdrop" (click)="alertService.close()"></div>
  <div class="alert-popup-panel" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <div class="popup-title">
        <h2>Értesítés</h2>
      </div>
      <button mat-icon-button class="popup-close" (click)="alertService.close()" aria-label="Bezárás">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="popup-body">
      <p>{{ message }}</p>
    </div>
    <div class="alert-actions">
      <button mat-stroked-button type="button" (click)="alertService.close()">Rendben</button>
    </div>
  </div>
</section>
