<main class="main">
  <div class="content content-single">
    <button mat-icon-button class="user-selector-btn-global" [class.is-hidden]="showUserMenu" (click)="onUserSelect()" aria-label="Open user menu">
      <span
        class="user-initial"
        [ngClass]="['user-color-' + activeUser.gender, featuredImagePreview ? 'has-photo' : '']"
        [style.backgroundImage]="featuredImagePreview ? 'url(' + featuredImagePreview + ')' : null"
      >
        <ng-container *ngIf="!featuredImagePreview">{{ activeUser.initials }}</ng-container>
      </span>
      <span class="badge-dot" *ngIf="userBadgeCount > 0">{{ userBadgeCount }}</span>
    </button>

    <div class="user-menu-backdrop" [class.open]="showUserMenu" (click)="closeUserMenu()" *ngIf="showUserMenu"></div>

    <aside class="user-menu-panel" [class.open]="showUserMenu">
      <div
        class="user-menu-header"
        role="button"
        tabindex="0"
        (click)="onHeaderPanelClick($event)"
        (keydown.enter)="openProfileEditor()"
        (keydown.space)="openProfileEditor(); $event.preventDefault()"
      >
        <button
          type="button"
          class="user-menu-close-btn"
          aria-label="Close menu"
          (click)="$event.stopPropagation(); closeUserMenu()"
        >
          <mat-icon>close</mat-icon>
        </button>

        <div class="user-header-main">
          <div class="avatar-stack">
            <span
              class="user-avatar user-avatar-large"
              [ngClass]="['user-color-' + activeUser.gender, featuredImagePreview ? 'has-photo' : '']"
              [style.backgroundImage]="featuredImagePreview ? 'url(' + featuredImagePreview + ')' : null"
            >
              <ng-container *ngIf="!featuredImagePreview">{{ activeUser.initials }}</ng-container>
            </span>
            <span class="avatar-activity-badge" *ngIf="userBadgeCount > 0">{{ userBadgeCount }}</span>
            <span class="avatar-bottom-pill avatar-bottom-pill-header" [class]="profileStatusClass(activeUser.profileStatus)">
              <mat-icon>{{ getProfileStatusIcon(activeUser.profileStatus) }}</mat-icon>
              <span>{{ activeUser.completion }}%</span>
            </span>
          </div>

          <div class="user-meta user-meta-compact">
            <span class="user-name">{{ activeUser.name }}, {{ activeUser.age }}</span>
            <span class="user-city-line">
              <mat-icon>location_on</mat-icon>
              <span>{{ activeUser.city }}</span>
            </span>
          </div>
        </div>
        <span class="header-open-cue" aria-hidden="true">
          <mat-icon>edit</mat-icon>
        </span>
      </div>

      <div class="user-menu-content">
        <div class="social-proof-section-head section-personality activities-header impressions-menu-header">
          <span class="section-tag">
            <mat-icon>psychology</mat-icon>
            <span>Impressions</span>
          </span>
          <span class="section-line"></span>
        </div>

        <div class="impressions-shortcuts">
          <button
            class="impression-shortcut-btn impression-shortcut-host"
            type="button"
            (click)="openHostImpressions()"
            aria-label="Open host impressions"
            [title]="activeHostTier"
          >
            <mat-icon [class]="getHostTierColorClass(activeHostTier)">{{ getHostTierIcon(activeHostTier) }}</mat-icon>
            <span class="impression-shortcut-label">{{ activeHostTier }}</span>
          </button>

          <button
            class="impression-shortcut-btn impression-shortcut-member"
            type="button"
            (click)="openMemberImpressions()"
            aria-label="Open member impressions"
            [title]="memberImpressionTitle"
          >
            <mat-icon [class]="getTraitColorClass(activeMemberTrait)">{{ getTraitIcon(activeMemberTrait) }}</mat-icon>
            <span class="impression-shortcut-label">{{ memberImpressionTitle }}</span>
          </button>
        </div>

        <div class="social-proof-section-head section-social activities-header">
          <span class="section-tag">
            <mat-icon>local_activity</mat-icon>
            <span>Activities</span>
          </span>
          <span class="section-line"></span>
        </div>

        <div class="menu-shortcuts">
          <button
            class="menu-shortcut-btn menu-shortcut-game"
            type="button"
            (click)="goToGame()"
            aria-label="Open game"
            title="Game"
          >
            <mat-icon>interests</mat-icon>
            <span class="menu-shortcut-label">Game</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="gameBadge > 0">{{ gameBadge }}</span>
          </button>

          <button
            class="menu-shortcut-btn menu-shortcut-chat"
            type="button"
            (click)="openChatShortcut()"
            aria-label="Open chat"
            title="Chat"
          >
            <mat-icon>chat</mat-icon>
            <span class="menu-shortcut-label">Chat</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="chatBadge > 0">{{ chatBadge }}</span>
          </button>

          <button
            class="menu-shortcut-btn menu-shortcut-invitations"
            type="button"
            (click)="openInvitationShortcut()"
            aria-label="Open invitations"
            title="Invitations"
          >
            <mat-icon>mail</mat-icon>
            <span class="menu-shortcut-label">Invitations</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="invitationsBadge > 0">{{ invitationsBadge }}</span>
          </button>

          <button
            class="menu-shortcut-btn menu-shortcut-events"
            type="button"
            (click)="openEventShortcut()"
            aria-label="Open events"
            title="Events"
          >
            <mat-icon>event</mat-icon>
            <span class="menu-shortcut-label">Events</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="eventsBadge > 0">{{ eventsBadge }}</span>
          </button>

          <button
            class="menu-shortcut-btn menu-shortcut-hosting"
            type="button"
            (click)="openHostingShortcut()"
            aria-label="Open hosting"
            title="Hosting"
          >
            <mat-icon>stadium</mat-icon>
            <span class="menu-shortcut-label">Hosting</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="hostingBadge > 0">{{ hostingBadge }}</span>
          </button>
        </div>

        <div class="social-proof-section-head section-arts activities-header impressions-menu-header">
          <span class="section-tag">
            <mat-icon>inventory_2</mat-icon>
            <span>Assets</span>
          </span>
          <span class="section-line"></span>
        </div>

        <div class="assets-shortcuts">
          <button class="asset-shortcut-btn asset-shortcut-car" type="button" (click)="openAssetCarPopup()" aria-label="Car">
            <mat-icon>directions_car</mat-icon>
            <span class="asset-shortcut-label">Car</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="assetCarsBadge > 0">{{ assetCarsBadge }}</span>
          </button>
          <button
            class="asset-shortcut-btn asset-shortcut-accommodation"
            type="button"
            (click)="openAssetAccommodationPopup()"
            aria-label="Accommodation"
          >
            <mat-icon>apartment</mat-icon>
            <span class="asset-shortcut-label">Accommodation</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="assetAccommodationBadge > 0">{{ assetAccommodationBadge }}</span>
          </button>
          <button class="asset-shortcut-btn asset-shortcut-supplies" type="button" (click)="openAssetSuppliesPopup()" aria-label="Supplies">
            <mat-icon>inventory_2</mat-icon>
            <span class="asset-shortcut-label">Supplies</span>
            <span class="card-badge menu-shortcut-badge" *ngIf="assetSuppliesBadge > 0">{{ assetSuppliesBadge }}</span>
          </button>
        </div>
      </div>
    </aside>

    <section class="content-area content-area-full">
      <router-outlet></router-outlet>
    </section>
  </div>
</main>

<section class="app-popup" *ngIf="activePopup && activePopup !== 'logoutConfirm'">
  <div class="app-popup-backdrop" (click)="closePopup()"></div>
  <div
    class="app-popup-panel"
    [class.popup-panel-members]="activePopup === 'chatMembers'"
    [class.popup-panel-image-editor]="activePopup === 'imageEditor'"
    [class.popup-panel-profile-editor]="activePopup === 'profileEditor'"
    (click)="$event.stopPropagation()"
  >
    <div class="popup-header" [class.popup-header-chat]="activePopup === 'chat' && selectedChat">
      <div class="popup-title popup-title-chat" *ngIf="activePopup === 'chat' && selectedChat; else defaultPopupTitle">
        <div class="popup-chat-title-block">
          <h2>{{ selectedChat.title }}</h2>
        </div>
        <button class="chat-members-stack chat-members-stack-large chat-header-members" type="button" (click)="openChatMembers(selectedChat, $event, true)">
          <span class="chat-stack-avatar" *ngFor="let member of getChatVisibleMembers(selectedChat); let i = index" [class]="'user-color-' + member.gender" [style.zIndex]="30 - i">{{ member.initials }}</span>
          <span class="chat-stack-more" *ngIf="getChatHiddenMemberCount(selectedChat) > 0">+{{ getChatHiddenMemberCount(selectedChat) }}</span>
        </button>
      </div>
      <ng-template #defaultPopupTitle>
        <div class="popup-title popup-title-members" *ngIf="activePopup === 'chatMembers'; else defaultPlainTitle">
          <div class="popup-chat-title-block">
            <h2>Chat Members</h2>
            <p>{{ selectedChatMembersItem?.title || 'Room' }}</p>
          </div>
        </div>
        <ng-template #defaultPlainTitle>
          <div class="popup-title popup-title-impressions" *ngIf="activePopup === 'impressionsHost' || activePopup === 'impressionsMember'; else plainPopupTitle">
            <div class="popup-chat-title-block">
              <h2>Impressions</h2>
              <p class="popup-impression-subline">
                <mat-icon [class]="activePopup === 'impressionsHost' ? getHostTierColorClass(activeHostTier) : getTraitColorClass(activeMemberTrait)">
                  {{ activePopup === 'impressionsHost' ? getHostTierIcon(activeHostTier) : getTraitIcon(activeMemberTrait) }}
                </mat-icon>
                <span>{{ activePopup === 'impressionsHost' ? activeHostTier : memberImpressionTitle }}</span>
              </p>
            </div>
          </div>
          <ng-template #plainPopupTitle>
            <div class="popup-title">
              <h2>{{ getPopupTitle() }}</h2>
            </div>
          </ng-template>
        </ng-template>
      </ng-template>
      <span class="header-members-count" *ngIf="activePopup === 'chatMembers'">{{ selectedChatMembers.length }} members</span>
      <button
        type="button"
        class="popup-chat-event-btn"
        aria-label="Open event editor"
        *ngIf="activePopup === 'chat' && selectedChat"
        (click)="openEventEditor(true)"
      >
        <mat-icon>edit_calendar</mat-icon>
      </button>
      <button mat-icon-button class="popup-close" (click)="closePopup()" aria-label="Close">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div
      class="popup-body"
      [class.popup-body-chat]="activePopup === 'chat' && selectedChat"
      [class.popup-body-members]="activePopup === 'chatMembers'"
      [class.popup-body-impressions]="activePopup === 'impressionsHost' || activePopup === 'impressionsMember'"
      [class.popup-body-image-editor]="activePopup === 'imageEditor'"
    >
      <div *ngIf="activePopup === 'chat' && selectedChat" class="chat-popup-wrap">
        <div class="chat-popup-box">
          <div class="chat-thread">
            <article class="chat-message" *ngFor="let message of chatPopupMessages" [class.mine]="message.mine">
              <div class="chat-bubble">
                <span class="chat-sender-avatar" [class]="'user-color-' + message.senderAvatar.gender">{{ message.senderAvatar.initials }}</span>
                <div class="chat-message-content">
                  <div class="chat-meta-row">
                    <span class="chat-sender-name">{{ message.sender }}</span>
                    <span class="chat-time-chip">{{ message.time }}</span>
                  </div>
                  <p class="chat-line">{{ message.text }}</p>
                </div>
                <div class="chat-readers" *ngIf="message.readBy.length > 0">
                  <span class="chat-reader" *ngFor="let reader of message.readBy" [class]="'user-color-' + reader.gender">{{ reader.initials }}</span>
                </div>
              </div>
            </article>
          </div>
          <div class="chat-compose-box">
            <textarea rows="3" placeholder="Write message"></textarea>
            <button type="button" class="chat-send-btn" aria-label="Send message">
              <mat-icon>send</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'chatMembers'">
        <div class="chat-members-popup-list">
          <div class="chat-members-popup-row" *ngFor="let member of selectedChatMembers">
            <span class="chat-members-popup-avatar" [class]="'user-color-' + member.gender">{{ member.initials }}</span>
            <div class="chat-members-popup-meta">
              <p>{{ member.name }}</p>
              <p>{{ member.city }} · {{ member.statusText }}</p>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'invitationActions' && selectedInvitation">
        <div class="editor-list-card">
          <h4>{{ selectedInvitation.description }}</h4>
          <p>{{ getInvitationActionSummary(selectedInvitation) }} · {{ selectedInvitation.when }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn">Accept</button>
          <button type="button" class="link-btn">Delete</button>
          <button type="button" class="link-btn" (click)="openEventEditor()">Open Related Event</button>
        </div>
      </div>

      <div *ngIf="activePopup === 'menuEvent' && selectedEvent">
        <div class="editor-list-card">
          <h4>{{ selectedEvent.title }}</h4>
          <p>{{ selectedEvent.shortDescription }}</p>
          <p>{{ selectedEvent.timeframe }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn" (click)="openEventEditor()" *ngIf="selectedEvent.isAdmin">Edit Event</button>
          <button type="button" class="link-btn" *ngIf="!selectedEvent.isAdmin">Exit Event</button>
          <button type="button" class="link-btn">Open Event Chat</button>
        </div>
      </div>

      <div *ngIf="activePopup === 'hostingEvent' && selectedHostingEvent">
        <div class="editor-list-card">
          <h4>{{ selectedHostingEvent.title }}</h4>
          <p>{{ selectedHostingEvent.shortDescription }}</p>
          <p>{{ selectedHostingEvent.timeframe }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn">Accept Join Requests</button>
          <button type="button" class="link-btn" (click)="openEventEditor()">Edit Hosted Event</button>
        </div>
      </div>

      <div *ngIf="activePopup === 'impressionsHost'">
        <div class="social-proof-grid">
          <div class="editor-list-card social-proof-card social-proof-card-modern social-proof-card-host">
            <div class="popup-impressions-badge popup-impressions-badge-host">
              <span class="popup-impressions-badge-segment popup-impressions-rate-rate">
                <span class="popup-impressions-badge-label">Rate</span>
                <span class="popup-impressions-badge-value">{{ hostAverageRating }}</span>
              </span>
              <span class="popup-impressions-badge-segment popup-impressions-rate-people">
                <span class="popup-impressions-badge-label">People / Events</span>
                <span class="popup-impressions-badge-value">{{ hostPeopleMet + ' / ' + hostTotalEvents }}</span>
              </span>
              <span class="popup-impressions-badge-segment popup-impressions-rate-return">
                <span class="popup-impressions-badge-label">Returnees / NoShow</span>
                <span class="popup-impressions-badge-value">{{ hostRepeatSummary + ' / ' + hostAttendanceNoShowSummary }}</span>
              </span>
            </div>

            <div class="social-proof-section-block">
              <div class="social-proof-section-head section-vibe">
                <span class="section-tag">Vibe</span>
                <span class="section-line"></span>
              </div>
              <div class="social-proof-chip-list">
                <span class="social-proof-chip chip-vibe" *ngFor="let item of hostVibeBadgeItems">{{ item }}</span>
              </div>
            </div>

            <div class="social-proof-section-block">
              <div class="social-proof-section-head section-category">
                <span class="section-tag">Category</span>
                <span class="section-line"></span>
              </div>
              <div class="social-proof-chip-list">
                <span class="social-proof-chip chip-category" *ngFor="let item of hostCategoryBadgeItems">{{ item }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'impressionsMember'">
        <div class="social-proof-grid">
          <div class="editor-list-card social-proof-card social-proof-card-modern social-proof-card-member">
            <div class="popup-impressions-badge popup-impressions-badge-member">
              <span class="popup-impressions-badge-segment popup-impressions-rate-people">
                <span class="popup-impressions-badge-label">People / Events</span>
                <span class="popup-impressions-badge-value">{{ memberPeopleMet + ' / ' + memberTotalEvents }}</span>
              </span>
              <span class="popup-impressions-badge-segment popup-impressions-rate-return">
                <span class="popup-impressions-badge-label">Returnees / NoShow</span>
                <span class="popup-impressions-badge-value">{{ memberReturneesSummary + ' / ' + memberNoShowCount }}</span>
              </span>
            </div>

            <div class="social-proof-section-block">
              <div class="social-proof-section-head section-personality">
                <span class="section-tag">Personality</span>
                <span class="section-line"></span>
              </div>
              <div class="social-proof-chip-list">
                <span class="social-proof-chip chip-personality" *ngFor="let item of memberPersonalityBadgeItems">{{ item }}</span>
              </div>
            </div>

            <div class="social-proof-section-block">
              <div class="social-proof-section-head section-vibe">
                <span class="section-tag">Vibe</span>
                <span class="section-line"></span>
              </div>
              <div class="social-proof-chip-list">
                <span class="social-proof-chip chip-vibe" *ngFor="let item of memberVibeBadgeItems">{{ item }}</span>
              </div>
            </div>

            <div class="social-proof-section-block">
              <div class="social-proof-section-head section-category">
                <span class="section-tag">Category</span>
                <span class="section-line"></span>
              </div>
              <div class="social-proof-chip-list">
                <span class="social-proof-chip chip-category" *ngFor="let item of memberCategoryBadgeItems">{{ item }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'assetsCar'">
        <div class="editor-list-card">
          <h4>Cars for active trips</h4>
          <p>Seat coverage and transport offers from your current event roster.</p>
        </div>
        <div class="editor-list-card" *ngFor="let item of assetCarItems">
          <h4>{{ item.label }}</h4>
          <p>{{ item.detail }}</p>
        </div>
      </div>

      <div *ngIf="activePopup === 'assetsAccommodation'">
        <div class="editor-list-card">
          <h4>Accommodation capacity</h4>
          <p>Rooms and people coverage from current hosting plans.</p>
        </div>
        <div class="editor-list-card" *ngFor="let item of assetAccommodationItems">
          <h4>{{ item.label }}</h4>
          <p>{{ item.detail }}</p>
        </div>
      </div>

      <div *ngIf="activePopup === 'assetsSupplies'">
        <div class="editor-list-card">
          <h4>Supply checklist</h4>
          <p>Required vs offered accessories for active events.</p>
        </div>
        <div class="editor-list-card" *ngFor="let item of assetSuppliesItems">
          <h4>{{ item.label }}</h4>
          <p>{{ item.detail }}</p>
        </div>
      </div>

      <div *ngIf="activePopup === 'eventExplore'">
        <div class="editor-list-card">
          <h4>Event Explore Filters</h4>
          <p>Host name, friends-in-common recommendation, distance, calendar and own-event filter.</p>
        </div>
        <div class="editor-list-card">
          <h4>Suggested Events</h4>
          <p>Join request is one click and goes to admin approval.</p>
          <div class="popup-actions">
            <button type="button" class="link-btn">Join Selected Event</button>
            <button type="button" class="link-btn" (click)="openEventEditor()">Create New Event</button>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'eventEditor'">
        <div class="editor-list-card event-main-card">
          <h4>{{ eventEditor.mainEvent.title }}</h4>
          <p>
            Visibility: {{ eventEditor.mainEvent.visibility }} · Mode: {{ eventEditor.mainEvent.mode }} · Frequency:
            {{ eventEditor.mainEvent.frequency }}
          </p>
          <p>Capacity: {{ eventEditor.mainEvent.capacity }} · Ticket: {{ eventEditor.mainEvent.ticket }} · Expense: {{ eventEditor.mainEvent.expense }}</p>
          <p>{{ eventEditor.mainEvent.topics.join(', ') }}</p>
        </div>

        <div class="dynamic-supply-adder">
          <input type="text" [(ngModel)]="newSupplyType" placeholder="Add supply type (for event cards)" />
          <button type="button" class="link-btn" (click)="addSupplyType()">+ Add Type</button>
        </div>

        <div class="event-editor-card" *ngFor="let sub of eventEditor.subEvents">
          <div class="event-editor-head">
            <h4>{{ sub.title }}</h4>
            <p>{{ sub.when }}</p>
            <p>{{ sub.phase }}</p>
          </div>

          <div class="event-supply-buttons">
            <button
              class="supply-chip"
              type="button"
              *ngFor="let type of eventSupplyTypes"
              [class.warn]="isSupplyStatIncomplete(sub, type)"
              (click)="openSupplyDetail(sub.id, sub.title, type)"
            >
              <span class="chip-title">{{ type }}</span>
              <span class="chip-meta">{{ getSupplyStat(sub, type) }}</span>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="activePopup === 'supplyDetail' && selectedSupplyContext">
        <div class="editor-list-card">
          <h4>{{ selectedSupplyContext.type }} · {{ selectedSupplyContext.subEventTitle }}</h4>
          <p>Dynamic supply list for this event card.</p>
        </div>
        <div class="editor-list-card" *ngFor="let item of selectedSupplyItems">
          <h4>{{ item.label }}</h4>
          <p>{{ item.detail }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn" (click)="alertService.open('Supply item flow is ready for backend wiring.')">+ Add supply offer</button>
          <button type="button" class="link-btn" (click)="openEventEditor()">Back to Event Editor</button>
        </div>
      </div>

      <div *ngIf="activePopup === 'profileEditor'" class="profile-editor-wrap">
        <div class="profile-identity-card profile-identity-card-large">
          <div class="avatar-stack avatar-stack-editor">
            <span
              class="user-avatar user-avatar-large"
              [ngClass]="['user-color-' + activeUser.gender, featuredImagePreview ? 'has-photo' : '']"
              [style.backgroundImage]="featuredImagePreview ? 'url(' + featuredImagePreview + ')' : null"
            >
              <ng-container *ngIf="!featuredImagePreview">{{ activeUser.initials }}</ng-container>
            </span>
            <button type="button" class="avatar-edit-btn" aria-label="Open image editor" (click)="openImageEditor()">
              <mat-icon>edit</mat-icon>
            </button>
            <span class="avatar-bottom-pill avatar-bottom-pill-header" [class]="profileStatusClass(profileForm.profileStatus)">
              <mat-icon>{{ getProfileStatusIcon(profileForm.profileStatus) }}</mat-icon>
              <span>{{ activeUser.completion }}%</span>
            </span>
          </div>

          <div class="profile-header-text">
            <h3 class="profile-name-line">
              <span>{{ (profileForm.fullName || activeUser.name) + ', ' + profileEditorAge }}</span>
            </h3>
            <span class="profile-city-line">
              <mat-icon>location_on</mat-icon>
              <span>{{ profileForm.city || activeUser.city }}</span>
            </span>
          </div>
        </div>

        <div class="profile-editor-scroll-area">
        <div class="profile-details-structured">
          <label class="profile-about-field profile-status-field">
          <div class="profile-about-head">
            <span>Profile Status</span>
          </div>
          <ng-container *ngIf="!isMobileView; else mobileProfileStatusButton">
            <div class="profile-status-select-wrap selector-like" [class]="profileStatusClass(profileForm.profileStatus)">
              <mat-select [(ngModel)]="profileForm.profileStatus" (ngModelChange)="onProfileStatusChange($event)" disableOptionCentering panelClass="status-options-panel">
                <mat-select-trigger>
                  <span class="status-option-content">
                    <mat-icon [class]="profileStatusClass(profileForm.profileStatus)">{{ getProfileStatusIcon(profileForm.profileStatus) }}</mat-icon>
                    <span>{{ profileForm.profileStatus }}</span>
                  </span>
                </mat-select-trigger>
                <mat-option
                  *ngFor="let option of profileStatusOptions"
                  [value]="option.value"
                  class="status-option"
                  [ngClass]="profileStatusClass(option.value)"
                  [class.hide-selected-option]="option.value === profileForm.profileStatus"
                >
                  <span class="status-option-content">
                    <mat-icon [class]="profileStatusClass(option.value)">{{ option.icon }}</mat-icon>
                    <span>{{ option.value }}</span>
                  </span>
                </mat-option>
              </mat-select>
            </div>
          </ng-container>
          <ng-template #mobileProfileStatusButton>
            <button
              type="button"
              class="profile-status-select-wrap profile-status-trigger"
              [class]="'profile-status-select-wrap profile-status-trigger ' + profileStatusClass(profileForm.profileStatus)"
              (click)="openProfileStatusSelector($event)"
            >
              <span class="status-option-content">
                <mat-icon [class]="profileStatusClass(profileForm.profileStatus)">{{ getProfileStatusIcon(profileForm.profileStatus) }}</mat-icon>
                <span>{{ profileForm.profileStatus }}</span>
              </span>
              <mat-icon>expand_more</mat-icon>
            </button>
          </ng-template>
        </label>
          <label class="profile-about-field">
            <div class="profile-about-head">
              <span>About me</span>
              <small>{{ profileForm.about.length }}/160</small>
            </div>
            <textarea rows="3" maxlength="160" [(ngModel)]="profileForm.about"></textarea>
          </label>
          <section class="profile-details-group" *ngFor="let group of profileDetailsForm; let groupIndex = index">
                  <h4>{{ group.title }}</h4>
                  <div class="profile-form-grid profile-details-form-grid basics-moved-grid" *ngIf="group.title === 'Basics'; else nonBasicsGroup">
                    <label class="name-field">
                      <span>Name</span>
                      <input type="text" [(ngModel)]="profileForm.fullName" />
                    </label>
                    <label class="city-field">
                      <span>City</span>
                      <input type="text" [(ngModel)]="profileForm.city" />
                    </label>
                    <label class="birthday-field">
                      <span>Birthday</span>
                      <div class="date-input-wrap">
                        <input [matDatepicker]="birthdayPicker" [(ngModel)]="profileForm.birthday" (ngModelChange)="onBirthdayChange($event)" />
                        <button type="button" class="date-picker-btn" (click)="birthdayPicker.open()" aria-label="Open birthday picker">
                          <mat-icon>calendar_month</mat-icon>
                        </button>
                        <mat-datepicker #birthdayPicker></mat-datepicker>
                      </div>
                    </label>
                    <label class="horoscope-field">
                      <span>Horoscope</span>
                      <div class="profile-status-select-wrap selector-like readonly-select" [class]="getHoroscopeClass(profileForm.horoscope)">
                        <span class="zodiac-symbol">{{ getHoroscopeSymbol(profileForm.horoscope) }}</span>
                        <span class="zodiac-label">{{ profileForm.horoscope }}</span>
                      </div>
                    </label>
                    <label class="height-field">
                      <span>Height (cm)</span>
                      <input type="number" min="0" step="1" [(ngModel)]="profileForm.heightCm" />
                    </label>
                    <label class="physique-field">
                      <span>Physique</span>
                      <ng-container *ngIf="!isMobileView; else mobilePhysiqueSelectorButton">
                        <div class="profile-status-select-wrap selector-like physique-select-wrap" [class]="getPhysiqueClass(profileForm.physique)">
                          <mat-select [(ngModel)]="profileForm.physique" disableOptionCentering panelClass="selector-options-panel physique-options-panel profile-bottom-sheet-panel">
                            <mat-select-trigger>
                              <span class="status-option-content">
                                <mat-icon [class]="getPhysiqueClass(profileForm.physique)">{{ getPhysiqueIcon(profileForm.physique) }}</mat-icon>
                                <span>{{ profileForm.physique }}</span>
                              </span>
                            </mat-select-trigger>
                            <mat-option
                              *ngFor="let item of physiqueOptions"
                              [value]="item"
                              [class]="'status-option ' + getPhysiqueClass(item)"
                              [class.hide-selected-option]="item === profileForm.physique"
                            >
                              <span class="status-option-content">
                                <mat-icon [class]="getPhysiqueClass(item)">{{ getPhysiqueIcon(item) }}</mat-icon>
                                <span>{{ item }}</span>
                              </span>
                            </mat-option>
                          </mat-select>
                        </div>
                      </ng-container>
                      <ng-template #mobilePhysiqueSelectorButton>
                        <button
                          type="button"
                          class="profile-status-select-wrap selector-like physique-select-wrap"
                          [ngClass]="getPhysiqueClass(profileForm.physique)"
                          (click)="openMobilePhysiqueSelector($event)"
                        >
                          <span class="status-option-content">
                            <mat-icon [class]="getPhysiqueClass(profileForm.physique)">{{ getPhysiqueIcon(profileForm.physique) }}</mat-icon>
                            <span>{{ profileForm.physique }}</span>
                          </span>
                          <mat-icon>expand_more</mat-icon>
                        </button>
                      </ng-template>
                    </label>
                    <label class="languages-field">
                      <span>Languages</span>
                      <ng-container *ngIf="!isMobileView; else mobileLanguageSelectorButton">
                        <div class="language-filter">
                          <button type="button" mat-stroked-button class="language-select-btn" (click)="openMobileLanguageSelector($event)">
                            <span class="label">{{ languageTriggerLabel() }}</span>
                            <mat-icon class="arrow">expand_more</mat-icon>
                          </button>
                        </div>
                      </ng-container>
                      <ng-template #mobileLanguageSelectorButton>
                        <button
                          type="button"
                          class="profile-status-select-wrap selector-like language-mobile-trigger"
                          (click)="openMobileLanguageSelector($event)"
                        >
                          <span class="status-option-content">
                            <mat-icon>language</mat-icon>
                            <span>{{ languageTriggerLabel() || 'Select languages' }}</span>
                          </span>
                          <mat-icon>expand_more</mat-icon>
                        </button>
                      </ng-template>
                    </label>
                  </div>
                  <ng-template #nonBasicsGroup>
                    <div class="profile-form-grid profile-details-form-grid">
                    <div class="profile-details-field" *ngFor="let row of group.rows; let rowIndex = index">
                      <span>{{ row.label }}</span>
                      <div class="profile-details-control-row">
                        <button
                          type="button"
                          class="profile-status-select-wrap selector-like profile-details-values-btn"
                          [ngClass]="row.label === 'Values' ? valuesDominantToneClass(row.value) : interestDominantToneClass(row.value)"
                          *ngIf="row.label === 'Values' || row.label === 'Interest'; else detailsSelect"
                          (click)="row.label === 'Values' ? openValuesSelector(groupIndex, rowIndex) : openInterestSelector(groupIndex, rowIndex)"
                        >
                          <span class="status-option-content">
                            <span>{{ row.label === 'Values' ? valuesRowSummary(row.value) : interestRowSummary(row.value) }}</span>
                          </span>
                          <mat-icon>chevron_right</mat-icon>
                        </button>
                        <ng-template #detailsSelect>
                        <ng-container *ngIf="!isMobileView; else mobileDetailSelectButton">
                          <div class="profile-status-select-wrap selector-like profile-details-select" [ngClass]="detailSelectedClass(row.label, row.value, row.options)">
                            <mat-select [(ngModel)]="row.value" disableOptionCentering panelClass="selector-options-panel profile-bottom-sheet-panel">
                              <mat-select-trigger>
                                <span class="status-option-content">
                                  <mat-icon>{{ detailOptionIcon(row.label, row.value) }}</mat-icon>
                                  <span>{{ row.value }}</span>
                                </span>
                              </mat-select-trigger>
                              <mat-option
                                *ngFor="let item of row.options"
                                [value]="item"
                                class="status-option"
                                [ngClass]="detailOptionClass(row.label, item, row.options)"
                                [class.hide-selected-option]="item === row.value"
                              >
                                <span class="status-option-content">
                                  <mat-icon>{{ detailOptionIcon(row.label, item) }}</mat-icon>
                                  <span>{{ item }}</span>
                                </span>
                              </mat-option>
                            </mat-select>
                          </div>
                        </ng-container>
                        <ng-template #mobileDetailSelectButton>
                          <button
                            type="button"
                            class="profile-status-select-wrap selector-like profile-details-select"
                            [ngClass]="detailSelectedClass(row.label, row.value, row.options)"
                            (click)="openMobileDetailValueSelector(groupIndex, rowIndex, $event)"
                          >
                            <span class="status-option-content">
                              <mat-icon>{{ detailOptionIcon(row.label, row.value) }}</mat-icon>
                              <span>{{ row.value }}</span>
                            </span>
                            <mat-icon>expand_more</mat-icon>
                          </button>
                        </ng-template>
                        </ng-template>
                        <div
                          class="profile-details-privacy-fab"
                        >
                          <button
                            type="button"
                            class="profile-details-privacy-btn profile-details-privacy-trigger"
                            [class]="privacyStatusClass(row.privacy)"
                            (click)="openDetailPrivacySelector(groupIndex, rowIndex, $event)"
                            aria-label="Change visibility"
                          >
                            <mat-icon>{{ privacyStatusIcon(row.privacy) }}</mat-icon>
                          </button>
                        </div>
                      </div>
                    </div>
                    </div>
                  </ng-template>
          </section>
          <section class="profile-details-group experience-selector-card">
            <h4>Experience</h4>
            <div class="experience-selector-grid">
              <div class="experience-selector-row">
                <span>Workspace</span>
                <div class="profile-details-control-row">
                  <button
                    type="button"
                    class="profile-status-select-wrap selector-like profile-details-values-btn section-social"
                    (click)="openWorkspaceSelector()"
                  >
                    <span class="status-option-content">
                      <mat-icon>apartment</mat-icon>
                      <span>{{ workspaceExperienceSummary }}</span>
                    </span>
                    <mat-icon>chevron_right</mat-icon>
                  </button>
                  <div class="profile-details-privacy-fab">
                    <button
                      type="button"
                      class="profile-details-privacy-btn profile-details-privacy-trigger"
                      [class]="privacyStatusClass(experienceVisibilityValue('workspace'))"
                      (click)="openExperiencePrivacySelector('workspace', $event)"
                      aria-label="Change workspace visibility"
                    >
                      <mat-icon>{{ privacyStatusIcon(experienceVisibilityValue('workspace')) }}</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
              <div class="experience-selector-row">
                <span>School</span>
                <div class="profile-details-control-row">
                  <button
                    type="button"
                    class="profile-status-select-wrap selector-like profile-details-values-btn section-arts"
                    (click)="openSchoolSelector()"
                  >
                    <span class="status-option-content">
                      <mat-icon>school</mat-icon>
                      <span>{{ schoolExperienceSummary }}</span>
                    </span>
                    <mat-icon>chevron_right</mat-icon>
                  </button>
                  <div class="profile-details-privacy-fab">
                    <button
                      type="button"
                      class="profile-details-privacy-btn profile-details-privacy-trigger"
                      [class]="privacyStatusClass(experienceVisibilityValue('school'))"
                      (click)="openExperiencePrivacySelector('school', $event)"
                      aria-label="Change school visibility"
                    >
                      <mat-icon>{{ privacyStatusIcon(experienceVisibilityValue('school')) }}</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
        </div>

      </div>

      <div *ngIf="activePopup === 'imageEditor'" class="image-editor-wrap">
        <div class="image-stack-indicators" *ngIf="imageStackSlots.length > 0">
          <button
            type="button"
            class="image-stack-line"
            *ngFor="let slotIndex of imageStackSlots"
            [class.active]="slotIndex === selectedImageIndex"
            (click)="selectImageFromStack(slotIndex)"
            aria-label="Select image"
          ></button>
        </div>
        <div class="image-editor-main" [style.backgroundImage]="selectedImagePreview ? 'url(' + selectedImagePreview + ')' : 'none'">
          <div class="image-stack-hit-area" *ngIf="imageStackSlots.length > 0">
            <button
              type="button"
              class="image-stack-hit-segment"
              *ngFor="let slotIndex of imageStackSlots"
              (click)="selectImageFromStack(slotIndex)"
              aria-label="Select image"
            ></button>
          </div>
          <span *ngIf="!selectedImagePreview">Select a slot to upload image</span>
        </div>
        <p class="image-editor-hint">Click a thumbnail to upload or replace image.</p>
        <input #slotImageInput class="image-file-input-hidden" type="file" accept="image/*" (change)="onSlotImageFileChange($event)" />

        <div class="image-editor-grid">
          <button
            type="button"
            *ngFor="let slot of imageSlots; let i = index"
            [class.slot-selected]="selectedImageIndex === i"
            [class.slot-featured]="i === 0"
            [style.backgroundImage]="slot ? 'url(' + slot + ')' : 'none'"
            (click)="selectImageSlot(i)"
          >
            <span class="slot-index">{{ i + 1 }}</span>
            <span *ngIf="!slot" class="slot-add">+</span>
            <span *ngIf="slot" class="remove-slot" (click)="$event.stopPropagation(); removeImage(i)">×</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="mobile-profile-selector-sheet-wrap" *ngIf="mobileProfileSelectorSheet">
  <div class="mobile-profile-selector-backdrop" (click)="closeMobileProfileSelectorSheet()"></div>
  <div
    class="mobile-profile-selector-sheet"
    [class.mobile-profile-selector-sheet-language]="mobileProfileSelectorSheet.context.kind === 'language'"
    (click)="$event.stopPropagation()"
  >
    <div class="mobile-profile-selector-handle" aria-hidden="true"></div>
    <div class="mobile-profile-selector-title">
      <mat-icon>list</mat-icon>
      <span>{{ mobileProfileSelectorSheet.title }}</span>
    </div>
    <div class="mobile-profile-selector-options" *ngIf="mobileProfileSelectorSheet.context.kind !== 'language'; else mobileLanguageSelectorSheet">
      <button
        type="button"
        class="mobile-profile-selector-option"
        *ngFor="let option of mobileProfileSelectorSheet.options"
        [class.active]="isMobileSelectorOptionActive(option.value)"
        [ngClass]="option.toneClass"
        (click)="selectMobileProfileSelectorOption(option.value)"
      >
        <span class="mobile-profile-selector-option-main">
          <mat-icon>{{ option.icon }}</mat-icon>
          <span>{{ option.label }}</span>
        </span>
        <mat-icon *ngIf="isMobileSelectorOptionActive(option.value)">check</mat-icon>
      </button>
    </div>
    <ng-template #mobileLanguageSelectorSheet>
      <div class="mobile-profile-language-entry" (click)="$event.stopPropagation()">
        <div class="mobile-profile-language-chips" *ngIf="profileForm.languages.length > 0">
          <button
            type="button"
            class="mobile-profile-language-chip"
            [ngClass]="languageToneClass(item)"
            *ngFor="let item of profileForm.languages"
            (click)="removeLanguage(item)"
          >
            <span>{{ item }}</span>
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <label class="mobile-profile-language-input-wrap">
          <input
            type="text"
            [(ngModel)]="languageInput"
            (keydown)="onLanguageInputKeydown($event)"
            (blur)="onLanguageInputBlur()"
            placeholder="Type language"
          />
          <button
            type="button"
            class="mobile-profile-language-submit-btn"
            (click)="submitMobileLanguageAndClose($event)"
            aria-label="Save language search and close"
          >
            <mat-icon>search</mat-icon>
          </button>
        </label>
      </div>
      <div class="mobile-profile-selector-options">
        <button
          type="button"
          class="mobile-profile-selector-option"
          *ngFor="let item of availableLanguageDisplaySuggestions"
          [class.active]="isMobileSelectorOptionActive(item)"
          [ngClass]="languageToneClass(item)"
          (click)="selectMobileProfileSelectorOption(item)"
        >
          <span class="mobile-profile-selector-option-main">
            <mat-icon>language</mat-icon>
            <span>{{ item }}</span>
          </span>
          <mat-icon *ngIf="isMobileSelectorOptionActive(item)">check</mat-icon>
        </button>
      </div>
    </ng-template>
  </div>
</section>

<section
  class="app-popup app-popup-stacked"
  *ngIf="stackedPopup"
>
  <div class="app-popup-backdrop" (click)="closeStackedPopup()"></div>
  <div
    class="app-popup-panel"
    [class.popup-panel-members]="stackedPopup === 'chatMembers'"
    [class.popup-panel-profile-editor]="stackedPopup === 'experienceSelector'"
    (click)="$event.stopPropagation()"
  >
    <div
      class="popup-header"
      [class.popup-header-selector]="stackedPopup === 'valuesSelector' || stackedPopup === 'interestSelector' || stackedPopup === 'experienceSelector'"
      *ngIf="
        stackedPopup === 'valuesSelector' ||
        stackedPopup === 'interestSelector' ||
        stackedPopup === 'experienceSelector';
        else defaultStackedHeader
      "
    >
      <button
        mat-icon-button
        class="popup-back-btn"
        (click)="showExperienceForm ? closeExperienceForm() : closeStackedPopup()"
        aria-label="Back"
      >
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="popup-title popup-title-values">
        <h2>{{ getStackedPopupTitle() }}</h2>
      </div>
      <button
        *ngIf="stackedPopup === 'experienceSelector'"
        type="button"
        class="popup-header-add-btn"
        (click)="openExperienceForm()"
        aria-label="Add experience"
      >
        <mat-icon>add</mat-icon>
      </button>
      <div
        class="values-header-chips"
        *ngIf="
          (stackedPopup === 'valuesSelector' || stackedPopup === 'interestSelector') &&
          (stackedPopup === 'valuesSelector' ? valuesSelectorSelected : interestSelectorSelected).length > 0
        "
      >
        <button
          type="button"
          class="values-selected-chip"
          [class]="stackedPopup === 'valuesSelector' ? valuesOptionToneClass(item) : interestOptionToneClass(item)"
          *ngFor="let item of (stackedPopup === 'valuesSelector' ? valuesSelectorSelected : interestSelectorSelected)"
          (click)="stackedPopup === 'valuesSelector' ? removeValuesOption(item) : removeInterestOption(item)"
        >
          <span>{{ item }}</span>
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    <ng-template #defaultStackedHeader>
      <div class="popup-header">
        <div class="popup-title popup-title-members" *ngIf="stackedPopup === 'chatMembers'; else defaultStackedTitle">
          <div class="popup-chat-title-block">
            <h2>Chat Members</h2>
            <p>{{ selectedChatMembersItem?.title || 'Room' }}</p>
          </div>
        </div>
        <ng-template #defaultStackedTitle>
          <div class="popup-title">
            <h2>{{ getStackedPopupTitle() }}</h2>
          </div>
        </ng-template>
        <span class="header-members-count" *ngIf="stackedPopup === 'chatMembers'">{{ selectedChatMembers.length }} members</span>
        <button mat-icon-button class="popup-close" (click)="closeStackedPopup()" aria-label="Close">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </ng-template>

    <div class="popup-body" [class.popup-body-members]="stackedPopup === 'chatMembers'" [class.popup-body-experience]="stackedPopup === 'experienceSelector'">
      <div *ngIf="stackedPopup === 'chatMembers'">
        <div class="chat-members-popup-list">
          <div class="chat-members-popup-row" *ngFor="let member of selectedChatMembers">
            <span class="chat-members-popup-avatar" [class]="'user-color-' + member.gender">{{ member.initials }}</span>
            <div class="chat-members-popup-meta">
              <p>{{ member.name }}</p>
              <p>{{ member.city }} · {{ member.statusText }}</p>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'eventEditor'">
        <div class="editor-list-card event-main-card">
          <h4>{{ eventEditor.mainEvent.title }}</h4>
          <p>
            Visibility: {{ eventEditor.mainEvent.visibility }} · Mode: {{ eventEditor.mainEvent.mode }} · Frequency:
            {{ eventEditor.mainEvent.frequency }}
          </p>
          <p>Capacity: {{ eventEditor.mainEvent.capacity }} · Ticket: {{ eventEditor.mainEvent.ticket }} · Expense: {{ eventEditor.mainEvent.expense }}</p>
          <p>{{ eventEditor.mainEvent.topics.join(', ') }}</p>
        </div>

        <div class="dynamic-supply-adder">
          <input type="text" [(ngModel)]="newSupplyType" placeholder="Add supply type (for event cards)" />
          <button type="button" class="link-btn" (click)="addSupplyType()">+ Add Type</button>
        </div>

        <div class="event-editor-card" *ngFor="let sub of eventEditor.subEvents">
          <div class="event-editor-head">
            <h4>{{ sub.title }}</h4>
            <p>{{ sub.when }}</p>
            <p>{{ sub.phase }}</p>
          </div>

          <div class="event-supply-buttons">
            <button
              class="supply-chip"
              type="button"
              *ngFor="let type of eventSupplyTypes"
              [class.warn]="isSupplyStatIncomplete(sub, type)"
              (click)="openSupplyDetail(sub.id, sub.title, type)"
            >
              <span class="chip-title">{{ type }}</span>
              <span class="chip-meta">{{ getSupplyStat(sub, type) }}</span>
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'supplyDetail' && selectedSupplyContext">
        <div class="editor-list-card">
          <h4>{{ selectedSupplyContext.type }} · {{ selectedSupplyContext.subEventTitle }}</h4>
          <p>Dynamic supply list for this event card.</p>
        </div>
        <div class="editor-list-card" *ngFor="let item of selectedSupplyItems">
          <h4>{{ item.label }}</h4>
          <p>{{ item.detail }}</p>
        </div>
        <div class="popup-actions">
          <button type="button" class="link-btn" (click)="alertService.open('Supply item flow is ready for backend wiring.')">+ Add supply offer</button>
          <button type="button" class="link-btn" (click)="openEventEditor()">Back to Event Editor</button>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'valuesSelector'" class="values-selector-popup">
        <div class="values-selector-group" *ngFor="let group of beliefsValuesOptionGroups">
          <div class="social-proof-section-head" [class]="group.toneClass">
            <span class="section-tag">{{ group.icon }} {{ group.shortTitle }}</span>
            <span class="section-line"></span>
          </div>
          <div class="social-proof-chip-list">
            <button
              type="button"
              class="social-proof-chip values-option-chip"
              [class.active]="isValuesOptionSelected(option)"
              *ngFor="let option of group.options"
              (click)="toggleValuesOption(option)"
            >
              {{ option }}
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'interestSelector'" class="values-selector-popup">
        <div class="values-selector-group" *ngFor="let group of interestOptionGroups">
          <div class="social-proof-section-head" [class]="group.toneClass">
            <span class="section-tag">{{ group.icon }} {{ group.shortTitle }}</span>
            <span class="section-line"></span>
          </div>
          <div class="social-proof-chip-list">
            <button
              type="button"
              class="social-proof-chip values-option-chip"
              [class.active]="isInterestOptionSelected(option)"
              *ngFor="let option of group.options"
              (click)="toggleInterestOption(option)"
            >
              {{ option }}
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="stackedPopup === 'experienceSelector'" class="experience-popup">
        <div class="experience-toolbar">
          <div
            class="profile-status-select-wrap selector-like experience-filter-select"
            [ngClass]="experienceFilterClass(experienceFilter)"
          >
            <mat-select
              [(ngModel)]="experienceFilter"
              disableOptionCentering
              panelClass="selector-options-panel profile-bottom-sheet-panel"
            >
              <mat-select-trigger>
                <span class="status-option-content">
                  <mat-icon [class]="experienceFilterClass(experienceFilter)">{{ experienceFilterIcon(experienceFilter) }}</mat-icon>
                  <span>{{ experienceFilter }}</span>
                </span>
              </mat-select-trigger>
              <mat-option
                *ngFor="let option of experienceFilterOptions"
                [value]="option"
                class="status-option"
                [ngClass]="experienceFilterClass(option)"
              >
                <span class="status-option-content">
                  <mat-icon [class]="experienceFilterClass(option)">{{ experienceFilterIcon(option) }}</mat-icon>
                  <span>{{ option }}</span>
                </span>
              </mat-option>
            </mat-select>
          </div>
        </div>

        <div class="experience-card-list">
          <article class="experience-item-card" [ngClass]="experienceTypeClass(item.type)" *ngFor="let item of filteredExperienceEntries">
            <div class="experience-item-head">
              <span class="experience-item-icon">
                <mat-icon>{{ experienceTypeIcon(item.type) }}</mat-icon>
              </span>
              <div class="experience-item-meta">
                <h4>{{ item.title }}</h4>
                <p>{{ item.org }} · {{ item.city }}</p>
              </div>
              <div class="experience-item-actions">
                <button type="button" class="experience-action-btn experience-action-edit" (click)="openExperienceForm(item)" aria-label="Edit experience">
                  <mat-icon>edit</mat-icon>
                </button>
                <button type="button" class="experience-action-btn experience-action-delete" (click)="requestExperienceDelete(item.id)" aria-label="Delete experience">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
            <p class="experience-item-description">{{ item.description }}</p>
            <p class="experience-item-dates">{{ item.dateFrom }} - {{ item.dateTo }}</p>
          </article>
        </div>

        <section class="experience-delete-confirm" *ngIf="pendingExperienceDeleteId">
          <div class="experience-delete-confirm-backdrop" (click)="cancelExperienceDelete()"></div>
          <div class="experience-delete-confirm-panel">
            <h4>Delete experience?</h4>
            <p>This entry will be removed from your profile.</p>
            <div class="popup-actions">
              <button type="button" class="link-btn neutral-btn" (click)="cancelExperienceDelete()">Cancel</button>
              <button type="button" class="link-btn experience-delete-btn" (click)="confirmExperienceDelete()">Delete</button>
            </div>
          </div>
        </section>

        <section class="experience-form-overlay" *ngIf="showExperienceForm">
          <div class="experience-form-overlay-backdrop" (click)="closeExperienceForm()"></div>
          <div class="experience-form-popup">
            <div class="experience-form-header">
              <h3>{{ editingExperienceId ? 'Edit Experience' : 'Add Experience' }}</h3>
              <button type="button" class="experience-form-close-btn" (click)="closeExperienceForm()" aria-label="Close add experience">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <section class="experience-form-panel">
              <div class="experience-form-grid">
                <label class="experience-type-field">
                  <span>Type</span>
                  <ng-container *ngIf="!isMobileView; else mobileExperienceTypeButton">
                    <div class="profile-status-select-wrap selector-like experience-type-select" [ngClass]="experienceTypeToneClass(experienceForm.type)">
                      <mat-select [(ngModel)]="experienceForm.type" disableOptionCentering panelClass="selector-options-panel profile-bottom-sheet-panel">
                        <mat-select-trigger>
                          <span class="status-option-content">
                            <mat-icon [class]="experienceTypeToneClass(experienceForm.type)">{{ experienceTypeIcon(experienceForm.type) }}</mat-icon>
                            <span>{{ experienceForm.type }}</span>
                          </span>
                        </mat-select-trigger>
                        <mat-option *ngFor="let option of experienceTypeOptions" [value]="option" class="status-option" [ngClass]="experienceTypeToneClass(option)">
                          <span class="status-option-content">
                            <mat-icon [class]="experienceTypeToneClass(option)">{{ experienceTypeIcon(option) }}</mat-icon>
                            <span>{{ option }}</span>
                          </span>
                        </mat-option>
                      </mat-select>
                    </div>
                  </ng-container>
                  <ng-template #mobileExperienceTypeButton>
                    <button
                      type="button"
                      class="profile-status-select-wrap selector-like experience-type-select"
                      [ngClass]="experienceTypeToneClass(experienceForm.type)"
                      (click)="openMobileExperienceTypeSelector($event)"
                    >
                      <span class="status-option-content">
                        <mat-icon [class]="experienceTypeToneClass(experienceForm.type)">{{ experienceTypeIcon(experienceForm.type) }}</mat-icon>
                        <span>{{ experienceForm.type }}</span>
                      </span>
                      <mat-icon>expand_more</mat-icon>
                    </button>
                  </ng-template>
                </label>
                <label class="experience-title-field">
                  <span>Title</span>
                  <input type="text" [(ngModel)]="experienceForm.title" />
                </label>
                <label class="experience-org-field">
                  <span>Organization</span>
                  <input type="text" [(ngModel)]="experienceForm.org" />
                </label>
                <label class="experience-city-field">
                  <span>City</span>
                  <input type="text" [(ngModel)]="experienceForm.city" />
                </label>
                <label class="experience-date-range-label">
                  <span>Date range</span>
                  <mat-form-field appearance="fill" class="experience-date-range-field" subscriptSizing="dynamic">
                    <mat-label>Enter a date range</mat-label>
                    <mat-date-range-input [rangePicker]="experienceDateRangePicker">
                      <input matStartDate [(ngModel)]="experienceRangeStart" name="experienceRangeStart" placeholder="YYYY/MM/DD" />
                      <input matEndDate [(ngModel)]="experienceRangeEnd" name="experienceRangeEnd" placeholder="YYYY/MM/DD" />
                    </mat-date-range-input>
                    <mat-datepicker-toggle matSuffix [for]="experienceDateRangePicker"></mat-datepicker-toggle>
                    <mat-hint>YYYY/MM - YYYY/MM</mat-hint>
                    <mat-date-range-picker #experienceDateRangePicker></mat-date-range-picker>
                  </mat-form-field>
                </label>
                <label class="experience-description-field">
                  <span>Description</span>
                  <textarea rows="4" [(ngModel)]="experienceForm.description"></textarea>
                </label>
              </div>
              <div class="popup-actions experience-form-actions">
                <button type="button" class="link-btn neutral-btn" (click)="closeExperienceForm()">Cancel</button>
                <button type="button" class="link-btn primary-btn" (click)="saveExperienceEntry()">Save</button>
              </div>
            </section>
          </div>
        </section>
      </div>
      <div *ngIf="stackedPopup === 'experienceSelector' && filteredExperienceEntries.length === 0" class="editor-list-card">
        <h4>No entries in this filter</h4>
        <p>Try switching the type dropdown to All.</p>
      </div>
    </div>
  </div>
</section>

<section class="logout-confirm" *ngIf="activePopup === 'logoutConfirm'">
  <div class="logout-confirm-backdrop" (click)="closePopup()"></div>
  <div class="logout-confirm-panel" (click)="$event.stopPropagation()">
    <h3>Biztosan kilép?</h3>
    <p>{{ activeUser.name }}</p>
    <div class="logout-confirm-actions">
      <button mat-stroked-button type="button" (click)="closePopup()">Mégsem</button>
      <button mat-raised-button color="warn" class="logout-btn" type="button" (click)="confirmLogout()">Kilépés</button>
    </div>
  </div>
</section>

<section class="demo-login-overlay" *ngIf="showUserSelector">
  <div class="demo-login-panel" (click)="$event.stopPropagation()">
    <h2>Select demo user</h2>
    <p>Login disabled mode. Choose one of the 12 users to open perspective-based data.</p>
    <div class="demo-user-grid">
      <button type="button" class="demo-user-item" *ngFor="let user of users" (click)="selectLoginUser(user.id)">
        <span class="user-avatar" [class]="'user-color-' + user.gender">{{ user.initials }}</span>
        <span class="demo-user-name">{{ user.name }}</span>
        <span class="demo-user-meta">{{ user.gender }} · {{ user.city }}</span>
      </button>
    </div>
  </div>
</section>

<section class="alert-popup" *ngIf="alertService.message() as message">
  <div class="alert-popup-backdrop" (click)="alertService.close()"></div>
  <div class="alert-popup-panel" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <div class="popup-title">
        <h2>Értesítés</h2>
      </div>
      <button mat-icon-button class="popup-close" (click)="alertService.close()" aria-label="Bezárás">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="popup-body">
      <p>{{ message }}</p>
    </div>
    <div class="alert-actions">
      <button mat-stroked-button type="button" (click)="alertService.close()">Rendben</button>
    </div>
  </div>
</section>
